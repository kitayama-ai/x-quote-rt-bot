rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ============================
    // ヘルパー関数
    // ============================
    // ログインユーザーの account_access ドキュメントを取得
    function getAccess() {
      return get(/databases/$(database)/documents/account_access/$(request.auth.token.email));
    }

    // docId が自分の data_uid と一致するか
    function hasAccess(docId) {
      return request.auth != null && getAccess().data.data_uid == docId;
    }

    // docId に対して指定ロールを持つか
    function hasRole(docId, roles) {
      let access = getAccess();
      return request.auth != null
        && access.data.data_uid == docId
        && access.data.role in roles;
    }

    // ============================
    // Users collection (Google Auth ユーザープロフィール)
    // ============================
    match /users/{userId} {
      // 自分のプロフィールは読み書き可
      allow read: if request.auth != null && request.auth.uid == userId;
      allow create, update: if request.auth != null && request.auth.uid == userId;
      allow delete: if false;

      // Queue Decisions — dataUid 配下のサブコレクション
      match /queue_decisions/{tweetId} {
        allow read: if hasAccess(userId);
        allow create, update: if hasRole(userId, ['admin', 'operator']);
        allow delete: if false; // Admin SDK のみ
      }

      // Operation Requests — dataUid 配下のサブコレクション
      match /operation_requests/{opId} {
        allow read: if hasAccess(userId);
        allow create: if hasRole(userId, ['admin', 'operator']);
        allow update: if hasRole(userId, ['admin', 'operator'])
                      && request.resource.data.status == 'cancelled';
        allow delete: if false;
      }
    }

    // ============================
    // API Keys — admin のみ書き込み可
    // ============================
    match /api_keys/{docId} {
      allow read: if hasAccess(docId);
      allow write: if hasRole(docId, ['admin']);
      allow delete: if false;
    }

    // ============================
    // Dashboard Data — 読み取りのみ（書き込みは Admin SDK）
    // ============================
    match /dashboard_data/{docId} {
      allow read: if hasAccess(docId);
      allow write: if false;
    }

    // ============================
    // Persona Profiles — 読み取りのみ（書き込みは Admin SDK）
    // ============================
    match /persona_profiles/{docId} {
      allow read: if hasAccess(docId);
      allow write: if false;
    }

    // ============================
    // Selection Preferences — operator 以上が書き込み可
    // ============================
    match /selection_preferences/{docId} {
      allow read: if hasAccess(docId);
      allow create, update: if hasRole(docId, ['admin', 'operator']);
      allow delete: if false;
    }

    // ============================
    // X Accounts — メンバー一覧管理
    // ============================
    match /x_accounts/{accountId} {
      // メンバーのみ読み取り可
      allow read: if request.auth != null
        && request.auth.token.email in resource.data.allowed_emails;
      // admin のみ更新可（作成は Admin SDK / セットアップスクリプト）
      allow update: if request.auth != null
        && resource.data.member_roles[request.auth.token.email] == 'admin';
      allow create, delete: if false;
    }

    // ============================
    // Account Access — メール→アカウント対応
    // ============================
    match /account_access/{email} {
      // 自分のアクセス情報のみ読み取り可
      allow read: if request.auth != null && request.auth.token.email == email;
      // admin のみ他人のアクセスを管理可
      allow create, update, delete: if request.auth != null
        && getAccess().data.role == 'admin';
    }

    // デフォルト: 全て拒否
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
