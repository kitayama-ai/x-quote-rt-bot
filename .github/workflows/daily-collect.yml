name: Daily Collect (バズツイート自動収集)

# 毎朝 6:00 JST (21:00 UTC) にSocialData APIでバズツイートを収集
# → 6:30 の daily-curate で引用RTコメント生成
on:
  schedule:
    - cron: '0 21 * * *'  # 6:00 JST
  workflow_dispatch:  # 手動実行可能
    inputs:
      dry_run:
        description: 'ドライラン（キューに追加しない）'
        type: boolean
        default: false
      auto_approve:
        description: '自動承認'
        type: boolean
        default: true
      min_likes:
        description: '最低いいね数'
        type: number
        default: 500

jobs:
  collect:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Pull latest
        run: git pull origin main || true

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Collect buzz tweets
        env:
          SOCIALDATA_API_KEY: ${{ secrets.SOCIALDATA_API_KEY }}
          DISCORD_WEBHOOK_GENERAL: ${{ secrets.DISCORD_WEBHOOK_GENERAL }}
          DISCORD_WEBHOOK_ACCOUNT_1: ${{ secrets.DISCORD_WEBHOOK_ACCOUNT_1 }}
        run: |
          ARGS="--account 1"
          if [ "${{ inputs.dry_run }}" = "true" ]; then
            ARGS="$ARGS --dry-run"
          fi
          if [ "${{ inputs.auto_approve }}" = "true" ] || [ -z "${{ inputs.auto_approve }}" ]; then
            ARGS="$ARGS --auto-approve"
          fi
          if [ -n "${{ inputs.min_likes }}" ] && [ "${{ inputs.min_likes }}" != "500" ]; then
            ARGS="$ARGS --min-likes ${{ inputs.min_likes }}"
          fi
          python -m src.main collect $ARGS

      - name: Sync queue to sheet
        if: ${{ inputs.dry_run != 'true' }}
        env:
          SPREADSHEET_ID: ${{ secrets.SPREADSHEET_ID }}
          GOOGLE_CREDENTIALS_BASE64: ${{ secrets.GOOGLE_CREDENTIALS_BASE64 }}
        run: python -m src.main sync-queue --direction to_sheet --quiet
        continue-on-error: true

      - name: Export dashboard data
        if: ${{ inputs.dry_run != 'true' }}
        run: python -m src.main export-dashboard --account 1
        continue-on-error: true

      - name: Commit queue changes
        if: ${{ inputs.dry_run != 'true' }}
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add data/queue/ public/dashboard-data.json
          git diff --staged --quiet || git commit -m "chore: auto-collect buzz tweets $(date +'%Y-%m-%d')"
          git push
