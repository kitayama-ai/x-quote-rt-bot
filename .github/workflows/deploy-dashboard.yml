name: Deploy Dashboard (Firebase Hosting)

# public/ 配下の変更時に自動デプロイ
on:
  push:
    branches: [main]
    paths:
      - "public/**"
      - "firebase.json"
  workflow_dispatch: # 手動実行可能

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Firebase CLI
        run: npm install -g firebase-tools@15

      - name: Setup credentials
        run: |
          # FIREBASE_CREDENTIALS_BASE64 からサービスアカウントJSONを復元
          echo "$FIREBASE_CREDENTIALS_BASE64" | tr -d '\n\r ' | base64 -d > /tmp/firebase-sa.json
        env:
          FIREBASE_CREDENTIALS_BASE64: ${{ secrets.FIREBASE_CREDENTIALS_BASE64 }}
          DATA_UID: ${{ secrets.DATA_UID }}

      - name: Verify credentials
        run: |
          if [ ! -f /tmp/firebase-sa.json ] || [ ! -s /tmp/firebase-sa.json ]; then
            echo "❌ Firebase service account file is missing or empty"
            exit 1
          fi
          echo "✅ Service account file ready"

      - name: Deploy to Firebase Hosting
        run: |
          firebase deploy --only hosting --project isai-11f7b || {
            echo ""
            echo "❌ Deploy失敗。以下を確認してください："
            echo "1. GCP Console > IAM で、サービスアカウントに以下のロールを付与："
            echo "   - Firebase Hosting Admin"
            echo "   - Service Usage Consumer (roles/serviceusage.serviceUsageConsumer)"
            echo "2. FIREBASE_CREDENTIALS_BASE64 が正しいサービスアカウントのBase64エンコードであること"
            exit 1
          }
        env:
          GOOGLE_APPLICATION_CREDENTIALS: /tmp/firebase-sa.json
