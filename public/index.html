<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>X å¼•ç”¨RTè‡ªå‹•æŠ•ç¨¿ â€” ã‚­ãƒ¥ãƒ¼ç®¡ç†ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</title>
<style>
/* ===========================================
   CSS CUSTOM PROPERTIES
   =========================================== */
:root {
  --bg-primary: #0a0a0f;
  --bg-card: #12121a;
  --bg-card-hover: #1a1a26;
  --bg-input: #1e1e2e;
  --border: #2a2a3a;
  --border-hover: #3a3a4e;
  --text-primary: #f0f0f5;
  --text-secondary: #8888a0;
  --text-muted: #5a5a70;
  --accent-blue: #1DA1F2;
  --accent-blue-dim: rgba(29,161,242,0.15);
  --accent-green: #10b981;
  --accent-green-dim: rgba(16,185,129,0.15);
  --accent-amber: #f59e0b;
  --accent-amber-dim: rgba(245,158,11,0.15);
  --accent-red: #ef4444;
  --accent-red-dim: rgba(239,68,68,0.15);
  --accent-purple: #8b5cf6;
  --accent-purple-dim: rgba(139,92,246,0.15);
  --radius: 12px;
  --radius-sm: 8px;
  --font-sans: "Inter", "Noto Sans JP", -apple-system, sans-serif;
  --font-mono: "JetBrains Mono", "SF Mono", monospace;
  --shadow: 0 4px 24px rgba(0,0,0,0.3);
}

/* ===========================================
   RESET & BASE
   =========================================== */
*, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

body {
  font-family: var(--font-sans);
  background: var(--bg-primary);
  color: var(--text-primary);
  line-height: 1.6;
  min-height: 100vh;
}

/* ===========================================
   LAYOUT
   =========================================== */
.app {
  max-width: 1280px;
  margin: 0 auto;
  padding: 24px 20px 60px;
}

.header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 32px;
  flex-wrap: wrap;
  gap: 16px;
}

.header-left {
  display: flex;
  align-items: center;
  gap: 14px;
}

.header-logo {
  width: 38px;
  height: 38px;
  background: var(--accent-blue);
  border-radius: 10px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 700;
  font-size: 18px;
  color: #fff;
  flex-shrink: 0;
}

.header h1 {
  font-size: 20px;
  font-weight: 700;
  letter-spacing: -0.02em;
}

.header h1 span {
  color: var(--text-secondary);
  font-weight: 400;
  font-size: 14px;
  margin-left: 8px;
}

.header-right {
  display: flex;
  align-items: center;
  gap: 12px;
}

.badge {
  font-size: 11px;
  padding: 4px 10px;
  border-radius: 20px;
  font-weight: 600;
  letter-spacing: 0.02em;
}

.badge-live { background: var(--accent-green-dim); color: var(--accent-green); }
.badge-stale { background: var(--accent-amber-dim); color: var(--accent-amber); }

.last-updated {
  font-size: 12px;
  color: var(--text-muted);
  font-family: var(--font-mono);
}

/* ===========================================
   TABS
   =========================================== */
.tabs {
  display: flex;
  gap: 4px;
  margin-bottom: 28px;
  border-bottom: 1px solid var(--border);
  padding-bottom: 0;
  overflow-x: auto;
}

.tab {
  padding: 10px 18px;
  font-size: 13px;
  font-weight: 500;
  color: var(--text-secondary);
  cursor: pointer;
  border: none;
  background: none;
  border-bottom: 2px solid transparent;
  transition: color 0.2s, border-color 0.2s;
  white-space: nowrap;
}

.tab:hover { color: var(--text-primary); }
.tab.active {
  color: var(--accent-blue);
  border-bottom-color: var(--accent-blue);
}

/* ===========================================
   KPI CARDS
   =========================================== */
.kpi-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
  gap: 16px;
  margin-bottom: 28px;
}

.kpi-card {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 20px;
  transition: border-color 0.2s, transform 0.15s;
}

.kpi-card:hover {
  border-color: var(--border-hover);
  transform: translateY(-1px);
}

.kpi-label {
  font-size: 12px;
  color: var(--text-secondary);
  text-transform: uppercase;
  letter-spacing: 0.06em;
  margin-bottom: 8px;
}

.kpi-value {
  font-size: 32px;
  font-weight: 700;
  letter-spacing: -0.02em;
  font-family: var(--font-mono);
}

.kpi-value.blue { color: var(--accent-blue); }
.kpi-value.green { color: var(--accent-green); }
.kpi-value.amber { color: var(--accent-amber); }
.kpi-value.purple { color: var(--accent-purple); }
.kpi-value.red { color: var(--accent-red); }

.kpi-sub {
  font-size: 11px;
  color: var(--text-muted);
  margin-top: 4px;
  font-family: var(--font-mono);
}

/* ===========================================
   TAB PANELS
   =========================================== */
.tab-panel { display: none; }
.tab-panel.active { display: block; }

/* ===========================================
   DATA TABLE
   =========================================== */
.table-wrapper {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  overflow: hidden;
}

.table-toolbar {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 14px 18px;
  border-bottom: 1px solid var(--border);
  flex-wrap: wrap;
  gap: 10px;
}

.table-toolbar h3 {
  font-size: 14px;
  font-weight: 600;
}

.filter-group {
  display: flex;
  gap: 6px;
}

.filter-btn {
  font-size: 12px;
  padding: 5px 12px;
  border-radius: 6px;
  border: 1px solid var(--border);
  background: transparent;
  color: var(--text-secondary);
  cursor: pointer;
  transition: all 0.15s;
  font-family: var(--font-sans);
}

.filter-btn:hover { border-color: var(--border-hover); color: var(--text-primary); }
.filter-btn.active {
  background: var(--accent-blue-dim);
  border-color: var(--accent-blue);
  color: var(--accent-blue);
}

table {
  width: 100%;
  border-collapse: collapse;
}

th, td {
  text-align: left;
  padding: 12px 18px;
  font-size: 13px;
  border-bottom: 1px solid var(--border);
}

th {
  font-size: 11px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.06em;
  color: var(--text-muted);
  background: var(--bg-input);
  position: sticky;
  top: 0;
}

tr:last-child td { border-bottom: none; }

tr:hover td { background: var(--bg-card-hover); }

.table-scroll {
  max-height: 520px;
  overflow-y: auto;
}

/* Scrollbar */
.table-scroll::-webkit-scrollbar { width: 6px; }
.table-scroll::-webkit-scrollbar-track { background: var(--bg-card); }
.table-scroll::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

/* Status badge in table */
.status {
  display: inline-flex;
  align-items: center;
  gap: 5px;
  font-size: 12px;
  padding: 3px 10px;
  border-radius: 20px;
  font-weight: 600;
}

.status-pending { background: var(--accent-amber-dim); color: var(--accent-amber); }
.status-approved { background: var(--accent-blue-dim); color: var(--accent-blue); }
.status-generated { background: var(--accent-purple-dim); color: var(--accent-purple); }
.status-posted { background: var(--accent-green-dim); color: var(--accent-green); }
.status-skipped { background: var(--accent-red-dim); color: var(--accent-red); }

.tweet-text {
  max-width: 400px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  color: var(--text-secondary);
  font-size: 12px;
}

.tweet-text.generated {
  color: var(--text-primary);
  font-weight: 500;
}

.tweet-meta {
  font-size: 11px;
  color: var(--text-muted);
  font-family: var(--font-mono);
}

.tweet-metrics {
  display: flex;
  gap: 10px;
  font-size: 11px;
  color: var(--text-secondary);
  font-family: var(--font-mono);
}

.tweet-metrics span { white-space: nowrap; }

.external-link {
  color: var(--accent-blue);
  text-decoration: none;
  font-size: 12px;
}
.external-link:hover { text-decoration: underline; }

/* ===========================================
   POSTED HISTORY CARD
   =========================================== */
.posted-card {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 18px;
  margin-bottom: 12px;
  transition: border-color 0.2s;
}

.posted-card:hover { border-color: var(--border-hover); }

.posted-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 10px;
}

.posted-time {
  font-size: 12px;
  color: var(--text-muted);
  font-family: var(--font-mono);
}

.posted-body {
  font-size: 14px;
  line-height: 1.7;
  margin-bottom: 10px;
  color: var(--text-primary);
}

.posted-source {
  font-size: 12px;
  color: var(--text-secondary);
  display: flex;
  align-items: center;
  gap: 8px;
}

/* ===========================================
   METRICS PANEL
   =========================================== */
.metrics-chart-area {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 24px;
  margin-bottom: 20px;
}

.metrics-chart-area h3 {
  font-size: 14px;
  font-weight: 600;
  margin-bottom: 18px;
}

.chart-container {
  position: relative;
  height: 240px;
}

.metric-row {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 12px;
  margin-bottom: 20px;
}

.metric-item {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  padding: 16px;
}

.metric-item-label {
  font-size: 12px;
  color: var(--text-secondary);
  margin-bottom: 4px;
}

.metric-item-value {
  font-size: 22px;
  font-weight: 700;
  font-family: var(--font-mono);
}

/* ===========================================
   EMPTY STATE
   =========================================== */
.empty-state {
  text-align: center;
  padding: 60px 20px;
  color: var(--text-muted);
}

.empty-state-icon {
  font-size: 48px;
  margin-bottom: 12px;
  opacity: 0.5;
}

.empty-state h3 {
  font-size: 16px;
  color: var(--text-secondary);
  margin-bottom: 8px;
}

.empty-state p {
  font-size: 13px;
  max-width: 400px;
  margin: 0 auto;
}

/* ===========================================
   LOADING
   =========================================== */
.loading {
  text-align: center;
  padding: 80px 20px;
}

.spinner {
  width: 32px;
  height: 32px;
  border: 3px solid var(--border);
  border-top-color: var(--accent-blue);
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
  margin: 0 auto 16px;
}

@keyframes spin { to { transform: rotate(360deg); } }

.loading-text {
  font-size: 13px;
  color: var(--text-muted);
}

/* ===========================================
   ERROR STATE
   =========================================== */
.error-state {
  text-align: center;
  padding: 60px 20px;
  color: var(--accent-red);
}

.error-state h3 { margin-bottom: 8px; }

.error-state p {
  font-size: 13px;
  color: var(--text-secondary);
  max-width: 500px;
  margin: 0 auto 16px;
}

.error-state code {
  background: var(--bg-input);
  padding: 8px 16px;
  border-radius: 6px;
  font-size: 12px;
  display: inline-block;
  font-family: var(--font-mono);
  color: var(--text-muted);
}

/* ===========================================
   TOOLTIP
   =========================================== */
.tooltip-trigger {
  position: relative;
  cursor: help;
}

.tooltip-trigger:hover::after {
  content: attr(data-tooltip);
  position: absolute;
  bottom: 100%;
  left: 50%;
  transform: translateX(-50%);
  background: var(--bg-input);
  border: 1px solid var(--border);
  color: var(--text-primary);
  font-size: 12px;
  padding: 6px 10px;
  border-radius: 6px;
  white-space: nowrap;
  z-index: 100;
  box-shadow: var(--shadow);
}

/* ===========================================
   RESPONSIVE
   =========================================== */
@media (max-width: 768px) {
  .app { padding: 16px 12px 40px; }
  .header { margin-bottom: 20px; }
  .header h1 { font-size: 16px; }
  .kpi-grid { grid-template-columns: repeat(2, 1fr); gap: 10px; }
  .kpi-card { padding: 14px; }
  .kpi-value { font-size: 24px; }
  th, td { padding: 10px 12px; font-size: 12px; }
  .tweet-text { max-width: 200px; }
}

@media (max-width: 480px) {
  .kpi-grid { grid-template-columns: 1fr 1fr; }
  .tabs { gap: 0; }
  .tab { padding: 8px 12px; font-size: 12px; }
}

/* ===========================================
   LOGIN OVERLAY
   =========================================== */
.login-overlay {
  position: fixed;
  inset: 0;
  z-index: 9999;
  background: var(--bg-primary);
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
}

.login-card {
  text-align: center;
  padding: 40px;
}

.login-logo {
  width: 64px;
  height: 64px;
  margin: 0 auto 24px;
  background: var(--accent-blue);
  border-radius: 16px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 30px;
  font-weight: 800;
  color: #fff;
}

.login-title {
  font-size: 22px;
  font-weight: 700;
  color: var(--text-primary);
  margin-bottom: 8px;
}

.login-subtitle {
  font-size: 14px;
  color: var(--text-secondary);
  margin-bottom: 36px;
}

.google-btn {
  display: inline-flex;
  align-items: center;
  gap: 12px;
  padding: 14px 32px;
  border-radius: 10px;
  background: #fff;
  color: #333;
  border: none;
  font-size: 15px;
  font-weight: 600;
  font-family: var(--font-sans);
  cursor: pointer;
  transition: box-shadow 0.2s, transform 0.1s;
}

.google-btn:hover {
  box-shadow: 0 4px 20px rgba(255,255,255,0.1);
  transform: translateY(-1px);
}

.google-btn:active { transform: translateY(0); }

.login-error {
  color: var(--accent-red);
  font-size: 13px;
  margin-top: 20px;
  display: none;
  max-width: 360px;
  margin-left: auto;
  margin-right: auto;
}

.login-loading {
  display: none;
  margin-top: 20px;
}

/* User Info in header */
.user-info {
  display: flex;
  align-items: center;
  gap: 8px;
}

.user-avatar {
  width: 26px;
  height: 26px;
  border-radius: 50%;
  border: 1px solid var(--border);
}

.user-name {
  font-size: 12px;
  color: var(--text-secondary);
}

.logout-btn {
  font-size: 11px;
  padding: 4px 10px;
  border-radius: 6px;
  border: 1px solid var(--border);
  background: transparent;
  color: var(--text-muted);
  cursor: pointer;
  font-family: var(--font-sans);
  transition: border-color 0.15s, color 0.15s;
}

.logout-btn:hover {
  border-color: var(--border-hover);
  color: var(--text-primary);
}
</style>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+JP:wght@400;500;700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
<!-- Firebase SDK (compat) -->
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
</head>
<body>

<!-- ===== LOGIN OVERLAY ===== -->
<div class="login-overlay" id="loginOverlay">
  <div class="login-card">
    <div class="login-logo">X</div>
    <h2 class="login-title">ã‚­ãƒ¥ãƒ¼ç®¡ç†ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h2>
    <p class="login-subtitle">ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«ã‚¢ã‚¯ã‚»ã‚¹</p>
    <button class="google-btn" id="googleLoginBtn">
      <svg width="20" height="20" viewBox="0 0 48 48">
        <path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"/>
        <path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"/>
        <path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"/>
        <path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"/>
      </svg>
      Google ã§ãƒ­ã‚°ã‚¤ãƒ³
    </button>
    <p class="login-error" id="loginError"></p>
    <div class="login-loading" id="loginLoading">
      <div class="spinner"></div>
      <div class="loading-text">èªè¨¼ä¸­...</div>
    </div>
  </div>
</div>

<div class="app" style="display:none">
  <!-- ===== HEADER ===== -->
  <header class="header">
    <div class="header-left">
      <div class="header-logo">X</div>
      <h1>ã‚­ãƒ¥ãƒ¼ç®¡ç†ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ <span>Pattern B</span></h1>
    </div>
    <div class="header-right">
      <span class="badge badge-live" id="statusBadge">LIVE</span>
      <span class="last-updated" id="lastUpdated">--</span>
    </div>
  </header>

  <!-- ===== KPI CARDS ===== -->
  <div class="kpi-grid" id="kpiGrid">
    <div class="kpi-card">
      <div class="kpi-label">æ‰¿èªå¾…ã¡</div>
      <div class="kpi-value amber" id="kpiPending">-</div>
      <div class="kpi-sub">pending</div>
    </div>
    <div class="kpi-card">
      <div class="kpi-label">æ‰¿èªæ¸ˆã¿</div>
      <div class="kpi-value blue" id="kpiApproved">-</div>
      <div class="kpi-sub">approved</div>
    </div>
    <div class="kpi-card">
      <div class="kpi-label">æŠ•ç¨¿æ¸ˆã¿ï¼ˆæœ¬æ—¥ï¼‰</div>
      <div class="kpi-value green" id="kpiPostedToday">-</div>
      <div class="kpi-sub">posted today</div>
    </div>
    <div class="kpi-card">
      <div class="kpi-label">æŠ•ç¨¿æ¸ˆã¿ï¼ˆç´¯è¨ˆï¼‰</div>
      <div class="kpi-value purple" id="kpiPostedTotal">-</div>
      <div class="kpi-sub">all time</div>
    </div>
    <div class="kpi-card">
      <div class="kpi-label">ã‚¹ã‚­ãƒƒãƒ—</div>
      <div class="kpi-value red" id="kpiSkipped">-</div>
      <div class="kpi-sub">skipped</div>
    </div>
  </div>

  <!-- ===== TABS ===== -->
  <nav class="tabs" id="tabNav">
    <button class="tab active" data-tab="queue">ã‚­ãƒ¥ãƒ¼ä¸€è¦§</button>
    <button class="tab" data-tab="posted">æŠ•ç¨¿å±¥æ­´</button>
    <button class="tab" data-tab="metrics">ãƒ¡ãƒˆãƒªã‚¯ã‚¹</button>
  </nav>

  <!-- ===== TAB: QUEUE ===== -->
  <div class="tab-panel active" id="panel-queue">
    <div class="table-wrapper">
      <div class="table-toolbar">
        <h3>åé›†ã‚­ãƒ¥ãƒ¼</h3>
        <div class="filter-group">
          <button class="filter-btn active" data-filter="all">ã™ã¹ã¦</button>
          <button class="filter-btn" data-filter="pending">æ‰¿èªå¾…ã¡</button>
          <button class="filter-btn" data-filter="approved">æ‰¿èªæ¸ˆã¿</button>
          <button class="filter-btn" data-filter="skipped">ã‚¹ã‚­ãƒƒãƒ—</button>
        </div>
      </div>
      <div class="table-scroll" id="queueTableScroll">
        <table>
          <thead>
            <tr>
              <th>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>
              <th>å…ƒãƒ„ã‚¤ãƒ¼ãƒˆ</th>
              <th>ç”Ÿæˆãƒ†ã‚­ã‚¹ãƒˆ</th>
              <th>ã‚¨ãƒ³ã‚²ãƒ¼ã‚¸ãƒ¡ãƒ³ãƒˆ</th>
              <th>è¿½åŠ æ—¥æ™‚</th>
              <th>ãƒªãƒ³ã‚¯</th>
            </tr>
          </thead>
          <tbody id="queueTbody">
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- ===== TAB: POSTED ===== -->
  <div class="tab-panel" id="panel-posted">
    <div id="postedList"></div>
  </div>

  <!-- ===== TAB: METRICS ===== -->
  <div class="tab-panel" id="panel-metrics">
    <div class="metrics-chart-area">
      <h3>ç›´è¿‘7æ—¥é–“ã®æŠ•ç¨¿æ•°æ¨ç§»</h3>
      <div class="chart-container">
        <canvas id="metricsChart"></canvas>
      </div>
    </div>
    <div class="metric-row" id="metricCards"></div>
  </div>
</div>

<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>

<!-- ===== FIREBASE AUTH ===== -->
<script>
(function() {
  // ============================
  // Firebase Configuration
  // ============================
  // TODO: Firebase Console ã‹ã‚‰å–å¾—ã—ãŸå€¤ã‚’è¨­å®šã—ã¦ãã ã•ã„
  const firebaseConfig = {
    apiKey: "FIREBASE_API_KEY",
    authDomain: "isai-11f7b.firebaseapp.com",
    projectId: "isai-11f7b",
    storageBucket: "isai-11f7b.firebasestorage.app",
    messagingSenderId: "FIREBASE_MESSAGING_SENDER_ID",
    appId: "FIREBASE_APP_ID"
  };

  // ============================
  // Allowed Emails (whitelist)
  // ============================
  // ç©ºé…åˆ— = åˆ¶é™ãªã—ï¼ˆGoogleèªè¨¼ã®ã¿ï¼‰
  // ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’è¿½åŠ ã™ã‚‹ã¨ãƒ›ãƒ¯ã‚¤ãƒˆãƒªã‚¹ãƒˆåˆ¶é™
  const ALLOWED_EMAILS = [
    // 'yamato.kitada@cyan-inc.net',
    // 'client@example.com',
  ];

  // ============================
  // Initialize Firebase
  // ============================
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();

  // DOM Elements
  const overlay = document.getElementById('loginOverlay');
  const appEl = document.querySelector('.app');
  const loginBtn = document.getElementById('googleLoginBtn');
  const loginError = document.getElementById('loginError');
  const loginLoading = document.getElementById('loginLoading');

  // ============================
  // Auth State Listener
  // ============================
  auth.onAuthStateChanged((user) => {
    if (user) {
      // Check whitelist
      if (ALLOWED_EMAILS.length > 0 && !ALLOWED_EMAILS.includes(user.email)) {
        showLoginError('ã“ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã«ã¯ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“: ' + user.email);
        auth.signOut();
        return;
      }

      // Authenticated â€” show dashboard
      overlay.style.display = 'none';
      appEl.style.display = 'block';
      addUserInfo(user);

      // Load dashboard data after auth
      if (typeof initDashboard === 'function') {
        initDashboard();
      }
    } else {
      // Not authenticated â€” show login
      overlay.style.display = 'flex';
      appEl.style.display = 'none';
      loginBtn.style.display = 'inline-flex';
      loginLoading.style.display = 'none';
    }
  });

  // ============================
  // Google Login
  // ============================
  loginBtn.addEventListener('click', async () => {
    loginError.style.display = 'none';
    loginBtn.style.display = 'none';
    loginLoading.style.display = 'block';

    try {
      const provider = new firebase.auth.GoogleAuthProvider();
      await auth.signInWithPopup(provider);
    } catch (err) {
      // Popup blocked? Try redirect
      if (err.code === 'auth/popup-blocked') {
        try {
          const provider = new firebase.auth.GoogleAuthProvider();
          await auth.signInWithRedirect(provider);
          return;
        } catch (redirectErr) {
          showLoginError('ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + redirectErr.message);
        }
      } else if (err.code !== 'auth/popup-closed-by-user') {
        showLoginError('ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + err.message);
      }
      loginBtn.style.display = 'inline-flex';
      loginLoading.style.display = 'none';
    }
  });

  // ============================
  // Helpers
  // ============================
  function showLoginError(msg) {
    loginError.textContent = msg;
    loginError.style.display = 'block';
    loginBtn.style.display = 'inline-flex';
    loginLoading.style.display = 'none';
  }

  function addUserInfo(user) {
    const headerRight = document.querySelector('.header-right');
    if (!headerRight || document.getElementById('userInfo')) return;

    const div = document.createElement('div');
    div.id = 'userInfo';
    div.className = 'user-info';

    const photoUrl = user.photoURL || '';
    const displayName = user.displayName || user.email || '';

    div.innerHTML =
      (photoUrl ? '<img class="user-avatar" src="' + photoUrl + '" alt="" onerror="this.style.display=\'none\'">' : '') +
      '<span class="user-name">' + displayName + '</span>' +
      '<button class="logout-btn" id="logoutBtn">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>';

    headerRight.appendChild(div);
    document.getElementById('logoutBtn').addEventListener('click', () => {
      const userInfoEl = document.getElementById('userInfo');
      if (userInfoEl) userInfoEl.remove();
      auth.signOut();
    });
  }
})();
</script>

<script>
/* ===========================================
   DASHBOARD APP
   =========================================== */

const DATA_URL = './dashboard-data.json';
let currentFilter = 'all';
let dashboardData = null;
let metricsChartInstance = null;
let dashboardInitialized = false;

// --- Init (called by auth after login) ---
function initDashboard() {
  if (dashboardInitialized) return;
  dashboardInitialized = true;
  initTabs();
  initFilters();
  loadData();
}

// --- Tab switching ---
function initTabs() {
  document.querySelectorAll('.tab').forEach(tab => {
    tab.addEventListener('click', () => {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
      tab.classList.add('active');
      document.getElementById('panel-' + tab.dataset.tab).classList.add('active');
    });
  });
}

// --- Filter buttons ---
function initFilters() {
  document.querySelectorAll('.filter-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      currentFilter = btn.dataset.filter;
      renderQueue();
    });
  });
}

// --- Load data ---
async function loadData() {
  const container = document.getElementById('queueTbody');
  container.innerHTML = '<tr><td colspan="6"><div class="loading"><div class="spinner"></div><div class="loading-text">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</div></div></td></tr>';

  try {
    const res = await fetch(DATA_URL);
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    dashboardData = await res.json();
    render();
  } catch (err) {
    container.innerHTML = `<tr><td colspan="6">
      <div class="error-state">
        <div class="empty-state-icon">!</div>
        <h3>ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</h3>
        <p>dashboard-data.json ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§ãƒ‡ãƒ¼ã‚¿ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„:</p>
        <code>python -m src.main export-dashboard</code>
      </div>
    </td></tr>`;
  }
}

// --- Render all ---
function render() {
  if (!dashboardData) return;
  renderKPI();
  renderQueue();
  renderPosted();
  renderMetrics();
  renderUpdatedTime();
}

// --- KPI ---
function renderKPI() {
  const s = dashboardData.stats;
  document.getElementById('kpiPending').textContent = s.pending ?? 0;
  document.getElementById('kpiApproved').textContent = s.approved ?? 0;
  document.getElementById('kpiPostedToday').textContent = s.posted_today ?? 0;
  document.getElementById('kpiPostedTotal').textContent = s.posted_total ?? 0;
  document.getElementById('kpiSkipped').textContent = s.skipped ?? 0;
}

// --- Queue table ---
function renderQueue() {
  const tbody = document.getElementById('queueTbody');
  if (!dashboardData || !dashboardData.queue) {
    tbody.innerHTML = '<tr><td colspan="6"><div class="empty-state"><div class="empty-state-icon">ğŸ“­</div><h3>ã‚­ãƒ¥ãƒ¼ãŒç©ºã§ã™</h3><p>collectã‚³ãƒãƒ³ãƒ‰ã§ãƒã‚ºãƒ„ã‚¤ãƒ¼ãƒˆã‚’åé›†ã—ã¦ãã ã•ã„</p></div></td></tr>';
    return;
  }

  let items = dashboardData.queue;
  if (currentFilter !== 'all') {
    items = items.filter(i => i.status === currentFilter);
  }

  if (items.length === 0) {
    tbody.innerHTML = `<tr><td colspan="6"><div class="empty-state"><div class="empty-state-icon">ğŸ”</div><h3>è©²å½“ã™ã‚‹ã‚¢ã‚¤ãƒ†ãƒ ãŒã‚ã‚Šã¾ã›ã‚“</h3></div></td></tr>`;
    return;
  }

  // Sort: pending first, then approved, then others
  const order = { pending: 0, approved: 1, skipped: 2 };
  items = [...items].sort((a, b) => (order[a.status] ?? 9) - (order[b.status] ?? 9));

  tbody.innerHTML = items.map(item => {
    const statusClass = `status-${item.status}`;
    const statusLabel = { pending: 'æ‰¿èªå¾…ã¡', approved: 'æ‰¿èªæ¸ˆã¿', skipped: 'ã‚¹ã‚­ãƒƒãƒ—', generated: 'ç”Ÿæˆæ¸ˆã¿' }[item.status] || item.status;

    const originalText = item.original_text || item.text || '-';
    const generatedText = item.generated_text || '';
    const tweetId = item.tweet_id || '';
    const tweetUrl = tweetId ? `https://x.com/i/status/${tweetId}` : '#';

    const likes = item.likes ?? item.favorite_count ?? '-';
    const rts = item.retweets ?? item.retweet_count ?? '-';
    const addedAt = item.added_at ? formatTime(item.added_at) : '-';

    return `<tr>
      <td><span class="status ${statusClass}">${statusLabel}</span></td>
      <td><div class="tweet-text" title="${escapeHtml(originalText)}">${escapeHtml(truncate(originalText, 60))}</div></td>
      <td><div class="tweet-text ${generatedText ? 'generated' : ''}" title="${escapeHtml(generatedText)}">${generatedText ? escapeHtml(truncate(generatedText, 50)) : '<span style="color:var(--text-muted)">æœªç”Ÿæˆ</span>'}</div></td>
      <td><div class="tweet-metrics"><span>â™¥ ${formatNum(likes)}</span><span>ğŸ” ${formatNum(rts)}</span></div></td>
      <td><span class="tweet-meta">${addedAt}</span></td>
      <td>${tweetId ? `<a class="external-link" href="${tweetUrl}" target="_blank" rel="noopener">å…ƒãƒ„ã‚¤ãƒ¼ãƒˆ â†—</a>` : '-'}</td>
    </tr>`;
  }).join('');
}

// --- Posted history ---
function renderPosted() {
  const container = document.getElementById('postedList');
  const posted = dashboardData.recent_posted;

  if (!posted || posted.length === 0) {
    container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ğŸ“¤</div><h3>æŠ•ç¨¿å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</h3><p>å¼•ç”¨RTæŠ•ç¨¿ãŒå®Œäº†ã™ã‚‹ã¨ã€ã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™</p></div>';
    return;
  }

  container.innerHTML = posted.map(item => {
    const postedAt = item.posted_at ? formatTime(item.posted_at) : '-';
    const text = item.generated_text || item.text || '-';
    const tweetId = item.tweet_id || '';
    const postedTweetId = item.posted_tweet_id || '';
    const originalUrl = tweetId ? `https://x.com/i/status/${tweetId}` : '';
    const postedUrl = postedTweetId ? `https://x.com/i/status/${postedTweetId}` : '';

    return `<div class="posted-card">
      <div class="posted-header">
        <span class="status status-posted">æŠ•ç¨¿æ¸ˆã¿</span>
        <span class="posted-time">${postedAt}</span>
      </div>
      <div class="posted-body">${escapeHtml(text)}</div>
      <div class="posted-source">
        ${originalUrl ? `<a class="external-link" href="${originalUrl}" target="_blank" rel="noopener">å…ƒãƒ„ã‚¤ãƒ¼ãƒˆ â†—</a>` : ''}
        ${postedUrl ? `<a class="external-link" href="${postedUrl}" target="_blank" rel="noopener">æŠ•ç¨¿ãƒ„ã‚¤ãƒ¼ãƒˆ â†—</a>` : ''}
      </div>
    </div>`;
  }).join('');
}

// --- Metrics ---
function renderMetrics() {
  const metrics = dashboardData.metrics;

  // Metric summary cards
  const container = document.getElementById('metricCards');
  if (!metrics || metrics.length === 0) {
    container.innerHTML = '<div class="empty-state" style="grid-column:1/-1;"><div class="empty-state-icon">ğŸ“Š</div><h3>ãƒ¡ãƒˆãƒªã‚¯ã‚¹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</h3><p>metricsã‚³ãƒãƒ³ãƒ‰ã§åé›†ã§ãã¾ã™</p></div>';
    renderEmptyChart();
    return;
  }

  // Aggregate latest metrics
  const latest = metrics[0] || {};
  const summary = latest.summary || latest;

  const cards = [
    { label: 'ã„ã„ã­åˆè¨ˆ', value: summary.total_likes ?? summary.likes ?? '-', color: 'var(--accent-red)' },
    { label: 'RTåˆè¨ˆ', value: summary.total_retweets ?? summary.retweets ?? '-', color: 'var(--accent-green)' },
    { label: 'ã‚¤ãƒ³ãƒ—ãƒ¬ãƒƒã‚·ãƒ§ãƒ³', value: summary.total_impressions ?? summary.impressions ?? '-', color: 'var(--accent-blue)' },
    { label: 'å¹³å‡ã‚¨ãƒ³ã‚²ãƒ¼ã‚¸ãƒ¡ãƒ³ãƒˆç‡', value: summary.avg_engagement_rate != null ? (summary.avg_engagement_rate * 100).toFixed(2) + '%' : '-', color: 'var(--accent-purple)' },
  ];

  container.innerHTML = cards.map(c => `
    <div class="metric-item">
      <div class="metric-item-label">${c.label}</div>
      <div class="metric-item-value" style="color:${c.color}">${typeof c.value === 'number' ? formatNum(c.value) : c.value}</div>
    </div>
  `).join('');

  // Chart
  renderChart(metrics);
}

function renderChart(metrics) {
  const ctx = document.getElementById('metricsChart');
  if (!ctx) return;

  if (metricsChartInstance) {
    metricsChartInstance.destroy();
  }

  const labels = metrics.map(m => {
    const d = m.date || m.collected_at || '';
    return d.substring(5, 10); // MM-DD
  }).reverse();

  const postCounts = metrics.map(m => {
    const s = m.summary || m;
    return s.tweet_count ?? s.post_count ?? 0;
  }).reverse();

  const likeCounts = metrics.map(m => {
    const s = m.summary || m;
    return s.total_likes ?? s.likes ?? 0;
  }).reverse();

  metricsChartInstance = new Chart(ctx, {
    type: 'bar',
    data: {
      labels,
      datasets: [
        {
          label: 'æŠ•ç¨¿æ•°',
          data: postCounts,
          backgroundColor: 'rgba(29,161,242,0.6)',
          borderColor: 'rgba(29,161,242,1)',
          borderWidth: 1,
          borderRadius: 4,
          yAxisID: 'y',
        },
        {
          label: 'ã„ã„ã­æ•°',
          data: likeCounts,
          type: 'line',
          borderColor: 'rgba(239,68,68,0.8)',
          backgroundColor: 'rgba(239,68,68,0.1)',
          borderWidth: 2,
          pointRadius: 3,
          fill: true,
          tension: 0.3,
          yAxisID: 'y1',
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: { mode: 'index', intersect: false },
      plugins: {
        legend: {
          labels: { color: '#8888a0', font: { size: 11 } }
        }
      },
      scales: {
        x: {
          ticks: { color: '#5a5a70', font: { size: 11 } },
          grid: { color: 'rgba(42,42,58,0.5)' }
        },
        y: {
          position: 'left',
          ticks: { color: '#5a5a70', font: { size: 11 }, stepSize: 1 },
          grid: { color: 'rgba(42,42,58,0.5)' },
          title: { display: true, text: 'æŠ•ç¨¿æ•°', color: '#8888a0', font: { size: 11 } }
        },
        y1: {
          position: 'right',
          ticks: { color: '#5a5a70', font: { size: 11 } },
          grid: { drawOnChartArea: false },
          title: { display: true, text: 'ã„ã„ã­', color: '#8888a0', font: { size: 11 } }
        }
      }
    }
  });
}

function renderEmptyChart() {
  const ctx = document.getElementById('metricsChart');
  if (!ctx) return;
  if (metricsChartInstance) metricsChartInstance.destroy();

  metricsChartInstance = new Chart(ctx, {
    type: 'bar',
    data: { labels: ['---'], datasets: [{ label: 'æŠ•ç¨¿æ•°', data: [0], backgroundColor: 'rgba(29,161,242,0.3)' }] },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { display: false } },
      scales: {
        x: { ticks: { color: '#5a5a70' }, grid: { color: 'rgba(42,42,58,0.5)' } },
        y: { ticks: { color: '#5a5a70' }, grid: { color: 'rgba(42,42,58,0.5)' } }
      }
    }
  });
}

// --- Updated time ---
function renderUpdatedTime() {
  const el = document.getElementById('lastUpdated');
  const badge = document.getElementById('statusBadge');
  if (!dashboardData.updated_at) {
    el.textContent = '--';
    return;
  }

  const updated = new Date(dashboardData.updated_at);
  const now = new Date();
  const diffMin = Math.floor((now - updated) / 60000);

  el.textContent = formatTime(dashboardData.updated_at);

  if (diffMin > 120) {
    badge.className = 'badge badge-stale';
    badge.textContent = 'STALE';
  } else {
    badge.className = 'badge badge-live';
    badge.textContent = 'LIVE';
  }
}

// --- Helpers ---
function formatTime(isoStr) {
  try {
    const d = new Date(isoStr);
    return d.toLocaleString('ja-JP', {
      month: '2-digit', day: '2-digit',
      hour: '2-digit', minute: '2-digit'
    });
  } catch { return isoStr; }
}

function formatNum(n) {
  if (n == null || n === '-') return '-';
  const num = Number(n);
  if (isNaN(num)) return n;
  if (num >= 10000) return (num / 10000).toFixed(1) + 'ä¸‡';
  if (num >= 1000) return (num / 1000).toFixed(1) + 'k';
  return num.toLocaleString();
}

function truncate(str, len) {
  if (!str) return '';
  return str.length > len ? str.slice(0, len) + '...' : str;
}

function escapeHtml(str) {
  if (!str) return '';
  const d = document.createElement('div');
  d.textContent = str;
  return d.innerHTML;
}
</script>
</body>
</html>
