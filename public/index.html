<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>X 引用RT自動投稿 — キュー管理ダッシュボード</title>
<style>
/* ===========================================
   CSS CUSTOM PROPERTIES
   =========================================== */
:root {
  --bg-primary: #06060b;
  --bg-secondary: #0c0c14;
  --bg-card: #111119;
  --bg-card-hover: #16161f;
  --bg-input: #1a1a28;
  --border: #1f1f30;
  --border-hover: #2e2e48;
  --text-primary: #eeeef2;
  --text-secondary: #8b8ba8;
  --text-muted: #555570;
  --accent-blue: #3b82f6;
  --accent-blue-dim: rgba(59,130,246,0.12);
  --accent-blue-glow: rgba(59,130,246,0.25);
  --accent-green: #10b981;
  --accent-green-dim: rgba(16,185,129,0.12);
  --accent-amber: #f59e0b;
  --accent-amber-dim: rgba(245,158,11,0.12);
  --accent-red: #ef4444;
  --accent-red-dim: rgba(239,68,68,0.12);
  --accent-purple: #8b5cf6;
  --accent-purple-dim: rgba(139,92,246,0.12);
  --radius: 14px;
  --radius-sm: 10px;
  --font-sans: "Inter", "Noto Sans JP", -apple-system, BlinkMacSystemFont, sans-serif;
  --font-mono: "Fira Code", "JetBrains Mono", "SF Mono", monospace;
  --shadow-sm: 0 1px 3px rgba(0,0,0,0.4);
  --shadow: 0 4px 24px rgba(0,0,0,0.4);
  --shadow-lg: 0 8px 40px rgba(0,0,0,0.5);
  --transition-fast: 150ms cubic-bezier(0.4, 0, 0.2, 1);
  --transition-base: 250ms cubic-bezier(0.4, 0, 0.2, 1);
}

/* ===========================================
   RESET & BASE
   =========================================== */
*, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

body {
  font-family: var(--font-sans);
  background: var(--bg-primary);
  color: var(--text-primary);
  line-height: 1.6;
  min-height: 100vh;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

@media (prefers-reduced-motion: reduce) {
  *, *::before, *::after {
    animation-duration: 0.01ms !important;
    transition-duration: 0.01ms !important;
  }
}

/* ===========================================
   LAYOUT
   =========================================== */
.app {
  max-width: 1320px;
  margin: 0 auto;
  padding: 28px 24px 64px;
  opacity: 0;
  animation: fadeIn 0.4s ease forwards;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(8px); }
  to { opacity: 1; transform: translateY(0); }
}

.header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 36px;
  flex-wrap: wrap;
  gap: 16px;
}

.header-left {
  display: flex;
  align-items: center;
  gap: 14px;
}

.header-logo {
  width: 40px;
  height: 40px;
  background: var(--accent-blue);
  border-radius: 11px;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
  box-shadow: 0 0 20px var(--accent-blue-glow);
}

.header-logo svg {
  width: 20px;
  height: 20px;
  fill: #fff;
}

.header h1 {
  font-size: 20px;
  font-weight: 700;
  letter-spacing: -0.025em;
}

.header h1 span {
  color: var(--text-muted);
  font-weight: 500;
  font-size: 13px;
  margin-left: 10px;
  padding: 2px 8px;
  background: var(--bg-input);
  border-radius: 6px;
  letter-spacing: 0;
}

.header-right {
  display: flex;
  align-items: center;
  gap: 12px;
}

.badge {
  font-size: 11px;
  padding: 4px 10px;
  border-radius: 20px;
  font-weight: 600;
  letter-spacing: 0.04em;
  text-transform: uppercase;
}

.badge-live {
  background: var(--accent-green-dim);
  color: var(--accent-green);
  box-shadow: 0 0 12px rgba(16,185,129,0.15);
}
.badge-stale { background: var(--accent-amber-dim); color: var(--accent-amber); }

.last-updated {
  font-size: 12px;
  color: var(--text-muted);
  font-family: var(--font-mono);
  font-variant-numeric: tabular-nums;
}

/* ===========================================
   TABS
   =========================================== */
.tabs {
  display: flex;
  gap: 2px;
  margin-bottom: 28px;
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  padding: 4px;
  overflow-x: auto;
  width: fit-content;
}

.tab {
  padding: 9px 20px;
  font-size: 13px;
  font-weight: 500;
  color: var(--text-secondary);
  cursor: pointer;
  border: none;
  background: none;
  border-radius: 7px;
  transition: color var(--transition-fast), background var(--transition-fast);
  white-space: nowrap;
  font-family: var(--font-sans);
}

.tab:hover { color: var(--text-primary); background: var(--bg-input); }
.tab.active {
  color: #fff;
  background: var(--accent-blue);
  box-shadow: 0 2px 8px rgba(59,130,246,0.3);
}

/* ===========================================
   KPI CARDS
   =========================================== */
.kpi-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 14px;
  margin-bottom: 32px;
}

.kpi-card {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 22px 24px;
  transition: border-color var(--transition-fast), box-shadow var(--transition-fast);
  cursor: default;
  position: relative;
  overflow: hidden;
}

.kpi-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 2px;
  opacity: 0;
  transition: opacity var(--transition-fast);
}

.kpi-card:hover {
  border-color: var(--border-hover);
  box-shadow: var(--shadow-sm);
}

.kpi-card:hover::before { opacity: 1; }

.kpi-card:nth-child(1)::before { background: var(--accent-amber); }
.kpi-card:nth-child(2)::before { background: var(--accent-blue); }
.kpi-card:nth-child(3)::before { background: var(--accent-green); }
.kpi-card:nth-child(4)::before { background: var(--accent-purple); }
.kpi-card:nth-child(5)::before { background: var(--accent-red); }

.kpi-label {
  font-size: 12px;
  color: var(--text-secondary);
  font-weight: 500;
  letter-spacing: 0.02em;
  margin-bottom: 10px;
}

.kpi-value {
  font-size: 34px;
  font-weight: 700;
  letter-spacing: -0.03em;
  font-family: var(--font-mono);
  font-variant-numeric: tabular-nums;
  line-height: 1.1;
}

.kpi-value.blue { color: var(--accent-blue); }
.kpi-value.green { color: var(--accent-green); }
.kpi-value.amber { color: var(--accent-amber); }
.kpi-value.purple { color: var(--accent-purple); }
.kpi-value.red { color: var(--accent-red); }

.kpi-sub {
  font-size: 11px;
  color: var(--text-muted);
  margin-top: 6px;
  font-family: var(--font-mono);
  font-variant-numeric: tabular-nums;
}

/* ===========================================
   TAB PANELS
   =========================================== */
.tab-panel { display: none; }
.tab-panel.active { display: block; }

/* ===========================================
   DATA TABLE
   =========================================== */
.table-wrapper {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  overflow: hidden;
  box-shadow: var(--shadow-sm);
}

.table-toolbar {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 16px 20px;
  border-bottom: 1px solid var(--border);
  flex-wrap: wrap;
  gap: 12px;
}

.table-toolbar h3 {
  font-size: 14px;
  font-weight: 600;
}

.filter-group {
  display: flex;
  gap: 6px;
}

.filter-btn {
  font-size: 12px;
  padding: 6px 14px;
  border-radius: 7px;
  border: 1px solid var(--border);
  background: transparent;
  color: var(--text-secondary);
  cursor: pointer;
  transition: all var(--transition-fast);
  font-family: var(--font-sans);
  font-weight: 500;
}

.filter-btn:hover { border-color: var(--border-hover); color: var(--text-primary); background: var(--bg-input); }
.filter-btn.active {
  background: var(--accent-blue);
  border-color: var(--accent-blue);
  color: #fff;
  box-shadow: 0 2px 8px rgba(59,130,246,0.25);
}

table {
  width: 100%;
  border-collapse: collapse;
}

th, td {
  text-align: left;
  padding: 13px 20px;
  font-size: 13px;
  border-bottom: 1px solid var(--border);
}

th {
  font-size: 11px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.06em;
  color: var(--text-muted);
  background: var(--bg-secondary);
  position: sticky;
  top: 0;
  z-index: 10;
}

tr:last-child td { border-bottom: none; }

tr { transition: background var(--transition-fast); }
tr:hover td { background: var(--bg-card-hover); }

.table-scroll {
  max-height: 520px;
  overflow-y: auto;
}

/* Scrollbar */
.table-scroll::-webkit-scrollbar { width: 6px; }
.table-scroll::-webkit-scrollbar-track { background: var(--bg-card); }
.table-scroll::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

/* Status badge in table */
.status {
  display: inline-flex;
  align-items: center;
  gap: 5px;
  font-size: 12px;
  padding: 3px 10px;
  border-radius: 20px;
  font-weight: 600;
}

.status-pending { background: var(--accent-amber-dim); color: var(--accent-amber); }
.status-approved { background: var(--accent-blue-dim); color: var(--accent-blue); }
.status-generated { background: var(--accent-purple-dim); color: var(--accent-purple); }
.status-posted { background: var(--accent-green-dim); color: var(--accent-green); }
.status-skipped { background: var(--accent-red-dim); color: var(--accent-red); }

.tweet-text {
  max-width: 400px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  color: var(--text-secondary);
  font-size: 12px;
}

.tweet-text.generated {
  color: var(--text-primary);
  font-weight: 500;
}

.tweet-meta {
  font-size: 11px;
  color: var(--text-muted);
  font-family: var(--font-mono);
}

.tweet-metrics {
  display: flex;
  gap: 10px;
  font-size: 11px;
  color: var(--text-secondary);
  font-family: var(--font-mono);
}

.tweet-metrics span { white-space: nowrap; }

.external-link {
  color: var(--accent-blue);
  text-decoration: none;
  font-size: 12px;
  font-weight: 500;
  transition: color var(--transition-fast);
}
.external-link:hover { color: #60a5fa; }
.external-link:focus-visible { outline: 2px solid var(--accent-blue); outline-offset: 2px; border-radius: 2px; }

/* ===========================================
   POSTED HISTORY CARD
   =========================================== */
.posted-card {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 20px 22px;
  margin-bottom: 12px;
  transition: border-color var(--transition-fast), box-shadow var(--transition-fast);
}

.posted-card:hover {
  border-color: var(--border-hover);
  box-shadow: var(--shadow-sm);
}

.posted-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 12px;
}

.posted-time {
  font-size: 12px;
  color: var(--text-muted);
  font-family: var(--font-mono);
  font-variant-numeric: tabular-nums;
}

.posted-body {
  font-size: 14px;
  line-height: 1.75;
  margin-bottom: 14px;
  color: var(--text-primary);
}

.posted-source {
  font-size: 12px;
  color: var(--text-secondary);
  display: flex;
  align-items: center;
  gap: 12px;
  padding-top: 12px;
  border-top: 1px solid var(--border);
}

/* ===========================================
   METRICS PANEL
   =========================================== */
.metrics-chart-area {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 24px;
  margin-bottom: 20px;
  box-shadow: var(--shadow-sm);
}

.metrics-chart-area h3 {
  font-size: 14px;
  font-weight: 600;
  margin-bottom: 20px;
}

.chart-container {
  position: relative;
  height: 260px;
}

.metric-row {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 14px;
  margin-bottom: 20px;
}

.metric-item {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  padding: 18px 20px;
  transition: border-color var(--transition-fast);
}

.metric-item:hover { border-color: var(--border-hover); }

.metric-item-label {
  font-size: 12px;
  color: var(--text-secondary);
  margin-bottom: 6px;
  font-weight: 500;
}

.metric-item-value {
  font-size: 24px;
  font-weight: 700;
  font-family: var(--font-mono);
  font-variant-numeric: tabular-nums;
}

/* ===========================================
   EMPTY STATE
   =========================================== */
.empty-state {
  text-align: center;
  padding: 64px 24px;
  color: var(--text-muted);
}

.empty-state-icon {
  width: 48px;
  height: 48px;
  margin: 0 auto 16px;
  color: var(--text-muted);
  opacity: 0.4;
}

.empty-state h3 {
  font-size: 15px;
  color: var(--text-secondary);
  margin-bottom: 8px;
  font-weight: 600;
}

.empty-state p {
  font-size: 13px;
  max-width: 400px;
  margin: 0 auto;
  line-height: 1.7;
}

/* ===========================================
   LOADING
   =========================================== */
.loading {
  text-align: center;
  padding: 80px 24px;
}

.spinner {
  width: 28px;
  height: 28px;
  border: 2.5px solid var(--border);
  border-top-color: var(--accent-blue);
  border-radius: 50%;
  animation: spin 0.7s linear infinite;
  margin: 0 auto 16px;
}

@keyframes spin { to { transform: rotate(360deg); } }

.loading-text {
  font-size: 13px;
  color: var(--text-muted);
}

/* ===========================================
   ERROR STATE
   =========================================== */
.error-state {
  text-align: center;
  padding: 64px 24px;
  color: var(--accent-red);
}

.error-state h3 { margin-bottom: 8px; font-size: 15px; }

.error-state p {
  font-size: 13px;
  color: var(--text-secondary);
  max-width: 500px;
  margin: 0 auto 16px;
  line-height: 1.7;
}

.error-state code {
  background: var(--bg-input);
  padding: 10px 18px;
  border-radius: 8px;
  font-size: 12px;
  display: inline-block;
  font-family: var(--font-mono);
  color: var(--text-secondary);
  border: 1px solid var(--border);
}

/* ===========================================
   TOOLTIP
   =========================================== */
.tooltip-trigger {
  position: relative;
  cursor: help;
}

.tooltip-trigger:hover::after {
  content: attr(data-tooltip);
  position: absolute;
  bottom: 100%;
  left: 50%;
  transform: translateX(-50%);
  background: var(--bg-input);
  border: 1px solid var(--border);
  color: var(--text-primary);
  font-size: 12px;
  padding: 6px 10px;
  border-radius: 6px;
  white-space: nowrap;
  z-index: 100;
  box-shadow: var(--shadow);
}

/* ===========================================
   RESPONSIVE
   =========================================== */
@media (max-width: 768px) {
  .app { padding: 16px 14px 48px; }
  .header { margin-bottom: 24px; }
  .header h1 { font-size: 16px; }
  .header h1 span { font-size: 11px; margin-left: 6px; padding: 1px 6px; }
  .kpi-grid { grid-template-columns: repeat(2, 1fr); gap: 10px; }
  .kpi-card { padding: 16px; }
  .kpi-value { font-size: 26px; }
  th, td { padding: 10px 14px; font-size: 12px; }
  .tweet-text { max-width: 200px; }
  .login-card { padding: 32px 24px; border-radius: 16px; }
  .login-title { font-size: 20px; }
}

@media (max-width: 480px) {
  .kpi-grid { grid-template-columns: 1fr 1fr; }
  .tabs { width: 100%; }
  .tab { padding: 8px 14px; font-size: 12px; flex: 1; text-align: center; }
  .filter-group { flex-wrap: wrap; }
}

/* ===========================================
   LOGIN OVERLAY
   =========================================== */
.login-overlay {
  position: fixed;
  inset: 0;
  z-index: 9999;
  background: var(--bg-primary);
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
}

.login-overlay::before {
  content: '';
  position: absolute;
  top: -40%;
  left: -20%;
  width: 600px;
  height: 600px;
  background: radial-gradient(circle, rgba(59,130,246,0.06) 0%, transparent 70%);
  border-radius: 50%;
  pointer-events: none;
}

.login-overlay::after {
  content: '';
  position: absolute;
  bottom: -30%;
  right: -10%;
  width: 500px;
  height: 500px;
  background: radial-gradient(circle, rgba(139,92,246,0.05) 0%, transparent 70%);
  border-radius: 50%;
  pointer-events: none;
}

.login-card {
  text-align: center;
  padding: 48px 40px;
  position: relative;
  z-index: 1;
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 20px;
  box-shadow: var(--shadow-lg);
  max-width: 400px;
  width: calc(100% - 40px);
}

.login-logo {
  width: 56px;
  height: 56px;
  margin: 0 auto 28px;
  background: var(--accent-blue);
  border-radius: 14px;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 0 30px var(--accent-blue-glow);
}

.login-logo svg {
  width: 26px;
  height: 26px;
  fill: #fff;
}

.login-title {
  font-size: 22px;
  font-weight: 700;
  color: var(--text-primary);
  margin-bottom: 8px;
  letter-spacing: -0.02em;
}

.login-subtitle {
  font-size: 14px;
  color: var(--text-secondary);
  margin-bottom: 32px;
  line-height: 1.6;
}

.google-btn {
  display: inline-flex;
  align-items: center;
  gap: 12px;
  padding: 13px 28px;
  border-radius: var(--radius-sm);
  background: #fff;
  color: #1f1f1f;
  border: none;
  font-size: 14px;
  font-weight: 600;
  font-family: var(--font-sans);
  cursor: pointer;
  transition: box-shadow var(--transition-fast), transform var(--transition-fast);
  width: 100%;
  justify-content: center;
}

.google-btn:hover {
  box-shadow: 0 4px 24px rgba(255,255,255,0.12);
  transform: translateY(-1px);
}

.google-btn:active { transform: translateY(0); }

.google-btn:focus-visible {
  outline: 2px solid var(--accent-blue);
  outline-offset: 2px;
}

.login-error {
  color: var(--accent-red);
  font-size: 13px;
  margin-top: 20px;
  display: none;
  max-width: 360px;
  margin-left: auto;
  margin-right: auto;
  line-height: 1.6;
}

.login-loading {
  display: none;
  margin-top: 24px;
}

/* User Info in header */
.user-info {
  display: flex;
  align-items: center;
  gap: 10px;
}

.user-avatar {
  width: 28px;
  height: 28px;
  border-radius: 50%;
  border: 2px solid var(--border);
}

.user-name {
  font-size: 13px;
  color: var(--text-secondary);
  font-weight: 500;
}

.logout-btn {
  font-size: 12px;
  padding: 5px 12px;
  border-radius: 7px;
  border: 1px solid var(--border);
  background: transparent;
  color: var(--text-muted);
  cursor: pointer;
  font-family: var(--font-sans);
  font-weight: 500;
  transition: border-color var(--transition-fast), color var(--transition-fast), background var(--transition-fast);
}

.logout-btn:hover {
  border-color: var(--accent-red);
  color: var(--accent-red);
  background: var(--accent-red-dim);
}

/* X (Twitter) Login Button */
.x-login-btn {
  display: inline-flex;
  align-items: center;
  gap: 12px;
  padding: 13px 28px;
  border-radius: var(--radius-sm);
  background: #000;
  color: #fff;
  border: 1px solid #333;
  font-size: 14px;
  font-weight: 600;
  font-family: var(--font-sans);
  cursor: pointer;
  transition: box-shadow var(--transition-fast), transform var(--transition-fast), border-color var(--transition-fast);
  width: 100%;
  justify-content: center;
  margin-top: 10px;
}

.x-login-btn:hover {
  box-shadow: 0 4px 24px rgba(255,255,255,0.08);
  transform: translateY(-1px);
  border-color: #555;
}

.x-login-btn:active { transform: translateY(0); }

.x-login-btn:focus-visible {
  outline: 2px solid var(--accent-blue);
  outline-offset: 2px;
}

.x-login-btn svg {
  width: 18px;
  height: 18px;
  fill: #fff;
}

.login-divider {
  display: flex;
  align-items: center;
  gap: 12px;
  margin: 16px 0;
  color: var(--text-muted);
  font-size: 12px;
}

.login-divider::before,
.login-divider::after {
  content: '';
  flex: 1;
  height: 1px;
  background: var(--border);
}

/* ===========================================
   SETTINGS TAB
   =========================================== */
.settings-section {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 24px;
  margin-bottom: 16px;
}

.settings-section h3 {
  font-size: 15px;
  font-weight: 600;
  margin-bottom: 6px;
}

.settings-section p {
  font-size: 13px;
  color: var(--text-secondary);
  margin-bottom: 20px;
  line-height: 1.6;
}

.form-group {
  margin-bottom: 16px;
}

.form-label {
  display: block;
  font-size: 12px;
  font-weight: 600;
  color: var(--text-secondary);
  margin-bottom: 6px;
  letter-spacing: 0.02em;
}

.form-input {
  width: 100%;
  padding: 10px 14px;
  background: var(--bg-input);
  border: 1px solid var(--border);
  border-radius: 8px;
  color: var(--text-primary);
  font-size: 13px;
  font-family: var(--font-mono);
  transition: border-color var(--transition-fast);
}

.form-input:focus {
  outline: none;
  border-color: var(--accent-blue);
  box-shadow: 0 0 0 3px var(--accent-blue-dim);
}

.form-input::placeholder {
  color: var(--text-muted);
}

.form-hint {
  font-size: 11px;
  color: var(--text-muted);
  margin-top: 4px;
  line-height: 1.5;
}

.save-btn {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  padding: 10px 24px;
  border-radius: 8px;
  background: var(--accent-blue);
  color: #fff;
  border: none;
  font-size: 13px;
  font-weight: 600;
  font-family: var(--font-sans);
  cursor: pointer;
  transition: background var(--transition-fast), box-shadow var(--transition-fast);
  margin-top: 8px;
}

.save-btn:hover {
  background: #2563eb;
  box-shadow: 0 2px 12px rgba(59,130,246,0.3);
}

.save-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

.save-btn:focus-visible {
  outline: 2px solid var(--accent-blue);
  outline-offset: 2px;
}

.save-msg {
  font-size: 13px;
  margin-top: 12px;
  display: none;
}

.save-msg.success { color: var(--accent-green); display: block; }
.save-msg.error { color: var(--accent-red); display: block; }

.api-status {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  font-size: 12px;
  padding: 4px 10px;
  border-radius: 20px;
  font-weight: 600;
}

.api-status.configured {
  background: var(--accent-green-dim);
  color: var(--accent-green);
}

.api-status.not-configured {
  background: var(--accent-amber-dim);
  color: var(--accent-amber);
}

.settings-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
  gap: 16px;
}

.role-badge {
  font-size: 11px;
  padding: 3px 8px;
  border-radius: 12px;
  font-weight: 600;
}

.role-badge.admin {
  background: var(--accent-purple-dim);
  color: var(--accent-purple);
}

.role-badge.client {
  background: var(--accent-blue-dim);
  color: var(--accent-blue);
}
</style>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+JP:wght@400;500;700&family=Fira+Code:wght@400;500;600&display=swap" rel="stylesheet">
<!-- Firebase SDK (compat) -->
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
</head>
<body>

<!-- ===== LOGIN OVERLAY ===== -->
<div class="login-overlay" id="loginOverlay">
  <div class="login-card">
    <div class="login-logo"><svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg></div>
    <h2 class="login-title">キュー管理ダッシュボード</h2>
    <p class="login-subtitle">ログインしてダッシュボードにアクセス</p>
    <button class="google-btn" id="googleLoginBtn">
      <svg width="20" height="20" viewBox="0 0 48 48">
        <path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"/>
        <path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"/>
        <path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"/>
        <path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"/>
      </svg>
      Google でログイン
    </button>
    <div class="login-divider">または</div>
    <button class="x-login-btn" id="xLoginBtn">
      <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>
      X でログイン
    </button>
    <p class="login-error" id="loginError"></p>
    <div class="login-loading" id="loginLoading">
      <div class="spinner"></div>
      <div class="loading-text">認証中...</div>
    </div>
  </div>
</div>

<div class="app" style="display:none">
  <!-- ===== HEADER ===== -->
  <header class="header">
    <div class="header-left">
      <div class="header-logo"><svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg></div>
      <h1>キュー管理ダッシュボード <span>Pattern B</span></h1>
    </div>
    <div class="header-right">
      <span class="badge badge-live" id="statusBadge">LIVE</span>
      <span class="last-updated" id="lastUpdated">--</span>
    </div>
  </header>

  <!-- ===== KPI CARDS ===== -->
  <div class="kpi-grid" id="kpiGrid">
    <div class="kpi-card">
      <div class="kpi-label">承認待ち</div>
      <div class="kpi-value amber" id="kpiPending">-</div>
      <div class="kpi-sub">pending</div>
    </div>
    <div class="kpi-card">
      <div class="kpi-label">承認済み</div>
      <div class="kpi-value blue" id="kpiApproved">-</div>
      <div class="kpi-sub">approved</div>
    </div>
    <div class="kpi-card">
      <div class="kpi-label">投稿済み（本日）</div>
      <div class="kpi-value green" id="kpiPostedToday">-</div>
      <div class="kpi-sub">posted today</div>
    </div>
    <div class="kpi-card">
      <div class="kpi-label">投稿済み（累計）</div>
      <div class="kpi-value purple" id="kpiPostedTotal">-</div>
      <div class="kpi-sub">all time</div>
    </div>
    <div class="kpi-card">
      <div class="kpi-label">スキップ</div>
      <div class="kpi-value red" id="kpiSkipped">-</div>
      <div class="kpi-sub">skipped</div>
    </div>
  </div>

  <!-- ===== TABS ===== -->
  <nav class="tabs" id="tabNav">
    <button class="tab active" data-tab="queue">キュー一覧</button>
    <button class="tab" data-tab="posted">投稿履歴</button>
    <button class="tab" data-tab="metrics">メトリクス</button>
    <button class="tab" data-tab="settings">設定</button>
  </nav>

  <!-- ===== TAB: QUEUE ===== -->
  <div class="tab-panel active" id="panel-queue">
    <div class="table-wrapper">
      <div class="table-toolbar">
        <h3>収集キュー</h3>
        <div class="filter-group">
          <button class="filter-btn active" data-filter="all">すべて</button>
          <button class="filter-btn" data-filter="pending">承認待ち</button>
          <button class="filter-btn" data-filter="approved">承認済み</button>
          <button class="filter-btn" data-filter="skipped">スキップ</button>
        </div>
      </div>
      <div class="table-scroll" id="queueTableScroll">
        <table>
          <thead>
            <tr>
              <th>ステータス</th>
              <th>元ツイート</th>
              <th>生成テキスト</th>
              <th>エンゲージメント</th>
              <th>追加日時</th>
              <th>リンク</th>
            </tr>
          </thead>
          <tbody id="queueTbody">
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- ===== TAB: POSTED ===== -->
  <div class="tab-panel" id="panel-posted">
    <div id="postedList"></div>
  </div>

  <!-- ===== TAB: METRICS ===== -->
  <div class="tab-panel" id="panel-metrics">
    <div class="metrics-chart-area">
      <h3>直近7日間の投稿数推移</h3>
      <div class="chart-container">
        <canvas id="metricsChart"></canvas>
      </div>
    </div>
    <div class="metric-row" id="metricCards"></div>
  </div>

  <!-- ===== TAB: SETTINGS ===== -->
  <div class="tab-panel" id="panel-settings">
    <!-- User Profile -->
    <div class="settings-section">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;">
        <h3>アカウント情報</h3>
        <span class="role-badge client" id="settingsRoleBadge">client</span>
      </div>
      <div style="display:flex;align-items:center;gap:12px;">
        <img class="user-avatar" id="settingsAvatar" src="" alt="" style="width:40px;height:40px;" onerror="this.style.display='none'">
        <div>
          <div style="font-weight:600;" id="settingsName">-</div>
          <div style="font-size:12px;color:var(--text-muted);font-family:var(--font-mono);" id="settingsEmail">-</div>
        </div>
      </div>
    </div>

    <!-- API Keys -->
    <div class="settings-section">
      <h3>APIキー設定</h3>
      <p>各サービスのAPIキーを登録してください。キーはFirestoreにセキュアに保存され、ご自身のみアクセスできます。</p>

      <div class="settings-grid">
        <!-- SocialData API -->
        <div class="form-group">
          <label class="form-label">
            SocialData API Key
            <span class="api-status not-configured" id="statusSocialdata">未設定</span>
          </label>
          <input type="password" class="form-input" id="apiSocialdata" placeholder="sd_xxxxxxxxxxxxxxxx" autocomplete="off">
          <div class="form-hint">SocialData.tools のダッシュボードから取得</div>
        </div>

        <!-- OpenAI API -->
        <div class="form-group">
          <label class="form-label">
            OpenAI API Key
            <span class="api-status not-configured" id="statusOpenai">未設定</span>
          </label>
          <input type="password" class="form-input" id="apiOpenai" placeholder="sk-xxxxxxxxxxxxxxxx" autocomplete="off">
          <div class="form-hint">platform.openai.com から取得</div>
        </div>

        <!-- X API (Bearer Token) -->
        <div class="form-group">
          <label class="form-label">
            X API Bearer Token
            <span class="api-status not-configured" id="statusXapi">未設定</span>
          </label>
          <input type="password" class="form-input" id="apiXbearer" placeholder="AAAAAAAAAAAAAAAAAAAAAxxxxxxx" autocomplete="off">
          <div class="form-hint">developer.x.com から取得</div>
        </div>

        <!-- X API Key -->
        <div class="form-group">
          <label class="form-label">
            X API Key (Consumer Key)
            <span class="api-status not-configured" id="statusXkey">未設定</span>
          </label>
          <input type="password" class="form-input" id="apiXkey" placeholder="xxxxxxxxxxxxxxx" autocomplete="off">
        </div>

        <!-- X API Secret -->
        <div class="form-group">
          <label class="form-label">
            X API Secret (Consumer Secret)
            <span class="api-status not-configured" id="statusXsecret">未設定</span>
          </label>
          <input type="password" class="form-input" id="apiXsecret" placeholder="xxxxxxxxxxxxxxx" autocomplete="off">
        </div>

        <!-- X Access Token -->
        <div class="form-group">
          <label class="form-label">
            X Access Token
            <span class="api-status not-configured" id="statusXaccess">未設定</span>
          </label>
          <input type="password" class="form-input" id="apiXaccess" placeholder="xxxxxxx-xxxxxxxxxxxxxxx" autocomplete="off">
        </div>

        <!-- X Access Token Secret -->
        <div class="form-group">
          <label class="form-label">
            X Access Token Secret
            <span class="api-status not-configured" id="statusXaccessSecret">未設定</span>
          </label>
          <input type="password" class="form-input" id="apiXaccessSecret" placeholder="xxxxxxxxxxxxxxx" autocomplete="off">
        </div>
      </div>

      <button class="save-btn" id="saveApiKeys">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h11l5 5v11a2 2 0 01-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
        保存
      </button>
      <div class="save-msg" id="saveMsg"></div>
    </div>
  </div>
</div>

<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>

<!-- ===== FIREBASE AUTH + FIRESTORE ===== -->
<script>
(function() {
  // ============================
  // Firebase Configuration
  // ============================
  const firebaseConfig = {
    apiKey: "AIzaSyD5qtQwX6w70KmADqJqLngh4uN8G-aZnv8",
    authDomain: "isai-11f7b.firebaseapp.com",
    projectId: "isai-11f7b",
    storageBucket: "isai-11f7b.firebasestorage.app",
    messagingSenderId: "457322161967",
    appId: "1:457322161967:web:132d79d10ac3387b83e3da"
  };

  // ============================
  // Admin UID (あなた) — Firestoreに依存しないフォールバック
  // ============================
  const ADMIN_EMAILS = ['dbeitian@gmail.com'];

  // ============================
  // Initialize Firebase
  // ============================
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  // Expose for settings tab
  window.__fb = { auth, db };

  // DOM Elements
  const overlay = document.getElementById('loginOverlay');
  const appEl = document.querySelector('.app');
  const googleBtn = document.getElementById('googleLoginBtn');
  const xBtn = document.getElementById('xLoginBtn');
  const loginError = document.getElementById('loginError');
  const loginLoading = document.getElementById('loginLoading');

  let currentUser = null;
  let currentUserRole = null;

  // ============================
  // Auth State Listener
  // ============================
  auth.onAuthStateChanged(async (user) => {
    if (user) {
      try {
        // Check/create user doc in Firestore
        const userRef = db.collection('users').doc(user.uid);
        const userDoc = await userRef.get();

        if (!userDoc.exists) {
          // First login — check if admin
          const isAdmin = ADMIN_EMAILS.includes(user.email);
          await userRef.set({
            email: user.email || '',
            displayName: user.displayName || '',
            photoURL: user.photoURL || '',
            provider: user.providerData[0]?.providerId || 'unknown',
            role: isAdmin ? 'admin' : 'client',
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            lastLoginAt: firebase.firestore.FieldValue.serverTimestamp(),
          });
          currentUserRole = isAdmin ? 'admin' : 'client';
        } else {
          const data = userDoc.data();
          currentUserRole = data.role || 'client';
          // Update last login
          userRef.update({
            lastLoginAt: firebase.firestore.FieldValue.serverTimestamp(),
            displayName: user.displayName || data.displayName,
            photoURL: user.photoURL || data.photoURL,
          });
        }

        currentUser = user;

        // Show dashboard
        overlay.style.display = 'none';
        appEl.style.display = 'block';
        addUserInfo(user);
        updateSettingsProfile(user);

        // Load API key status
        loadApiKeyStatus(user.uid);

        // Load dashboard data
        if (typeof initDashboard === 'function') {
          initDashboard();
        }
      } catch (err) {
        console.error('Firestore error:', err);
        // Firestore が未設定でもフォールバック — admin emailならログイン許可
        if (ADMIN_EMAILS.includes(user.email)) {
          currentUser = user;
          currentUserRole = 'admin';
          overlay.style.display = 'none';
          appEl.style.display = 'block';
          addUserInfo(user);
          if (typeof initDashboard === 'function') initDashboard();
        } else {
          showLoginError('アクセス権限の確認に失敗しました。管理者にお問い合わせください。');
          auth.signOut();
        }
      }
    } else {
      // Not authenticated
      currentUser = null;
      currentUserRole = null;
      overlay.style.display = 'flex';
      appEl.style.display = 'none';
      showLoginButtons();
    }
  });

  // ============================
  // Google Login
  // ============================
  googleBtn.addEventListener('click', () => loginWith('google'));

  // ============================
  // X (Twitter) Login
  // ============================
  xBtn.addEventListener('click', () => loginWith('twitter'));

  async function loginWith(providerName) {
    loginError.style.display = 'none';
    hideLoginButtons();
    loginLoading.style.display = 'block';

    try {
      let provider;
      if (providerName === 'google') {
        provider = new firebase.auth.GoogleAuthProvider();
      } else {
        provider = new firebase.auth.TwitterAuthProvider();
      }
      await auth.signInWithPopup(provider);
    } catch (err) {
      if (err.code === 'auth/popup-blocked') {
        try {
          let provider;
          if (providerName === 'google') {
            provider = new firebase.auth.GoogleAuthProvider();
          } else {
            provider = new firebase.auth.TwitterAuthProvider();
          }
          await auth.signInWithRedirect(provider);
          return;
        } catch (redirectErr) {
          showLoginError('ログインに失敗しました: ' + redirectErr.message);
        }
      } else if (err.code === 'auth/account-exists-with-different-credential') {
        showLoginError('このアカウントは別の方法でログイン済みです。Google または X のうち、最初に使った方でログインしてください。');
      } else if (err.code === 'auth/operation-not-allowed') {
        const method = providerName === 'twitter' ? 'X（Twitter）' : 'Google';
        showLoginError(method + ' ログインは現在無効です。管理者が Firebase Console で有効化する必要があります。');
      } else if (err.code === 'auth/cancelled-popup-request') {
        // 複数ポップアップが開かれた場合、無視
      } else if (err.code === 'auth/network-request-failed') {
        showLoginError('ネットワークエラーが発生しました。インターネット接続を確認してください。');
      } else if (err.code !== 'auth/popup-closed-by-user') {
        showLoginError('ログインに失敗しました: ' + err.message);
      }
      showLoginButtons();
      loginLoading.style.display = 'none';
    }
  }

  // ============================
  // Helpers
  // ============================
  function showLoginError(msg) {
    loginError.textContent = msg;
    loginError.style.display = 'block';
    showLoginButtons();
    loginLoading.style.display = 'none';
  }

  function hideLoginButtons() {
    googleBtn.style.display = 'none';
    xBtn.style.display = 'none';
    const divider = document.querySelector('.login-divider');
    if (divider) divider.style.display = 'none';
  }

  function showLoginButtons() {
    googleBtn.style.display = 'inline-flex';
    xBtn.style.display = 'inline-flex';
    const divider = document.querySelector('.login-divider');
    if (divider) divider.style.display = 'flex';
  }

  function addUserInfo(user) {
    const headerRight = document.querySelector('.header-right');
    if (!headerRight || document.getElementById('userInfo')) return;

    const div = document.createElement('div');
    div.id = 'userInfo';
    div.className = 'user-info';

    const photoUrl = user.photoURL || '';
    const displayName = user.displayName || user.email || '';

    div.innerHTML =
      (photoUrl ? '<img class="user-avatar" src="' + photoUrl + '" alt="" onerror="this.style.display=\'none\'">' : '') +
      '<span class="user-name">' + displayName + '</span>' +
      '<button class="logout-btn" id="logoutBtn">ログアウト</button>';

    headerRight.appendChild(div);
    document.getElementById('logoutBtn').addEventListener('click', () => {
      const userInfoEl = document.getElementById('userInfo');
      if (userInfoEl) userInfoEl.remove();
      auth.signOut();
    });
  }

  function updateSettingsProfile(user) {
    const avatar = document.getElementById('settingsAvatar');
    const name = document.getElementById('settingsName');
    const email = document.getElementById('settingsEmail');
    const badge = document.getElementById('settingsRoleBadge');

    if (avatar) avatar.src = user.photoURL || '';
    if (name) name.textContent = user.displayName || user.email || '-';
    if (email) email.textContent = user.email || user.uid;
    if (badge) {
      badge.textContent = currentUserRole || 'client';
      badge.className = 'role-badge ' + (currentUserRole === 'admin' ? 'admin' : 'client');
    }
  }

  // ============================
  // API Key Management
  // ============================
  const API_KEY_FIELDS = [
    { id: 'apiSocialdata', key: 'socialdata_api_key', statusId: 'statusSocialdata' },
    { id: 'apiOpenai', key: 'openai_api_key', statusId: 'statusOpenai' },
    { id: 'apiXbearer', key: 'x_bearer_token', statusId: 'statusXapi' },
    { id: 'apiXkey', key: 'x_api_key', statusId: 'statusXkey' },
    { id: 'apiXsecret', key: 'x_api_secret', statusId: 'statusXsecret' },
    { id: 'apiXaccess', key: 'x_access_token', statusId: 'statusXaccess' },
    { id: 'apiXaccessSecret', key: 'x_access_token_secret', statusId: 'statusXaccessSecret' },
  ];

  async function loadApiKeyStatus(uid) {
    try {
      const doc = await db.collection('api_keys').doc(uid).get();
      if (doc.exists) {
        const data = doc.data();
        API_KEY_FIELDS.forEach(f => {
          const statusEl = document.getElementById(f.statusId);
          if (statusEl) {
            if (data[f.key]) {
              statusEl.textContent = '設定済み';
              statusEl.className = 'api-status configured';
            } else {
              statusEl.textContent = '未設定';
              statusEl.className = 'api-status not-configured';
            }
          }
        });
      }
    } catch (err) {
      console.warn('API key status load failed:', err);
    }
  }

  // Save API Keys
  const saveBtn = document.getElementById('saveApiKeys');
  const saveMsg = document.getElementById('saveMsg');

  if (saveBtn) {
    saveBtn.addEventListener('click', async () => {
      if (!currentUser) return;
      saveBtn.disabled = true;
      saveMsg.className = 'save-msg';
      saveMsg.style.display = 'none';

      try {
        const updates = {};
        let hasUpdate = false;

        API_KEY_FIELDS.forEach(f => {
          const input = document.getElementById(f.id);
          if (input && input.value.trim()) {
            updates[f.key] = input.value.trim();
            hasUpdate = true;
          }
        });

        if (!hasUpdate) {
          saveMsg.textContent = '変更するキーを入力してください';
          saveMsg.className = 'save-msg error';
          saveBtn.disabled = false;
          return;
        }

        updates.updatedAt = firebase.firestore.FieldValue.serverTimestamp();
        updates.uid = currentUser.uid;

        await db.collection('api_keys').doc(currentUser.uid).set(updates, { merge: true });

        // Clear inputs & refresh status
        API_KEY_FIELDS.forEach(f => {
          const input = document.getElementById(f.id);
          if (input) input.value = '';
        });

        await loadApiKeyStatus(currentUser.uid);

        saveMsg.textContent = 'APIキーを保存しました';
        saveMsg.className = 'save-msg success';
      } catch (err) {
        console.error('Save API keys error:', err);
        saveMsg.textContent = '保存に失敗しました: ' + err.message;
        saveMsg.className = 'save-msg error';
      }

      saveBtn.disabled = false;
    });
  }
})();
</script>

<script>
/* ===========================================
   DASHBOARD APP
   =========================================== */

const DATA_URL = './dashboard-data.json';
let currentFilter = 'all';
let dashboardData = null;
let metricsChartInstance = null;
let dashboardInitialized = false;

// --- Init (called by auth after login) ---
function initDashboard() {
  if (dashboardInitialized) return;
  dashboardInitialized = true;
  initTabs();
  initFilters();
  loadData();
}

// --- Tab switching ---
function initTabs() {
  document.querySelectorAll('.tab').forEach(tab => {
    tab.addEventListener('click', () => {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
      tab.classList.add('active');
      document.getElementById('panel-' + tab.dataset.tab).classList.add('active');
    });
  });
}

// --- Filter buttons ---
function initFilters() {
  document.querySelectorAll('.filter-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      currentFilter = btn.dataset.filter;
      renderQueue();
    });
  });
}

// --- Load data ---
async function loadData() {
  const container = document.getElementById('queueTbody');
  container.innerHTML = '<tr><td colspan="6"><div class="loading"><div class="spinner"></div><div class="loading-text">データを読み込み中...</div></div></td></tr>';

  try {
    const res = await fetch(DATA_URL);
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    dashboardData = await res.json();
    render();
  } catch (err) {
    container.innerHTML = `<tr><td colspan="6">
      <div class="error-state">
        <svg class="empty-state-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z"/></svg>
        <h3>データの読み込みに失敗しました</h3>
        <p>dashboard-data.json が見つかりません。以下のコマンドでデータを生成してください:</p>
        <code>python -m src.main export-dashboard</code>
      </div>
    </td></tr>`;
  }
}

// --- Render all ---
function render() {
  if (!dashboardData) return;
  renderKPI();
  renderQueue();
  renderPosted();
  renderMetrics();
  renderUpdatedTime();
}

// --- KPI ---
function renderKPI() {
  const s = dashboardData.stats;
  document.getElementById('kpiPending').textContent = s.pending ?? 0;
  document.getElementById('kpiApproved').textContent = s.approved ?? 0;
  document.getElementById('kpiPostedToday').textContent = s.posted_today ?? 0;
  document.getElementById('kpiPostedTotal').textContent = s.posted_total ?? 0;
  document.getElementById('kpiSkipped').textContent = s.skipped ?? 0;
}

// --- Queue table ---
function renderQueue() {
  const tbody = document.getElementById('queueTbody');
  if (!dashboardData || !dashboardData.queue) {
    tbody.innerHTML = '<tr><td colspan="6"><div class="empty-state"><svg class="empty-state-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M21.75 6.75v10.5a2.25 2.25 0 01-2.25 2.25h-15a2.25 2.25 0 01-2.25-2.25V6.75m19.5 0A2.25 2.25 0 0019.5 4.5h-15a2.25 2.25 0 00-2.25 2.25m19.5 0v.243a2.25 2.25 0 01-1.07 1.916l-7.5 4.615a2.25 2.25 0 01-2.36 0L3.32 8.91a2.25 2.25 0 01-1.07-1.916V6.75"/></svg><h3>キューが空です</h3><p>collectコマンドでバズツイートを収集してください</p></div></td></tr>';
    return;
  }

  let items = dashboardData.queue;
  if (currentFilter !== 'all') {
    items = items.filter(i => i.status === currentFilter);
  }

  if (items.length === 0) {
    tbody.innerHTML = `<tr><td colspan="6"><div class="empty-state"><svg class="empty-state-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z"/></svg><h3>該当するアイテムがありません</h3></div></td></tr>`;
    return;
  }

  // Sort: pending first, then approved, then others
  const order = { pending: 0, approved: 1, skipped: 2 };
  items = [...items].sort((a, b) => (order[a.status] ?? 9) - (order[b.status] ?? 9));

  tbody.innerHTML = items.map(item => {
    const statusClass = `status-${item.status}`;
    const statusLabel = { pending: '承認待ち', approved: '承認済み', skipped: 'スキップ', generated: '生成済み' }[item.status] || item.status;

    const originalText = item.original_text || item.text || '-';
    const generatedText = item.generated_text || '';
    const tweetId = item.tweet_id || '';
    const tweetUrl = tweetId ? `https://x.com/i/status/${tweetId}` : '#';

    const likes = item.likes ?? item.favorite_count ?? '-';
    const rts = item.retweets ?? item.retweet_count ?? '-';
    const addedAt = item.added_at ? formatTime(item.added_at) : '-';

    return `<tr>
      <td><span class="status ${statusClass}">${statusLabel}</span></td>
      <td><div class="tweet-text" title="${escapeHtml(originalText)}">${escapeHtml(truncate(originalText, 60))}</div></td>
      <td><div class="tweet-text ${generatedText ? 'generated' : ''}" title="${escapeHtml(generatedText)}">${generatedText ? escapeHtml(truncate(generatedText, 50)) : '<span style="color:var(--text-muted)">未生成</span>'}</div></td>
      <td><div class="tweet-metrics"><span><svg width="13" height="13" viewBox="0 0 24 24" fill="currentColor" style="vertical-align:-2px;opacity:0.7"><path d="M11.645 20.91l-.007-.003-.022-.012a15.247 15.247 0 01-.383-.218 25.18 25.18 0 01-4.244-3.17C4.688 15.36 2.25 12.174 2.25 8.25 2.25 5.322 4.714 3 7.688 3A5.5 5.5 0 0112 5.052 5.5 5.5 0 0116.313 3c2.973 0 5.437 2.322 5.437 5.25 0 3.925-2.438 7.111-4.739 9.256a25.175 25.175 0 01-4.244 3.17 15.247 15.247 0 01-.383.219l-.022.012-.007.004-.003.001a.752.752 0 01-.704 0l-.003-.001z"/></svg> ${formatNum(likes)}</span><span><svg width="13" height="13" viewBox="0 0 24 24" fill="currentColor" style="vertical-align:-2px;opacity:0.7"><path d="M19.902 4.098a3.75 3.75 0 00-5.304 0l-4.5 4.5a3.75 3.75 0 001.035 6.037.75.75 0 01-.646 1.353 5.25 5.25 0 01-1.449-8.45l4.5-4.5a5.25 5.25 0 117.424 7.424l-1.757 1.757a.75.75 0 11-1.06-1.06l1.757-1.757a3.75 3.75 0 000-5.304zm-7.389 4.267a.75.75 0 011-.353 5.25 5.25 0 011.449 8.45l-4.5 4.5a5.25 5.25 0 11-7.424-7.424l1.757-1.757a.75.75 0 111.06 1.06l-1.757 1.757a3.75 3.75 0 105.304 5.304l4.5-4.5a3.75 3.75 0 00-1.035-6.037.75.75 0 01-.354-1z"/></svg> ${formatNum(rts)}</span></div></td>
      <td><span class="tweet-meta">${addedAt}</span></td>
      <td>${tweetId ? `<a class="external-link" href="${tweetUrl}" target="_blank" rel="noopener">元ツイート ↗</a>` : '-'}</td>
    </tr>`;
  }).join('');
}

// --- Posted history ---
function renderPosted() {
  const container = document.getElementById('postedList');
  const posted = dashboardData.recent_posted;

  if (!posted || posted.length === 0) {
    container.innerHTML = '<div class="empty-state"><svg class="empty-state-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M6 12L3.269 3.126A59.768 59.768 0 0121.485 12 59.77 59.77 0 013.27 20.876L5.999 12zm0 0h7.5"/></svg><h3>投稿履歴がありません</h3><p>引用RT投稿が完了すると、ここに表示されます</p></div>';
    return;
  }

  container.innerHTML = posted.map(item => {
    const postedAt = item.posted_at ? formatTime(item.posted_at) : '-';
    const text = item.generated_text || item.text || '-';
    const tweetId = item.tweet_id || '';
    const postedTweetId = item.posted_tweet_id || '';
    const originalUrl = tweetId ? `https://x.com/i/status/${tweetId}` : '';
    const postedUrl = postedTweetId ? `https://x.com/i/status/${postedTweetId}` : '';

    return `<div class="posted-card">
      <div class="posted-header">
        <span class="status status-posted">投稿済み</span>
        <span class="posted-time">${postedAt}</span>
      </div>
      <div class="posted-body">${escapeHtml(text)}</div>
      <div class="posted-source">
        ${originalUrl ? `<a class="external-link" href="${originalUrl}" target="_blank" rel="noopener">元ツイート ↗</a>` : ''}
        ${postedUrl ? `<a class="external-link" href="${postedUrl}" target="_blank" rel="noopener">投稿ツイート ↗</a>` : ''}
      </div>
    </div>`;
  }).join('');
}

// --- Metrics ---
function renderMetrics() {
  const metrics = dashboardData.metrics;

  // Metric summary cards
  const container = document.getElementById('metricCards');
  if (!metrics || metrics.length === 0) {
    container.innerHTML = '<div class="empty-state" style="grid-column:1/-1;"><svg class="empty-state-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M3 13.125C3 12.504 3.504 12 4.125 12h2.25c.621 0 1.125.504 1.125 1.125v6.75C7.5 20.496 6.996 21 6.375 21h-2.25A1.125 1.125 0 013 19.875v-6.75zM9.75 8.625c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125v11.25c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V8.625zM16.5 4.125c0-.621.504-1.125 1.125-1.125h2.25C20.496 3 21 3.504 21 4.125v15.75c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V4.125z"/></svg><h3>メトリクスデータがありません</h3><p>metricsコマンドで収集できます</p></div>';
    renderEmptyChart();
    return;
  }

  // Aggregate latest metrics
  const latest = metrics[0] || {};
  const summary = latest.summary || latest;

  const cards = [
    { label: 'いいね合計', value: summary.total_likes ?? summary.likes ?? '-', color: 'var(--accent-red)' },
    { label: 'RT合計', value: summary.total_retweets ?? summary.retweets ?? '-', color: 'var(--accent-green)' },
    { label: 'インプレッション', value: summary.total_impressions ?? summary.impressions ?? '-', color: 'var(--accent-blue)' },
    { label: '平均エンゲージメント率', value: summary.avg_engagement_rate != null ? (summary.avg_engagement_rate * 100).toFixed(2) + '%' : '-', color: 'var(--accent-purple)' },
  ];

  container.innerHTML = cards.map(c => `
    <div class="metric-item">
      <div class="metric-item-label">${c.label}</div>
      <div class="metric-item-value" style="color:${c.color}">${typeof c.value === 'number' ? formatNum(c.value) : c.value}</div>
    </div>
  `).join('');

  // Chart
  renderChart(metrics);
}

function renderChart(metrics) {
  const ctx = document.getElementById('metricsChart');
  if (!ctx) return;

  if (metricsChartInstance) {
    metricsChartInstance.destroy();
  }

  const labels = metrics.map(m => {
    const d = m.date || m.collected_at || '';
    return d.substring(5, 10); // MM-DD
  }).reverse();

  const postCounts = metrics.map(m => {
    const s = m.summary || m;
    return s.tweet_count ?? s.post_count ?? 0;
  }).reverse();

  const likeCounts = metrics.map(m => {
    const s = m.summary || m;
    return s.total_likes ?? s.likes ?? 0;
  }).reverse();

  metricsChartInstance = new Chart(ctx, {
    type: 'bar',
    data: {
      labels,
      datasets: [
        {
          label: '投稿数',
          data: postCounts,
          backgroundColor: 'rgba(29,161,242,0.6)',
          borderColor: 'rgba(29,161,242,1)',
          borderWidth: 1,
          borderRadius: 4,
          yAxisID: 'y',
        },
        {
          label: 'いいね数',
          data: likeCounts,
          type: 'line',
          borderColor: 'rgba(239,68,68,0.8)',
          backgroundColor: 'rgba(239,68,68,0.1)',
          borderWidth: 2,
          pointRadius: 3,
          fill: true,
          tension: 0.3,
          yAxisID: 'y1',
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: { mode: 'index', intersect: false },
      plugins: {
        legend: {
          labels: { color: '#8888a0', font: { size: 11 } }
        }
      },
      scales: {
        x: {
          ticks: { color: '#5a5a70', font: { size: 11 } },
          grid: { color: 'rgba(42,42,58,0.5)' }
        },
        y: {
          position: 'left',
          ticks: { color: '#5a5a70', font: { size: 11 }, stepSize: 1 },
          grid: { color: 'rgba(42,42,58,0.5)' },
          title: { display: true, text: '投稿数', color: '#8888a0', font: { size: 11 } }
        },
        y1: {
          position: 'right',
          ticks: { color: '#5a5a70', font: { size: 11 } },
          grid: { drawOnChartArea: false },
          title: { display: true, text: 'いいね', color: '#8888a0', font: { size: 11 } }
        }
      }
    }
  });
}

function renderEmptyChart() {
  const ctx = document.getElementById('metricsChart');
  if (!ctx) return;
  if (metricsChartInstance) metricsChartInstance.destroy();

  metricsChartInstance = new Chart(ctx, {
    type: 'bar',
    data: { labels: ['---'], datasets: [{ label: '投稿数', data: [0], backgroundColor: 'rgba(29,161,242,0.3)' }] },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { display: false } },
      scales: {
        x: { ticks: { color: '#5a5a70' }, grid: { color: 'rgba(42,42,58,0.5)' } },
        y: { ticks: { color: '#5a5a70' }, grid: { color: 'rgba(42,42,58,0.5)' } }
      }
    }
  });
}

// --- Updated time ---
function renderUpdatedTime() {
  const el = document.getElementById('lastUpdated');
  const badge = document.getElementById('statusBadge');
  if (!dashboardData.updated_at) {
    el.textContent = '--';
    return;
  }

  const updated = new Date(dashboardData.updated_at);
  const now = new Date();
  const diffMin = Math.floor((now - updated) / 60000);

  el.textContent = formatTime(dashboardData.updated_at);

  if (diffMin > 120) {
    badge.className = 'badge badge-stale';
    badge.textContent = 'STALE';
  } else {
    badge.className = 'badge badge-live';
    badge.textContent = 'LIVE';
  }
}

// --- Helpers ---
function formatTime(isoStr) {
  try {
    const d = new Date(isoStr);
    return d.toLocaleString('ja-JP', {
      month: '2-digit', day: '2-digit',
      hour: '2-digit', minute: '2-digit'
    });
  } catch { return isoStr; }
}

function formatNum(n) {
  if (n == null || n === '-') return '-';
  const num = Number(n);
  if (isNaN(num)) return n;
  if (num >= 10000) return (num / 10000).toFixed(1) + '万';
  if (num >= 1000) return (num / 1000).toFixed(1) + 'k';
  return num.toLocaleString();
}

function truncate(str, len) {
  if (!str) return '';
  return str.length > len ? str.slice(0, len) + '...' : str;
}

function escapeHtml(str) {
  if (!str) return '';
  const d = document.createElement('div');
  d.textContent = str;
  return d.innerHTML;
}
</script>
</body>
</html>
