<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>X å¼•ç”¨RTè‡ªå‹•æŠ•ç¨¿ â€” ã‚­ãƒ¥ãƒ¼ç®¡ç†ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</title>
<style>
/* ===========================================
   CSS CUSTOM PROPERTIES
   =========================================== */
:root {
  --bg-primary: #06060b;
  --bg-secondary: #0c0c14;
  --bg-card: #111119;
  --bg-card-hover: #16161f;
  --bg-input: #1a1a28;
  --border: #1f1f30;
  --border-hover: #2e2e48;
  --text-primary: #eeeef2;
  --text-secondary: #8b8ba8;
  --text-muted: #555570;
  --accent-blue: #3b82f6;
  --accent-blue-dim: rgba(59,130,246,0.12);
  --accent-blue-glow: rgba(59,130,246,0.25);
  --accent-green: #10b981;
  --accent-green-dim: rgba(16,185,129,0.12);
  --accent-amber: #f59e0b;
  --accent-amber-dim: rgba(245,158,11,0.12);
  --accent-red: #ef4444;
  --accent-red-dim: rgba(239,68,68,0.12);
  --accent-purple: #8b5cf6;
  --accent-purple-dim: rgba(139,92,246,0.12);
  --radius: 14px;
  --radius-sm: 10px;
  --font-sans: "Inter", "Noto Sans JP", -apple-system, BlinkMacSystemFont, sans-serif;
  --font-mono: "Fira Code", "JetBrains Mono", "SF Mono", monospace;
  --shadow-sm: 0 1px 3px rgba(0,0,0,0.4);
  --shadow: 0 4px 24px rgba(0,0,0,0.4);
  --shadow-lg: 0 8px 40px rgba(0,0,0,0.5);
  --transition-fast: 150ms cubic-bezier(0.4, 0, 0.2, 1);
  --transition-base: 250ms cubic-bezier(0.4, 0, 0.2, 1);
}

/* ===========================================
   RESET & BASE
   =========================================== */
*, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

body {
  font-family: var(--font-sans);
  background: var(--bg-primary);
  color: var(--text-primary);
  line-height: 1.6;
  min-height: 100vh;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

@media (prefers-reduced-motion: reduce) {
  *, *::before, *::after {
    animation-duration: 0.01ms !important;
    transition-duration: 0.01ms !important;
  }
}

/* ===========================================
   LAYOUT
   =========================================== */
.app {
  max-width: 1320px;
  margin: 0 auto;
  padding: 28px 24px 64px;
  opacity: 0;
  animation: fadeIn 0.4s ease forwards;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(8px); }
  to { opacity: 1; transform: translateY(0); }
}

.header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 36px;
  flex-wrap: wrap;
  gap: 16px;
}

.header-left {
  display: flex;
  align-items: center;
  gap: 14px;
}

.header-logo {
  width: 40px;
  height: 40px;
  background: var(--accent-blue);
  border-radius: 11px;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
  box-shadow: 0 0 20px var(--accent-blue-glow);
}

.header-logo svg {
  width: 20px;
  height: 20px;
  fill: #fff;
}

.header h1 {
  font-size: 20px;
  font-weight: 700;
  letter-spacing: -0.025em;
}

.header h1 span {
  color: var(--text-muted);
  font-weight: 500;
  font-size: 13px;
  margin-left: 10px;
  padding: 2px 8px;
  background: var(--bg-input);
  border-radius: 6px;
  letter-spacing: 0;
}

.header-right {
  display: flex;
  align-items: center;
  gap: 12px;
}

.badge {
  font-size: 11px;
  padding: 4px 10px;
  border-radius: 20px;
  font-weight: 600;
  letter-spacing: 0.04em;
  text-transform: uppercase;
}

.badge-live {
  background: var(--accent-green-dim);
  color: var(--accent-green);
  box-shadow: 0 0 12px rgba(16,185,129,0.15);
}
.badge-stale { background: var(--accent-amber-dim); color: var(--accent-amber); }

.last-updated {
  font-size: 12px;
  color: var(--text-muted);
  font-family: var(--font-mono);
  font-variant-numeric: tabular-nums;
}

/* ===========================================
   TABS
   =========================================== */
.tabs {
  display: flex;
  gap: 2px;
  margin-bottom: 28px;
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  padding: 4px;
  overflow-x: auto;
  width: fit-content;
}

.tab {
  padding: 9px 20px;
  font-size: 13px;
  font-weight: 500;
  color: var(--text-secondary);
  cursor: pointer;
  border: none;
  background: none;
  border-radius: 7px;
  transition: color var(--transition-fast), background var(--transition-fast);
  white-space: nowrap;
  font-family: var(--font-sans);
}

.tab:hover { color: var(--text-primary); background: var(--bg-input); }
.tab.active {
  color: #fff;
  background: var(--accent-blue);
  box-shadow: 0 2px 8px rgba(59,130,246,0.3);
}

/* ===========================================
   KPI CARDS
   =========================================== */
.kpi-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 14px;
  margin-bottom: 32px;
}

.kpi-card {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 22px 24px;
  transition: border-color var(--transition-fast), box-shadow var(--transition-fast);
  cursor: default;
  position: relative;
  overflow: hidden;
}

.kpi-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 2px;
  opacity: 0;
  transition: opacity var(--transition-fast);
}

.kpi-card:hover {
  border-color: var(--border-hover);
  box-shadow: var(--shadow-sm);
}

.kpi-card:hover::before { opacity: 1; }

.kpi-card:nth-child(1)::before { background: var(--accent-amber); }
.kpi-card:nth-child(2)::before { background: var(--accent-blue); }
.kpi-card:nth-child(3)::before { background: var(--accent-green); }
.kpi-card:nth-child(4)::before { background: var(--accent-purple); }
.kpi-card:nth-child(5)::before { background: var(--accent-red); }

.kpi-label {
  font-size: 12px;
  color: var(--text-secondary);
  font-weight: 500;
  letter-spacing: 0.02em;
  margin-bottom: 10px;
}

.kpi-value {
  font-size: 34px;
  font-weight: 700;
  letter-spacing: -0.03em;
  font-family: var(--font-mono);
  font-variant-numeric: tabular-nums;
  line-height: 1.1;
}

.kpi-value.blue { color: var(--accent-blue); }
.kpi-value.green { color: var(--accent-green); }
.kpi-value.amber { color: var(--accent-amber); }
.kpi-value.purple { color: var(--accent-purple); }
.kpi-value.red { color: var(--accent-red); }

.kpi-sub {
  font-size: 11px;
  color: var(--text-muted);
  margin-top: 6px;
  font-family: var(--font-mono);
  font-variant-numeric: tabular-nums;
}

/* ===========================================
   TAB PANELS
   =========================================== */
.tab-panel { display: none; }
.tab-panel.active { display: block; }

/* ===========================================
   DATA TABLE
   =========================================== */
.table-wrapper {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  overflow: hidden;
  box-shadow: var(--shadow-sm);
}

.table-toolbar {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 16px 20px;
  border-bottom: 1px solid var(--border);
  flex-wrap: wrap;
  gap: 12px;
}

.table-toolbar h3 {
  font-size: 14px;
  font-weight: 600;
}

.filter-group {
  display: flex;
  gap: 6px;
}

.filter-btn {
  font-size: 12px;
  padding: 6px 14px;
  border-radius: 7px;
  border: 1px solid var(--border);
  background: transparent;
  color: var(--text-secondary);
  cursor: pointer;
  transition: all var(--transition-fast);
  font-family: var(--font-sans);
  font-weight: 500;
}

.filter-btn:hover { border-color: var(--border-hover); color: var(--text-primary); background: var(--bg-input); }
.filter-btn.active {
  background: var(--accent-blue);
  border-color: var(--accent-blue);
  color: #fff;
  box-shadow: 0 2px 8px rgba(59,130,246,0.25);
}

table {
  width: 100%;
  border-collapse: collapse;
}

th, td {
  text-align: left;
  padding: 13px 20px;
  font-size: 13px;
  border-bottom: 1px solid var(--border);
}

th {
  font-size: 11px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.06em;
  color: var(--text-muted);
  background: var(--bg-secondary);
  position: sticky;
  top: 0;
  z-index: 10;
}

tr:last-child td { border-bottom: none; }

tr { transition: background var(--transition-fast); }
tr:hover td { background: var(--bg-card-hover); }

.table-scroll {
  max-height: 520px;
  overflow-y: auto;
}

/* Scrollbar */
.table-scroll::-webkit-scrollbar { width: 6px; }
.table-scroll::-webkit-scrollbar-track { background: var(--bg-card); }
.table-scroll::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

/* Status badge in table */
.status {
  display: inline-flex;
  align-items: center;
  gap: 5px;
  font-size: 12px;
  padding: 3px 10px;
  border-radius: 20px;
  font-weight: 600;
}

.status-pending { background: var(--accent-amber-dim); color: var(--accent-amber); }
.status-approved { background: var(--accent-blue-dim); color: var(--accent-blue); }
.status-generated { background: var(--accent-purple-dim); color: var(--accent-purple); }
.status-posted { background: var(--accent-green-dim); color: var(--accent-green); }
.status-skipped { background: var(--accent-red-dim); color: var(--accent-red); }

.tweet-text {
  max-width: 400px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  color: var(--text-secondary);
  font-size: 12px;
}

.tweet-text.generated {
  color: var(--text-primary);
  font-weight: 500;
}

.tweet-meta {
  font-size: 11px;
  color: var(--text-muted);
  font-family: var(--font-mono);
}

.tweet-metrics {
  display: flex;
  gap: 10px;
  font-size: 11px;
  color: var(--text-secondary);
  font-family: var(--font-mono);
}

.tweet-metrics span { white-space: nowrap; }

.external-link {
  color: var(--accent-blue);
  text-decoration: none;
  font-size: 12px;
  font-weight: 500;
  transition: color var(--transition-fast);
}
.external-link:hover { color: #60a5fa; }
.external-link:focus-visible { outline: 2px solid var(--accent-blue); outline-offset: 2px; border-radius: 2px; }

/* ===========================================
   POSTED HISTORY CARD
   =========================================== */
.posted-card {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 20px 22px;
  margin-bottom: 12px;
  transition: border-color var(--transition-fast), box-shadow var(--transition-fast);
}

.posted-card:hover {
  border-color: var(--border-hover);
  box-shadow: var(--shadow-sm);
}

.posted-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 12px;
}

.posted-time {
  font-size: 12px;
  color: var(--text-muted);
  font-family: var(--font-mono);
  font-variant-numeric: tabular-nums;
}

.posted-body {
  font-size: 14px;
  line-height: 1.75;
  margin-bottom: 14px;
  color: var(--text-primary);
}

.posted-source {
  font-size: 12px;
  color: var(--text-secondary);
  display: flex;
  align-items: center;
  gap: 12px;
  padding-top: 12px;
  border-top: 1px solid var(--border);
}

/* ===========================================
   METRICS PANEL
   =========================================== */
.metrics-chart-area {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 24px;
  margin-bottom: 20px;
  box-shadow: var(--shadow-sm);
}

.metrics-chart-area h3 {
  font-size: 14px;
  font-weight: 600;
  margin-bottom: 20px;
}

.chart-container {
  position: relative;
  height: 260px;
}

.metric-row {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 14px;
  margin-bottom: 20px;
}

.metric-item {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  padding: 18px 20px;
  transition: border-color var(--transition-fast);
}

.metric-item:hover { border-color: var(--border-hover); }

.metric-item-label {
  font-size: 12px;
  color: var(--text-secondary);
  margin-bottom: 6px;
  font-weight: 500;
}

.metric-item-value {
  font-size: 24px;
  font-weight: 700;
  font-family: var(--font-mono);
  font-variant-numeric: tabular-nums;
}

/* ===========================================
   EMPTY STATE
   =========================================== */
.empty-state {
  text-align: center;
  padding: 64px 24px;
  color: var(--text-muted);
}

.empty-state-icon {
  width: 48px;
  height: 48px;
  margin: 0 auto 16px;
  color: var(--text-muted);
  opacity: 0.4;
}

.empty-state h3 {
  font-size: 15px;
  color: var(--text-secondary);
  margin-bottom: 8px;
  font-weight: 600;
}

.empty-state p {
  font-size: 13px;
  max-width: 400px;
  margin: 0 auto;
  line-height: 1.7;
}

/* ===========================================
   LOADING
   =========================================== */
.loading {
  text-align: center;
  padding: 80px 24px;
}

.spinner {
  width: 28px;
  height: 28px;
  border: 2.5px solid var(--border);
  border-top-color: var(--accent-blue);
  border-radius: 50%;
  animation: spin 0.7s linear infinite;
  margin: 0 auto 16px;
}

@keyframes spin { to { transform: rotate(360deg); } }

.loading-text {
  font-size: 13px;
  color: var(--text-muted);
}

/* ===========================================
   ERROR STATE
   =========================================== */
.error-state {
  text-align: center;
  padding: 64px 24px;
  color: var(--accent-red);
}

.error-state h3 { margin-bottom: 8px; font-size: 15px; }

.error-state p {
  font-size: 13px;
  color: var(--text-secondary);
  max-width: 500px;
  margin: 0 auto 16px;
  line-height: 1.7;
}

.error-state code {
  background: var(--bg-input);
  padding: 10px 18px;
  border-radius: 8px;
  font-size: 12px;
  display: inline-block;
  font-family: var(--font-mono);
  color: var(--text-secondary);
  border: 1px solid var(--border);
}

/* ===========================================
   TOOLTIP
   =========================================== */
.tooltip-trigger {
  position: relative;
  cursor: help;
}

.tooltip-trigger:hover::after {
  content: attr(data-tooltip);
  position: absolute;
  bottom: 100%;
  left: 50%;
  transform: translateX(-50%);
  background: var(--bg-input);
  border: 1px solid var(--border);
  color: var(--text-primary);
  font-size: 12px;
  padding: 6px 10px;
  border-radius: 6px;
  white-space: nowrap;
  z-index: 100;
  box-shadow: var(--shadow);
}

/* ===========================================
   RESPONSIVE
   =========================================== */
@media (max-width: 768px) {
  .app { padding: 16px 14px 48px; }
  .header { margin-bottom: 24px; }
  .header h1 { font-size: 16px; }
  .header h1 span { font-size: 11px; margin-left: 6px; padding: 1px 6px; }
  .kpi-grid { grid-template-columns: repeat(2, 1fr); gap: 10px; }
  .kpi-card { padding: 16px; }
  .kpi-value { font-size: 26px; }
  th, td { padding: 10px 14px; font-size: 12px; }
  .tweet-text { max-width: 200px; }
  .login-card { padding: 32px 24px; border-radius: 16px; }
  .login-title { font-size: 20px; }
}

@media (max-width: 480px) {
  .kpi-grid { grid-template-columns: 1fr 1fr; }
  .tabs { width: 100%; }
  .tab { padding: 8px 14px; font-size: 12px; flex: 1; text-align: center; }
  .filter-group { flex-wrap: wrap; }
}

/* ===========================================
   LOGIN OVERLAY
   =========================================== */
.login-overlay {
  position: fixed;
  inset: 0;
  z-index: 9999;
  background: var(--bg-primary);
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
}

.login-overlay::before {
  content: '';
  position: absolute;
  top: -40%;
  left: -20%;
  width: 600px;
  height: 600px;
  background: radial-gradient(circle, rgba(59,130,246,0.06) 0%, transparent 70%);
  border-radius: 50%;
  pointer-events: none;
}

.login-overlay::after {
  content: '';
  position: absolute;
  bottom: -30%;
  right: -10%;
  width: 500px;
  height: 500px;
  background: radial-gradient(circle, rgba(139,92,246,0.05) 0%, transparent 70%);
  border-radius: 50%;
  pointer-events: none;
}

.login-card {
  text-align: center;
  padding: 48px 40px;
  position: relative;
  z-index: 1;
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 20px;
  box-shadow: var(--shadow-lg);
  max-width: 400px;
  width: calc(100% - 40px);
}

.login-logo {
  width: 56px;
  height: 56px;
  margin: 0 auto 28px;
  background: var(--accent-blue);
  border-radius: 14px;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 0 30px var(--accent-blue-glow);
}

.login-logo svg {
  width: 26px;
  height: 26px;
  fill: #fff;
}

.login-title {
  font-size: 22px;
  font-weight: 700;
  color: var(--text-primary);
  margin-bottom: 8px;
  letter-spacing: -0.02em;
}

.login-subtitle {
  font-size: 14px;
  color: var(--text-secondary);
  margin-bottom: 32px;
  line-height: 1.6;
}

.login-error {
  color: var(--accent-red);
  font-size: 13px;
  margin-top: 20px;
  display: none;
  max-width: 360px;
  margin-left: auto;
  margin-right: auto;
  line-height: 1.6;
}

.login-loading {
  display: none;
  margin-top: 24px;
}

/* User Info in header */
.user-info {
  display: flex;
  align-items: center;
  gap: 10px;
}

.user-avatar {
  width: 28px;
  height: 28px;
  border-radius: 50%;
  border: 2px solid var(--border);
}

.user-name {
  font-size: 13px;
  color: var(--text-secondary);
  font-weight: 500;
}

.logout-btn {
  font-size: 12px;
  padding: 5px 12px;
  border-radius: 7px;
  border: 1px solid var(--border);
  background: transparent;
  color: var(--text-muted);
  cursor: pointer;
  font-family: var(--font-sans);
  font-weight: 500;
  transition: border-color var(--transition-fast), color var(--transition-fast), background var(--transition-fast);
}

.logout-btn:hover {
  border-color: var(--accent-red);
  color: var(--accent-red);
  background: var(--accent-red-dim);
}

/* X (Twitter) Login Button */
.x-login-btn {
  display: inline-flex;
  align-items: center;
  gap: 12px;
  padding: 13px 28px;
  border-radius: var(--radius-sm);
  background: #000;
  color: #fff;
  border: 1px solid #333;
  font-size: 14px;
  font-weight: 600;
  font-family: var(--font-sans);
  cursor: pointer;
  transition: box-shadow var(--transition-fast), transform var(--transition-fast), border-color var(--transition-fast);
  width: 100%;
  justify-content: center;
  margin-top: 10px;
}

.x-login-btn:hover {
  box-shadow: 0 4px 24px rgba(255,255,255,0.08);
  transform: translateY(-1px);
  border-color: #555;
}

.x-login-btn:active { transform: translateY(0); }

.x-login-btn:focus-visible {
  outline: 2px solid var(--accent-blue);
  outline-offset: 2px;
}

.x-login-btn svg {
  width: 18px;
  height: 18px;
  fill: #fff;
}

/* ===========================================
   QUEUE DETAIL MODAL
   =========================================== */
.modal-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.7);
  backdrop-filter: blur(6px);
  z-index: 1000;
  display: none;
  align-items: center;
  justify-content: center;
  padding: 24px;
  animation: fadeIn 0.2s ease;
}
.modal-overlay.show { display: flex; }

.modal-card {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  max-width: 820px;
  width: 100%;
  max-height: 90vh;
  overflow-y: auto;
  box-shadow: var(--shadow-lg);
}

.modal-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 20px 24px;
  border-bottom: 1px solid var(--border);
  position: sticky;
  top: 0;
  background: var(--bg-card);
  z-index: 1;
}

.modal-header h3 {
  font-size: 16px;
  font-weight: 600;
}

.modal-close {
  background: none;
  border: none;
  color: var(--text-muted);
  font-size: 22px;
  cursor: pointer;
  padding: 4px 8px;
  border-radius: 6px;
  transition: background var(--transition-fast), color var(--transition-fast);
}
.modal-close:hover { background: var(--bg-input); color: var(--text-primary); }

.modal-body { padding: 24px; }

.modal-section {
  margin-bottom: 20px;
}

.modal-section-label {
  font-size: 11px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.06em;
  color: var(--text-muted);
  margin-bottom: 8px;
}

.modal-original-text {
  font-size: 14px;
  line-height: 1.7;
  color: var(--text-primary);
  padding: 16px;
  background: var(--bg-input);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  word-break: break-word;
}

.modal-jp-summary {
  font-size: 13px;
  line-height: 1.7;
  color: var(--accent-blue);
  padding: 12px 16px;
  background: var(--accent-blue-dim);
  border: 1px solid rgba(59,130,246,0.2);
  border-radius: var(--radius-sm);
  margin-top: 8px;
}

.modal-generated-text {
  font-size: 14px;
  line-height: 1.7;
  color: var(--text-primary);
  padding: 16px;
  background: rgba(16,185,129,0.06);
  border: 1px solid rgba(16,185,129,0.2);
  border-radius: var(--radius-sm);
  word-break: break-word;
}

.modal-metrics {
  display: flex;
  gap: 16px;
  flex-wrap: wrap;
}

.modal-metric {
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 8px 14px;
  background: var(--bg-input);
  border: 1px solid var(--border);
  border-radius: 8px;
  font-family: var(--font-mono);
  font-size: 13px;
}

.modal-metric .metric-icon {
  font-size: 14px;
  opacity: 0.8;
}

.modal-metric .metric-val {
  font-weight: 600;
  color: var(--text-primary);
}

.modal-metric .metric-label {
  font-size: 11px;
  color: var(--text-muted);
}

.modal-author {
  display: flex;
  align-items: center;
  gap: 10px;
  font-size: 13px;
  color: var(--text-secondary);
}

.modal-author a {
  color: var(--accent-blue);
  text-decoration: none;
  font-weight: 500;
}
.modal-author a:hover { text-decoration: underline; }

.modal-footer {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 16px 24px;
  border-top: 1px solid var(--border);
  background: var(--bg-secondary);
  border-radius: 0 0 var(--radius) var(--radius);
}

.modal-footer .action-btn { padding: 10px 20px; font-size: 14px; }

.modal-tweet-link {
  margin-left: auto;
  color: var(--text-muted);
  font-size: 12px;
  text-decoration: none;
}
.modal-tweet-link:hover { color: var(--accent-blue); }

/* Make queue rows clickable */
#queueTbody tr { cursor: pointer; transition: background var(--transition-fast); }
#queueTbody tr:hover { background: var(--bg-card-hover); }

/* ===========================================
   SETTINGS TAB
   =========================================== */
.settings-section {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 24px;
  margin-bottom: 16px;
}

.settings-section h3 {
  font-size: 15px;
  font-weight: 600;
  margin-bottom: 6px;
}

.settings-section p {
  font-size: 13px;
  color: var(--text-secondary);
  margin-bottom: 20px;
  line-height: 1.6;
}

.form-group {
  margin-bottom: 16px;
}

.form-label {
  display: block;
  font-size: 12px;
  font-weight: 600;
  color: var(--text-secondary);
  margin-bottom: 6px;
  letter-spacing: 0.02em;
}

.form-input {
  width: 100%;
  padding: 10px 14px;
  background: var(--bg-input);
  border: 1px solid var(--border);
  border-radius: 8px;
  color: var(--text-primary);
  font-size: 13px;
  font-family: var(--font-mono);
  transition: border-color var(--transition-fast);
}

.form-input:focus {
  outline: none;
  border-color: var(--accent-blue);
  box-shadow: 0 0 0 3px var(--accent-blue-dim);
}

.form-input::placeholder {
  color: var(--text-muted);
}

.form-hint {
  font-size: 11px;
  color: var(--text-muted);
  margin-top: 4px;
  line-height: 1.5;
}

.save-btn {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  padding: 10px 24px;
  border-radius: 8px;
  background: var(--accent-blue);
  color: #fff;
  border: none;
  font-size: 13px;
  font-weight: 600;
  font-family: var(--font-sans);
  cursor: pointer;
  transition: background var(--transition-fast), box-shadow var(--transition-fast);
  margin-top: 8px;
}

.save-btn:hover {
  background: #2563eb;
  box-shadow: 0 2px 12px rgba(59,130,246,0.3);
}

.save-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

.save-btn:focus-visible {
  outline: 2px solid var(--accent-blue);
  outline-offset: 2px;
}

.save-msg {
  font-size: 13px;
  margin-top: 12px;
  display: none;
}

.save-msg.success { color: var(--accent-green); display: block; }
.save-msg.error { color: var(--accent-red); display: block; }

/* Toast Notification */
.toast-container {
  position: fixed;
  top: 24px;
  right: 24px;
  z-index: 10000;
  display: flex;
  flex-direction: column;
  gap: 10px;
  pointer-events: none;
}

.toast {
  pointer-events: auto;
  min-width: 280px;
  max-width: 420px;
  padding: 14px 20px;
  border-radius: var(--radius-sm);
  font-size: 13px;
  font-weight: 500;
  display: flex;
  align-items: center;
  gap: 10px;
  box-shadow: var(--shadow-lg);
  animation: toastIn 0.3s ease, toastOut 0.3s ease 2.7s forwards;
  border: 1px solid;
}

.toast-success {
  background: rgba(16,185,129,0.15);
  border-color: rgba(16,185,129,0.3);
  color: var(--accent-green);
}

.toast-error {
  background: rgba(239,68,68,0.15);
  border-color: rgba(239,68,68,0.3);
  color: var(--accent-red);
}

.toast-info {
  background: rgba(59,130,246,0.15);
  border-color: rgba(59,130,246,0.3);
  color: var(--accent-blue);
}

@keyframes toastIn {
  from { opacity: 0; transform: translateX(40px); }
  to { opacity: 1; transform: translateX(0); }
}

@keyframes toastOut {
  from { opacity: 1; transform: translateX(0); }
  to { opacity: 0; transform: translateX(40px); }
}

/* Quick Actions Bar */
.quick-actions {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 12px 16px;
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  margin-bottom: 16px;
  flex-wrap: wrap;
}

.quick-actions-label {
  font-size: 12px;
  font-weight: 600;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 0.05em;
  margin-right: 8px;
  white-space: nowrap;
}

.quick-btn {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 7px 14px;
  font-size: 12px;
  font-weight: 600;
  color: #fff;
  background: var(--accent-blue);
  border: none;
  border-radius: 7px;
  cursor: pointer;
  transition: all var(--transition-fast);
  font-family: var(--font-sans);
  white-space: nowrap;
}

.quick-btn:hover {
  background: #2563eb;
  box-shadow: 0 2px 8px rgba(59,130,246,0.3);
}

.quick-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

.quick-btn.green { background: var(--accent-green); }
.quick-btn.green:hover { background: #059669; box-shadow: 0 2px 8px rgba(16,185,129,0.3); }
.quick-btn.purple { background: var(--accent-purple); }
.quick-btn.purple:hover { background: #7c3aed; box-shadow: 0 2px 8px rgba(139,92,246,0.3); }
.quick-btn.amber { background: var(--accent-amber); }
.quick-btn.amber:hover { background: #d97706; box-shadow: 0 2px 8px rgba(245,158,11,0.3); }

/* Queue delete button */
.action-btn.delete {
  color: var(--accent-red);
  border-color: var(--accent-red-dim);
  background: var(--accent-red-dim);
}

.action-btn.delete:hover {
  background: var(--accent-red);
  color: #fff;
  border-color: var(--accent-red);
}

.api-status {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  font-size: 12px;
  padding: 4px 10px;
  border-radius: 20px;
  font-weight: 600;
}

.api-status.configured {
  background: var(--accent-green-dim);
  color: var(--accent-green);
}

.api-status.not-configured {
  background: var(--accent-amber-dim);
  color: var(--accent-amber);
}

.settings-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
  gap: 16px;
}

.role-badge {
  font-size: 11px;
  padding: 3px 8px;
  border-radius: 12px;
  font-weight: 600;
}

.role-badge.admin {
  background: var(--accent-purple-dim);
  color: var(--accent-purple);
}

.role-badge.client {
  background: var(--accent-blue-dim);
  color: var(--accent-blue);
}

/* ===========================================
   QUEUE ACTION BUTTONS
   =========================================== */
.queue-actions {
  display: flex;
  gap: 6px;
  align-items: center;
}

.action-btn {
  font-size: 11px;
  padding: 4px 10px;
  border-radius: 6px;
  border: 1px solid var(--border);
  background: transparent;
  cursor: pointer;
  font-family: var(--font-sans);
  font-weight: 600;
  transition: all var(--transition-fast);
  white-space: nowrap;
}

.action-btn.approve {
  color: var(--accent-green);
  border-color: rgba(16,185,129,0.3);
}
.action-btn.approve:hover {
  background: var(--accent-green-dim);
  border-color: var(--accent-green);
}

.action-btn.skip {
  color: var(--accent-red);
  border-color: rgba(239,68,68,0.3);
  position: relative;
}
.action-btn.skip:hover {
  background: var(--accent-red-dim);
  border-color: var(--accent-red);
}

.skip-dropdown {
  position: absolute;
  top: 100%;
  right: 0;
  margin-top: 4px;
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 4px;
  z-index: 50;
  min-width: 180px;
  box-shadow: var(--shadow-lg);
  display: none;
}

.skip-dropdown.show { display: block; }

.skip-option {
  display: block;
  width: 100%;
  text-align: left;
  padding: 8px 12px;
  font-size: 12px;
  color: var(--text-secondary);
  background: none;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-family: var(--font-sans);
  transition: background var(--transition-fast), color var(--transition-fast);
}

.skip-option:hover {
  background: var(--bg-input);
  color: var(--text-primary);
}

.match-score {
  font-size: 11px;
  font-family: var(--font-mono);
  color: var(--text-muted);
  display: flex;
  align-items: center;
  gap: 4px;
}

.match-score.high { color: var(--accent-green); }
.match-score.medium { color: var(--accent-amber); }
.match-score.low { color: var(--text-muted); }

/* ===========================================
   PREFERENCES FORM (é¸å®šè¨­å®š)
   =========================================== */
.pref-section {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 24px;
  margin-bottom: 16px;
}

.pref-section h3 {
  font-size: 15px;
  font-weight: 600;
  margin-bottom: 4px;
  display: flex;
  align-items: center;
  gap: 8px;
}

.pref-section .desc {
  font-size: 13px;
  color: var(--text-secondary);
  margin-bottom: 18px;
  line-height: 1.6;
}

.pref-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
  gap: 16px;
}

.tag-list {
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
  margin-top: 8px;
}

.tag {
  font-size: 11px;
  padding: 3px 10px;
  border-radius: 20px;
  font-weight: 500;
  border: 1px solid var(--border);
  background: var(--bg-input);
  color: var(--text-secondary);
}

.tag.preferred { background: var(--accent-green-dim); color: var(--accent-green); border-color: rgba(16,185,129,0.3); }
.tag.avoid { background: var(--accent-red-dim); color: var(--accent-red); border-color: rgba(239,68,68,0.3); }
.tag.keyword { background: var(--accent-blue-dim); color: var(--accent-blue); border-color: rgba(59,130,246,0.3); }
.tag.boosted { background: var(--accent-purple-dim); color: var(--accent-purple); border-color: rgba(139,92,246,0.3); }

textarea.form-input {
  min-height: 60px;
  resize: vertical;
  line-height: 1.6;
}

/* ===========================================
   PDCA ANALYSIS TAB
   =========================================== */
.pdca-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
  gap: 16px;
  margin-bottom: 24px;
}

.pdca-card {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 22px 24px;
}

.pdca-card h4 {
  font-size: 13px;
  font-weight: 600;
  color: var(--text-secondary);
  margin-bottom: 14px;
  display: flex;
  align-items: center;
  gap: 8px;
}

.approval-rate-big {
  font-size: 48px;
  font-weight: 700;
  font-family: var(--font-mono);
  letter-spacing: -0.03em;
  line-height: 1.1;
}

.approval-rate-big.good { color: var(--accent-green); }
.approval-rate-big.ok { color: var(--accent-amber); }
.approval-rate-big.bad { color: var(--accent-red); }

.pdca-list {
  list-style: none;
}

.pdca-list li {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 8px 0;
  border-bottom: 1px solid var(--border);
  font-size: 13px;
}

.pdca-list li:last-child { border-bottom: none; }

.pdca-list .account {
  font-weight: 500;
  color: var(--text-primary);
}

.pdca-list .rate {
  font-family: var(--font-mono);
  font-size: 12px;
}

.pdca-list .rate.high { color: var(--accent-green); }
.pdca-list .rate.low { color: var(--accent-red); }

.reason-bar {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 8px;
}

.reason-bar-label {
  font-size: 12px;
  color: var(--text-secondary);
  min-width: 100px;
  flex-shrink: 0;
}

.reason-bar-fill {
  height: 20px;
  border-radius: 4px;
  background: var(--accent-blue);
  transition: width var(--transition-base);
  min-width: 2px;
}

.reason-bar-count {
  font-size: 11px;
  color: var(--text-muted);
  font-family: var(--font-mono);
  flex-shrink: 0;
}

.adjustment-item {
  font-size: 13px;
  padding: 10px 14px;
  background: var(--bg-input);
  border-radius: 8px;
  margin-bottom: 8px;
  color: var(--text-secondary);
  line-height: 1.5;
  border-left: 3px solid var(--accent-blue);
}

.adjustment-item.promote { border-left-color: var(--accent-green); }
.adjustment-item.demote { border-left-color: var(--accent-red); }
</style>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+JP:wght@400;500;700&family=Fira+Code:wght@400;500;600&display=swap" rel="stylesheet">
<!-- Firebase SDK (compat) -->
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
</head>
<body>

<!-- ===== QUEUE DETAIL MODAL ===== -->
<div class="modal-overlay" id="queueModal">
  <div class="modal-card">
    <div class="modal-header">
      <h3 id="modalTitle">ãƒ„ã‚¤ãƒ¼ãƒˆè©³ç´°</h3>
      <button class="modal-close" onclick="closeQueueModal()">&times;</button>
    </div>
    <div class="modal-body">
      <!-- Author + Status -->
      <div class="modal-section">
        <div style="display:flex;align-items:center;justify-content:space-between;">
          <div class="modal-author" id="modalAuthor"></div>
          <span id="modalStatus"></span>
        </div>
      </div>

      <!-- Engagement Metrics -->
      <div class="modal-section">
        <div class="modal-section-label">ã‚¨ãƒ³ã‚²ãƒ¼ã‚¸ãƒ¡ãƒ³ãƒˆ</div>
        <div class="modal-metrics" id="modalMetrics"></div>
      </div>

      <!-- Original Text -->
      <div class="modal-section">
        <div class="modal-section-label">å…ƒãƒ„ã‚¤ãƒ¼ãƒˆï¼ˆåŸæ–‡ï¼‰</div>
        <div class="modal-original-text" id="modalOriginalText"></div>
        <div class="modal-jp-summary" id="modalJpSummary" style="display:none;"></div>
      </div>

      <!-- Generated Text -->
      <div class="modal-section" id="modalGeneratedSection">
        <div class="modal-section-label">AIç”Ÿæˆã‚³ãƒ¡ãƒ³ãƒˆï¼ˆå¼•ç”¨RTæŠ•ç¨¿æ–‡ï¼‰</div>
        <div class="modal-generated-text" id="modalGeneratedText"></div>
      </div>

      <!-- Additional info -->
      <div class="modal-section" style="display:flex;gap:16px;flex-wrap:wrap;font-size:12px;color:var(--text-muted);">
        <span id="modalAddedAt"></span>
        <span id="modalSource"></span>
        <span id="modalTemplate"></span>
        <span id="modalScore"></span>
      </div>
    </div>

    <div class="modal-footer" id="modalFooter">
      <!-- Actions populated by JS -->
    </div>
  </div>
</div>

<!-- ===== LOGIN OVERLAY ===== -->
<div class="login-overlay" id="loginOverlay">
  <div class="login-card">
    <div class="login-logo"><svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg></div>
    <h2 class="login-title">ã‚­ãƒ¥ãƒ¼ç®¡ç†ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h2>
    <p class="login-subtitle">ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«ã‚¢ã‚¯ã‚»ã‚¹</p>
    <button class="x-login-btn" id="xLoginBtn">
      <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>
      X ã§ãƒ­ã‚°ã‚¤ãƒ³
    </button>
    <p class="login-error" id="loginError"></p>
    <div class="login-loading" id="loginLoading">
      <div class="spinner"></div>
      <div class="loading-text">èªè¨¼ä¸­...</div>
    </div>
  </div>
</div>

<div class="app" style="display:none">
  <!-- ===== HEADER ===== -->
  <header class="header">
    <div class="header-left">
      <div class="header-logo"><svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg></div>
      <h1>ã‚­ãƒ¥ãƒ¼ç®¡ç†ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ <span>Pattern B</span></h1>
    </div>
    <div class="header-right">
      <span class="badge badge-live" id="statusBadge">LIVE</span>
      <span class="last-updated" id="lastUpdated">--</span>
    </div>
  </header>

  <!-- ===== KPI CARDS ===== -->
  <div class="kpi-grid" id="kpiGrid">
    <div class="kpi-card">
      <div class="kpi-label">æ‰¿èªå¾…ã¡</div>
      <div class="kpi-value amber" id="kpiPending">-</div>
      <div class="kpi-sub">pending</div>
    </div>
    <div class="kpi-card">
      <div class="kpi-label">æ‰¿èªæ¸ˆã¿</div>
      <div class="kpi-value blue" id="kpiApproved">-</div>
      <div class="kpi-sub">approved</div>
    </div>
    <div class="kpi-card">
      <div class="kpi-label">æŠ•ç¨¿æ¸ˆã¿ï¼ˆæœ¬æ—¥ï¼‰</div>
      <div class="kpi-value green" id="kpiPostedToday">-</div>
      <div class="kpi-sub">posted today</div>
    </div>
    <div class="kpi-card">
      <div class="kpi-label">æŠ•ç¨¿æ¸ˆã¿ï¼ˆç´¯è¨ˆï¼‰</div>
      <div class="kpi-value purple" id="kpiPostedTotal">-</div>
      <div class="kpi-sub">all time</div>
    </div>
    <div class="kpi-card">
      <div class="kpi-label">ã‚¹ã‚­ãƒƒãƒ—</div>
      <div class="kpi-value red" id="kpiSkipped">-</div>
      <div class="kpi-sub">skipped</div>
    </div>
  </div>

  <!-- ===== QUICK ACTIONS BAR ===== -->
  <div class="quick-actions" id="quickActionsBar" style="display:none;">
    <span class="quick-actions-label">âš¡ å®Ÿè¡Œ</span>
    <button class="quick-btn" onclick="requestOperation('collect')" id="qbCollect">ğŸ“¡ åé›†</button>
    <button class="quick-btn green" onclick="requestOperation('curate')" id="qbCurate">âœï¸ ç”Ÿæˆ</button>
    <button class="quick-btn purple" onclick="requestOperation('curate-post')" id="qbPost">ğŸ“¤ æŠ•ç¨¿</button>
    <button class="quick-btn amber" onclick="requestOperation('export-dashboard')" id="qbDashboard">ğŸ“Š æ›´æ–°</button>
    <span id="quickActionMsg" style="font-size:12px;margin-left:auto;"></span>
  </div>

  <!-- ===== TABS ===== -->
  <nav class="tabs" id="tabNav">
    <button class="tab active" data-tab="queue">ã‚­ãƒ¥ãƒ¼ä¸€è¦§</button>
    <button class="tab" data-tab="posted">æŠ•ç¨¿å±¥æ­´</button>
    <button class="tab" data-tab="metrics">ãƒ¡ãƒˆãƒªã‚¯ã‚¹</button>
    <button class="tab" data-tab="preferences">é¸å®šè¨­å®š</button>
    <button class="tab" data-tab="pdca">PDCAåˆ†æ</button>
    <button class="tab" data-tab="operations">æ“ä½œ</button>
    <button class="tab" data-tab="settings">è¨­å®š</button>
    <button class="tab" data-tab="guide">ğŸ“– ä½¿ã„æ–¹</button>
  </nav>

  <!-- ===== TAB: OPERATIONS ===== -->
  <div class="tab-panel" id="panel-operations">
    <div class="settings-section">
      <h3>ğŸš€ æ‰‹å‹•æ“ä½œ</h3>
      <p>ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨æ“ä½œãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒé€ä¿¡ã•ã‚Œã¾ã™ã€‚é€šå¸¸5ã€œ10åˆ†ä»¥å†…ã«è‡ªå‹•å®Ÿè¡Œã•ã‚Œã¾ã™ã€‚</p>
      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:16px;margin-top:20px;">

        <div style="background:var(--bg-input);border:1px solid var(--border);border-radius:var(--radius-sm);padding:20px;">
          <div style="font-weight:600;margin-bottom:6px;">ğŸ“¡ ãƒã‚ºãƒ„ã‚¤ãƒ¼ãƒˆåé›†</div>
          <div style="font-size:12px;color:var(--text-secondary);margin-bottom:16px;">æµ·å¤–AIã‚¤ãƒ³ãƒ•ãƒ«ã‚¨ãƒ³ã‚µãƒ¼ã®ãƒã‚ºãƒ„ã‚¤ãƒ¼ãƒˆã‚’ä»Šã™ãåé›†ã—ã¾ã™</div>
          <button class="save-btn" onclick="requestOperation('collect')" id="btnCollect" style="width:100%;">
            ä»Šã™ãåé›†
          </button>
        </div>

        <div style="background:var(--bg-input);border:1px solid var(--border);border-radius:var(--radius-sm);padding:20px;">
          <div style="font-weight:600;margin-bottom:6px;">âœï¸ AIã‚³ãƒ¡ãƒ³ãƒˆç”Ÿæˆ</div>
          <div style="font-size:12px;color:var(--text-secondary);margin-bottom:16px;">æ‰¿èªæ¸ˆã¿ãƒ„ã‚¤ãƒ¼ãƒˆã«å¯¾ã—ã¦AIãŒå¼•ç”¨RTã‚³ãƒ¡ãƒ³ãƒˆã‚’ç”Ÿæˆã—ã¾ã™</div>
          <button class="save-btn" onclick="requestOperation('curate')" id="btnCurate" style="width:100%;">
            ä»Šã™ãç”Ÿæˆ
          </button>
        </div>

        <div style="background:var(--bg-input);border:1px solid var(--border);border-radius:var(--radius-sm);padding:20px;">
          <div style="font-weight:600;margin-bottom:6px;">ğŸ“¤ å¼•ç”¨RTæŠ•ç¨¿</div>
          <div style="font-size:12px;color:var(--text-secondary);margin-bottom:16px;">ç”Ÿæˆæ¸ˆã¿ã®å¼•ç”¨RTã‚’Xã«æŠ•ç¨¿ã—ã¾ã™</div>
          <button class="save-btn" onclick="requestOperation('curate-post')" id="btnPost" style="width:100%;">
            ä»Šã™ãæŠ•ç¨¿
          </button>
        </div>

        <div style="background:var(--bg-input);border:1px solid var(--border);border-radius:var(--radius-sm);padding:20px;">
          <div style="font-weight:600;margin-bottom:6px;">ğŸ“Š ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰æ›´æ–°</div>
          <div style="font-size:12px;color:var(--text-secondary);margin-bottom:16px;">ã“ã®ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã®ãƒ‡ãƒ¼ã‚¿ã‚’æœ€æ–°ã«æ›´æ–°ã—ã¾ã™</div>
          <button class="save-btn" onclick="requestOperation('export-dashboard')" id="btnDashboard" style="width:100%;">
            ä»Šã™ãæ›´æ–°
          </button>
        </div>

      </div>
      <div id="opMsg" style="margin-top:16px;font-size:13px;"></div>
    </div>

    <!-- æ“ä½œå±¥æ­´ -->
    <div class="settings-section" style="margin-top:24px;">
      <h3>ğŸ“‹ æ“ä½œãƒªã‚¯ã‚¨ã‚¹ãƒˆå±¥æ­´</h3>
      <div id="opHistory" style="font-size:13px;color:var(--text-secondary);">èª­ã¿è¾¼ã¿ä¸­...</div>
    </div>

    <!-- ãƒ„ã‚¤ãƒ¼ãƒˆURLæ‰‹å‹•è¿½åŠ  -->
    <div class="settings-section" style="margin-top:24px;">
      <h3>ğŸ”— ãƒ„ã‚¤ãƒ¼ãƒˆURLã‚’æ‰‹å‹•è¿½åŠ </h3>
      <p>å¼•ç”¨RTã—ãŸã„ãƒ„ã‚¤ãƒ¼ãƒˆã®URLã‚’å…¥åŠ›ã—ã¦è¿½åŠ ã§ãã¾ã™ã€‚è¿½åŠ å¾Œã¯ã€ŒAIã‚³ãƒ¡ãƒ³ãƒˆç”Ÿæˆã€â†’ã€Œå¼•ç”¨RTæŠ•ç¨¿ã€ã®é †ã§å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚</p>
      <div style="display:flex;gap:10px;margin-top:16px;">
        <input type="text" class="form-input" id="manualTweetUrl" placeholder="https://x.com/username/status/XXXXXXXXX" style="flex:1;">
        <button class="save-btn" onclick="addManualTweet()" id="btnAddTweet">è¿½åŠ </button>
      </div>
      <div id="addTweetMsg" style="margin-top:10px;font-size:13px;"></div>
    </div>
  </div>

  <!-- ===== TAB: QUEUE ===== -->
  <div class="tab-panel active" id="panel-queue">
    <div class="table-wrapper">
      <div class="table-toolbar">
        <h3>åé›†ã‚­ãƒ¥ãƒ¼</h3>
        <div class="filter-group">
          <button class="filter-btn active" data-filter="all">ã™ã¹ã¦</button>
          <button class="filter-btn" data-filter="pending">æ‰¿èªå¾…ã¡</button>
          <button class="filter-btn" data-filter="approved">æ‰¿èªæ¸ˆã¿</button>
          <button class="filter-btn" data-filter="skipped">ã‚¹ã‚­ãƒƒãƒ—</button>
        </div>
      </div>
      <div class="table-scroll" id="queueTableScroll">
        <table>
          <thead>
            <tr>
              <th>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>
              <th>å…ƒãƒ„ã‚¤ãƒ¼ãƒˆ</th>
              <th>ç”Ÿæˆãƒ†ã‚­ã‚¹ãƒˆ</th>
              <th>ã‚¨ãƒ³ã‚²ãƒ¼ã‚¸ãƒ¡ãƒ³ãƒˆ</th>
              <th>ãƒãƒƒãƒ</th>
              <th>è¿½åŠ æ—¥æ™‚</th>
              <th>ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</th>
            </tr>
          </thead>
          <tbody id="queueTbody">
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- ===== TAB: POSTED ===== -->
  <div class="tab-panel" id="panel-posted">
    <div id="postedList"></div>
  </div>

  <!-- ===== TAB: METRICS ===== -->
  <div class="tab-panel" id="panel-metrics">
    <div class="metrics-chart-area">
      <h3>ç›´è¿‘7æ—¥é–“ã®æŠ•ç¨¿æ•°æ¨ç§»</h3>
      <div class="chart-container">
        <canvas id="metricsChart"></canvas>
      </div>
    </div>
    <div class="metric-row" id="metricCards"></div>
  </div>

  <!-- ===== TAB: PREFERENCES (é¸å®šè¨­å®š) ===== -->
  <div class="tab-panel" id="panel-preferences">
    <!-- ä»Šé€±ã®ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ -->
    <div class="pref-section">
      <h3>ğŸ¯ ä»Šé€±ã®ãƒ•ã‚©ãƒ¼ã‚«ã‚¹</h3>
      <p class="desc">ä»Šé€±é‡ç‚¹çš„ã«åé›†ãƒ»å¼•ç”¨ã—ãŸã„ãƒ†ãƒ¼ãƒã‚’è¨­å®šã—ã¾ã™ã€‚ã“ã“ã«è¨­å®šã—ãŸå†…å®¹ã«åˆè‡´ã™ã‚‹ãƒ„ã‚¤ãƒ¼ãƒˆãŒå„ªå…ˆçš„ã«é¸ã°ã‚Œã¾ã™ã€‚</p>
      <div class="form-group">
        <label class="form-label">ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒ†ã‚£ãƒ–</label>
        <textarea class="form-input" id="prefFocusDirective" placeholder="ä¾‹: ä»Šé€±ã¯AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆé–¢é€£ã®ãƒ„ã‚¤ãƒ¼ãƒˆã‚’ä¸­å¿ƒã«ã€‚ç‰¹ã«MCPã‚„tool useã®è©±é¡Œã‚’é‡è¦–ã€‚"></textarea>
        <div class="form-hint">è‡ªç”±è¨˜è¿°ã§ä»Šé€±ã®æ–¹é‡ã‚’æ›¸ã„ã¦ãã ã•ã„</div>
      </div>
      <div class="pref-grid">
        <div class="form-group">
          <label class="form-label">ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰</label>
          <input type="text" class="form-input" id="prefFocusKeywords" placeholder="MCP, tool use, AI agent">
          <div class="form-hint">ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã§å…¥åŠ›</div>
        </div>
        <div class="form-group">
          <label class="form-label">ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ</label>
          <input type="text" class="form-input" id="prefFocusAccounts" placeholder="@sama, @karpathy">
          <div class="form-hint">ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã§å…¥åŠ›ï¼ˆ@ã¯ä»»æ„ï¼‰</div>
        </div>
      </div>
    </div>

    <!-- ãƒˆãƒ”ãƒƒã‚¯è¨­å®š -->
    <div class="pref-section">
      <h3>ğŸ“‹ ãƒˆãƒ”ãƒƒã‚¯è¨­å®š</h3>
      <p class="desc">å„ªå…ˆã—ãŸã„ãƒˆãƒ”ãƒƒã‚¯ã¨å›é¿ã—ãŸã„ãƒˆãƒ”ãƒƒã‚¯ã‚’è¨­å®šã—ã¾ã™ã€‚PDCAåˆ†æã®çµæœã«ã‚ˆã‚Šè‡ªå‹•èª¿æ•´ã•ã‚Œã‚‹ã“ã¨ã‚‚ã‚ã‚Šã¾ã™ã€‚</p>
      <div class="pref-grid">
        <div class="form-group">
          <label class="form-label">å„ªå…ˆãƒˆãƒ”ãƒƒã‚¯</label>
          <input type="text" class="form-input" id="prefPreferredTopics" placeholder="AI agents, product launches, coding AI">
          <div class="form-hint">ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Š</div>
          <div class="tag-list" id="tagPreferred"></div>
        </div>
        <div class="form-group">
          <label class="form-label">å›é¿ãƒˆãƒ”ãƒƒã‚¯</label>
          <input type="text" class="form-input" id="prefAvoidTopics" placeholder="AI doomerism, crypto, politics">
          <div class="form-hint">ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Š</div>
          <div class="tag-list" id="tagAvoid"></div>
        </div>
      </div>
    </div>

    <!-- ã‚¢ã‚«ã‚¦ãƒ³ãƒˆè¨­å®š -->
    <div class="pref-section">
      <h3>ğŸ‘¤ ã‚¢ã‚«ã‚¦ãƒ³ãƒˆè¨­å®š</h3>
      <p class="desc">ç‰¹å®šã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®å„ªå…ˆåº¦ã‚’è¨­å®šã—ã¾ã™ã€‚ãƒ–ãƒ¼ã‚¹ãƒˆã—ãŸã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ãƒ„ã‚¤ãƒ¼ãƒˆã¯1.5å€ã®ã‚¹ã‚³ã‚¢ã§è©•ä¾¡ã•ã‚Œã¾ã™ã€‚</p>
      <div class="pref-grid">
        <div class="form-group">
          <label class="form-label">å„ªå…ˆã‚¢ã‚«ã‚¦ãƒ³ãƒˆï¼ˆãƒ–ãƒ¼ã‚¹ãƒˆï¼‰</label>
          <input type="text" class="form-input" id="prefBoostedAccounts" placeholder="sama, karpathy, AndrewYNg">
          <div class="form-hint">ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šï¼ˆ@ä¸è¦ï¼‰</div>
          <div class="tag-list" id="tagBoosted"></div>
        </div>
        <div class="form-group">
          <label class="form-label">ãƒ–ãƒ­ãƒƒã‚¯ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ</label>
          <input type="text" class="form-input" id="prefBlockedAccounts" placeholder="spammer123">
          <div class="form-hint">ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šï¼ˆ@ä¸è¦ï¼‰â€” ã“ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ãƒ„ã‚¤ãƒ¼ãƒˆã¯é™¤å¤–</div>
        </div>
      </div>
    </div>

    <!-- ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚¦ã‚§ã‚¤ãƒˆ -->
    <div class="pref-section">
      <h3>âš–ï¸ ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚¦ã‚§ã‚¤ãƒˆ</h3>
      <p class="desc">ç‰¹å®šã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å«ã‚€ãƒ„ã‚¤ãƒ¼ãƒˆã®å„ªå…ˆåº¦ã‚’èª¿æ•´ã—ã¾ã™ã€‚æ•°å€¤ãŒé«˜ã„ã»ã©å„ªå…ˆã•ã‚Œã¾ã™ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ1.0ï¼‰ã€‚</p>
      <div class="form-group">
        <label class="form-label">è¿½åŠ ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ï¼ˆweight 2.0 ã§è¿½åŠ ï¼‰</label>
        <input type="text" class="form-input" id="prefExtraKeywords" placeholder="MCP, function calling, agentic">
        <div class="form-hint">ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã€‚æ—¢å­˜ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã¯å¤‰æ›´ã•ã‚Œã¾ã›ã‚“ã€‚</div>
      </div>
      <div id="keywordWeightDisplay" style="margin-top:12px;"></div>
    </div>

    <!-- å¼•ç”¨RTãƒ—ãƒ­ãƒ³ãƒ—ãƒˆè¨­å®š -->
    <div class="pref-section">
      <h3>âœï¸ å¼•ç”¨RTãƒ—ãƒ­ãƒ³ãƒ—ãƒˆè¨­å®š</h3>
      <p class="desc">å¼•ç”¨RTã‚³ãƒ¡ãƒ³ãƒˆã‚’ç”Ÿæˆã™ã‚‹AIã¸ã®æŒ‡ç¤ºã‚’ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã—ã¾ã™ã€‚å¤‰æ›´ã¯æ¬¡å›ã®ã‚³ãƒ¡ãƒ³ãƒˆç”Ÿæˆã‹ã‚‰åæ˜ ã•ã‚Œã¾ã™ã€‚</p>

      <div class="pref-grid">
        <div class="form-group">
          <label class="form-label">ãƒšãƒ«ã‚½ãƒŠå</label>
          <input type="text" class="form-input" id="promptPersonaName" placeholder="NinjaGuild" value="NinjaGuild">
          <div class="form-hint">æŠ•ç¨¿è€…ã¨ã—ã¦ã®åå‰</div>
        </div>
        <div class="form-group">
          <label class="form-label">ä¸€äººç§°</label>
          <input type="text" class="form-input" id="promptFirstPerson" placeholder="ç§" value="ç§">
          <div class="form-hint">åƒ• / ä¿º / ç§ / ã‚ãŸã— ãªã©</div>
        </div>
      </div>

      <div class="form-group">
        <label class="form-label">ãƒã‚¸ã‚·ãƒ§ãƒ³ï¼ˆä½•è€…ã‹ï¼‰</label>
        <input type="text" class="form-input" id="promptPosition" placeholder="æš—å·è³‡ç”£ãƒ»Web3ãƒ»AIé ˜åŸŸã®æœ€æ–°æƒ…å ±ã‚’æ–­å®šçš„ã«ã‚­ãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã™ã‚‹æƒ…å ±ç™ºä¿¡è€…" value="æš—å·è³‡ç”£ãƒ»Web3ãƒ»AIé ˜åŸŸã®æœ€æ–°æƒ…å ±ã‚’æ–­å®šçš„ã«ã‚­ãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã™ã‚‹æƒ…å ±ç™ºä¿¡è€…">
        <div class="form-hint">ã€Œã€‡ã€‡ã¨ã—ã¦ç™ºä¿¡ã—ã¦ã„ã‚‹ã€ã®ã€‡ã€‡éƒ¨åˆ†</div>
      </div>

      <div class="form-group">
        <label class="form-label">å·®åˆ¥åŒ–ãƒã‚¤ãƒ³ãƒˆ</label>
        <input type="text" class="form-input" id="promptDifferentiator" placeholder="æµ·å¤–ãƒ‹ãƒ¥ãƒ¼ã‚¹ã‚’ãƒ‰ãƒ©ãƒãƒãƒƒã‚¯ã«æ¼”å‡ºã—ã€ç®‡æ¡æ›¸ãã§å³åº§ã«è¦ç‚¹ã‚’ä¼ãˆã‚‹" value="æµ·å¤–ãƒ‹ãƒ¥ãƒ¼ã‚¹ã‚’ãƒ‰ãƒ©ãƒãƒãƒƒã‚¯ã«æ¼”å‡ºã—ã€ç®‡æ¡æ›¸ãã§å³åº§ã«è¦ç‚¹ã‚’ä¼ãˆã‚‹">
        <div class="form-hint">ä»–ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã¨ã®é•ã„</div>
      </div>

      <div class="form-group">
        <label class="form-label">ãƒˆãƒ¼ãƒ³</label>
        <input type="text" class="form-input" id="promptTone" placeholder="æ‰‡æƒ…çš„ã§ç†±é‡ãŒé«˜ãæ–­å®šçš„ã€‚å°‚é–€çŸ¥è­˜ã‚’èƒŒæ™¯ã«ãƒ‰ãƒ©ãƒãƒãƒƒã‚¯ã‹ã¤å¼·ã„è¨€è‘‰ã§èª­è€…ã®æ„Ÿæƒ…ã‚’æºã•ã¶ã‚‹ã‚¹ã‚¿ã‚¤ãƒ«" value="æ‰‡æƒ…çš„ã§ç†±é‡ãŒé«˜ãæ–­å®šçš„ã€‚å°‚é–€çŸ¥è­˜ã‚’èƒŒæ™¯ã«ãƒ‰ãƒ©ãƒãƒãƒƒã‚¯ã‹ã¤å¼·ã„è¨€è‘‰ã§èª­è€…ã®æ„Ÿæƒ…ã‚’æºã•ã¶ã‚‹ã‚¹ã‚¿ã‚¤ãƒ«">
        <div class="form-hint">æ–‡ç« ã®é›°å›²æ°—ãƒ»ãƒ†ãƒ³ã‚·ãƒ§ãƒ³</div>
      </div>

      <div class="form-group">
        <label class="form-label">å£èª¿ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆæ”¹è¡ŒåŒºåˆ‡ã‚Šï¼‰</label>
        <textarea class="form-input" id="promptStylePatterns" rows="6" placeholder="ä½“è¨€æ­¢ã‚:ã€Œã€œãªæ™‚ä»£ã€‚ã€ã€Œã€œä¸€æŠã€‚ã€">è¦‹å‡ºã—8ç¨®:ã€ŒğŸ’¥ã€æ¿€éœ‡ã€‘ã€ã€ŒğŸ’¥ã€é€Ÿå ±ã€‘ã€ã€ŒğŸš¨ã€è­¦å‘Šã€‘ã€ã€ŒğŸš¨ã€è¡æ’ƒã€‘ã€ã€ŒğŸ’¥ã€ç‹¬å ã€‘ã€ã€ŒğŸ’¥ã€ä¼èª¬ã€‘ã€ã€ŒğŸ’€ï¼ˆãƒ€ãƒ¼ã‚¯å‹ï¼‰ã€ã€ŒğŸš¨ã€ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã€‘ã€
ç®‡æ¡æ›¸ã:ã€Œãƒ»ã€ã§è¦ç‚¹ã‚’3ã€œ5å€‹ç°¡æ½”ã«æ•´ç†
ä½“è¨€æ­¢ã‚:ã€Œã€œã¸ã€‚ã€ã€Œã€œã‹ã€‚ã€ã€Œã€œã®å®Ÿç¸¾ã€‚ã€ãªã©æ–­å®šçš„ã«ç· ã‚ã‚‹
æ„Ÿæƒ…èª:ã€Œåœ§å€’çš„ã€ã€Œæœ€å¼·ã€ã€Œã‚¬ãƒã€ã€Œç¥ã€ã€ŒçŒ›çƒˆã«ã€ã€ŒåŠ‡çš„ã«ã€
çµµæ–‡å­—:ğŸ›ï¸ğŸ’¥ğŸ‡ºğŸ‡¸âœ¨ğŸ’ğŸ“ŠğŸ©¸ğŸ’€âš–ï¸ğŸ”¥ ã‚’ç©æ¥µçš„ã«æŒ¿å…¥
ç· ã‚: æ¯å›ç•°ãªã‚‹ãƒ•ãƒ¬ãƒ¼ã‚ºã§æ–­å®šã™ã‚‹ï¼ˆåŒã˜ç· ã‚ã®ç¹°ã‚Šè¿”ã—ç¦æ­¢ï¼‰</textarea>
        <div class="form-hint">æ–‡ä½“ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’è¨˜è¿°ã€‚æ”¹è¡Œã§åŒºåˆ‡ã‚Šã€‚</div>
      </div>

      <div class="form-group">
        <label class="form-label">NGãƒ¯ãƒ¼ãƒ‰ï¼ˆã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šï¼‰</label>
        <input type="text" class="form-input" id="promptNgWords" placeholder="ç´ æ™´ã‚‰ã—ã„, é©æ–°çš„, ç”»æœŸçš„" value="ç´ æ™´ã‚‰ã—ã„, é©æ–°çš„, ç”»æœŸçš„, ã„ã‹ãŒã§ã—ã‚‡ã†ã‹, æ³¨ç›®ã§ã™">
        <div class="form-hint">ç”Ÿæˆæ™‚ã«ä½¿ã‚ã›ãŸããªã„ãƒ¯ãƒ¼ãƒ‰</div>
      </div>

      <div class="form-group">
        <label class="form-label">ã‚«ã‚¹ã‚¿ãƒ æŒ‡ç¤ºï¼ˆè‡ªç”±è¨˜è¿°ï¼‰</label>
        <textarea class="form-input" id="promptCustomDirective" rows="4" placeholder="ä¾‹: ã‚‚ã£ã¨å…·ä½“çš„ãªæ•°å­—ã‚„ãƒ‡ãƒ¼ã‚¿ã‚’å…¥ã‚Œã¦æ¬²ã—ã„">8ç¨®ã®è¦‹å‡ºã—ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ä½¿ã„åˆ†ã‘ã€é€£ç¶šã§åŒã˜è¦‹å‡ºã—ã¯ä½¿ã‚ãªã„ã“ã¨ã€‚æœ¬æ–‡ã¯ã€Œãƒ»ã€ã®ç®‡æ¡æ›¸ãã§3ã€œ5ãƒã‚¤ãƒ³ãƒˆã€‚å…·ä½“çš„ãªæ•°å­—ã‚„ãƒ‡ãƒ¼ã‚¿ã‚’å¿…ãšå«ã‚ã‚‹ã€‚æ›–æ˜§ãªè¡¨ç¾ã¯é¿ã‘æ–­è¨€ã™ã‚‹ã€‚çµµæ–‡å­—ã¯ğŸ›ï¸ã‚’åŸºèª¿ã«ä½¿ã†ã€‚ç· ã‚ã®ä¸€è¨€ã¯æ¯å›ç•°ãªã‚‹ãƒ•ãƒ¬ãƒ¼ã‚ºã«ã™ã‚‹ã“ã¨ã€‚</textarea>
        <div class="form-hint">AIã¸ã®è¿½åŠ æŒ‡ç¤ºã€‚ã“ã“ã«æ›¸ã„ãŸå†…å®¹ãŒãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®æœ«å°¾ã«è¿½åŠ ã•ã‚Œã¾ã™ã€‚</div>
      </div>

      <div class="form-group">
        <label class="form-label" style="margin-bottom:12px;">ä½¿ç”¨ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆï¼ˆ8ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼‰</label>
        <div style="display:flex;flex-direction:column;gap:10px;">
          <label style="display:flex;align-items:center;gap:8px;font-size:13px;cursor:pointer;">
            <input type="checkbox" id="tmplTranslateComment" checked style="accent-color:var(--accent-blue);width:16px;height:16px;">
            ğŸš¨ å¸‚å ´ã‚¤ãƒ³ãƒ‘ã‚¯ãƒˆå‹ â€” å¸‚å ´/æŠ•è³‡å®¶ã¸ã®å½±éŸ¿ã‚’ç®‡æ¡æ›¸ãã§
          </label>
          <label style="display:flex;align-items:center;gap:8px;font-size:13px;cursor:pointer;">
            <input type="checkbox" id="tmplSummaryPoints" checked style="accent-color:var(--accent-blue);width:16px;height:16px;">
            ğŸ’¥ è¦ç‚¹ã¾ã¨ã‚å‹ â€” ã€é€Ÿå ±ã€‘ãƒã‚¤ãƒ³ãƒˆ3ã¤ã‚’ç®‡æ¡æ›¸ã
          </label>
          <label style="display:flex;align-items:center;gap:8px;font-size:13px;cursor:pointer;">
            <input type="checkbox" id="tmplQuestionPrompt" checked style="accent-color:var(--accent-blue);width:16px;height:16px;">
            ğŸš¨ è­¦å‘Šãƒ»å•é¡Œæèµ·å‹ â€” ã€è­¦å‘Šã€‘æ ¹æ‹ /ãƒ‡ãƒ¼ã‚¿ã§è­¦é˜
          </label>
          <label style="display:flex;align-items:center;gap:8px;font-size:13px;cursor:pointer;">
            <input type="checkbox" id="tmplPracticeReport" checked style="accent-color:var(--accent-blue);width:16px;height:16px;">
            ğŸ’¥ æ¿€éœ‡åˆ†æå‹ â€” ã€æ¿€éœ‡ã€‘åˆ†æãƒã‚¤ãƒ³ãƒˆã‚’æ–­å®š
          </label>
          <label style="display:flex;align-items:center;gap:8px;font-size:13px;cursor:pointer;">
            <input type="checkbox" id="tmplBreakingNews" checked style="accent-color:var(--accent-blue);width:16px;height:16px;">
            ğŸš¨ è¡æ’ƒé€Ÿå ±å‹ â€” ã€è¡æ’ƒã€‘æ­´å²çš„æ„ç¾©ã‚’æ–­è¨€
          </label>
          <label style="display:flex;align-items:center;gap:8px;font-size:13px;cursor:pointer;">
            <input type="checkbox" id="tmplExclusiveReport" checked style="accent-color:var(--accent-blue);width:16px;height:16px;">
            ğŸ’¥ ç‹¬å å…¥æ‰‹å‹ â€” ã€ç‹¬å ã€‘ã‚¹ã‚¯ãƒ¼ãƒ—æƒ…å ±ã‚’æ–­å®šçš„ã«
          </label>
          <label style="display:flex;align-items:center;gap:8px;font-size:13px;cursor:pointer;">
            <input type="checkbox" id="tmplDarkAlert" checked style="accent-color:var(--accent-blue);width:16px;height:16px;">
            ğŸ’€ ãƒ€ãƒ¼ã‚¯è­¦å‘Šå‹ â€” æš—ã„/å±é™ºãªãƒ‹ãƒ¥ãƒ¼ã‚¹ã‚’å†·å¾¹ã«ãƒ¬ãƒãƒ¼ãƒˆ
          </label>
          <label style="display:flex;align-items:center;gap:8px;font-size:13px;cursor:pointer;">
            <input type="checkbox" id="tmplLegendMoment" checked style="accent-color:var(--accent-blue);width:16px;height:16px;">
            ğŸ’¥ ä¼èª¬ãƒ»æ­´å²å‹ â€” ã€ä¼èª¬ã€‘æ­´å²çš„å‰æ¥­ã‚’ãƒ‰ãƒ©ãƒãƒãƒƒã‚¯ã«
          </label>
        </div>
        <div class="form-hint" style="margin-top:8px;">ãƒã‚§ãƒƒã‚¯ã‚’å¤–ã—ãŸãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã¯ä½¿ç”¨ã•ã‚Œã¾ã›ã‚“ã€‚æœ€ä½1ã¤ã¯æœ‰åŠ¹ã«ã—ã¦ãã ã•ã„ã€‚8ç¨®ã‚’æœ‰åŠ¹ã«ã™ã‚‹ã¨1æ—¥10ä»¶ã§ã‚‚è¢«ã‚Šã«ãããªã‚Šã¾ã™ã€‚</div>
      </div>
    </div>

    <button class="save-btn" id="savePrefBtn">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h11l5 5v11a2 2 0 01-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
      é¸å®šè¨­å®šã‚’ä¿å­˜
    </button>
    <div class="save-msg" id="prefSaveMsg"></div>
  </div>

  <!-- ===== TAB: PDCA ANALYSIS (PDCAåˆ†æ) ===== -->
  <div class="tab-panel" id="panel-pdca">
    <div class="pdca-grid">
      <!-- æ‰¿èªç‡ -->
      <div class="pdca-card">
        <h4>ğŸ“Š æ‰¿èªç‡</h4>
        <div class="approval-rate-big" id="pdcaApprovalRate">â€”</div>
        <div style="font-size:12px;color:var(--text-muted);margin-top:8px;font-family:var(--font-mono);">
          <span id="pdcaTotalDecisions">0</span> ä»¶ã®åˆ¤æ–­
        </div>
      </div>

      <!-- æ‰¿èª/ã‚¹ã‚­ãƒƒãƒ—å†…è¨³ -->
      <div class="pdca-card">
        <h4>âœ… åˆ¤æ–­å†…è¨³</h4>
        <div style="display:flex;gap:24px;margin-top:8px;">
          <div>
            <div style="font-size:11px;color:var(--text-muted);">æ‰¿èª</div>
            <div style="font-size:28px;font-weight:700;font-family:var(--font-mono);color:var(--accent-green);" id="pdcaApprovedCount">0</div>
          </div>
          <div>
            <div style="font-size:11px;color:var(--text-muted);">ã‚¹ã‚­ãƒƒãƒ—</div>
            <div style="font-size:28px;font-weight:700;font-family:var(--font-mono);color:var(--accent-red);" id="pdcaSkippedCount">0</div>
          </div>
        </div>
      </div>
    </div>

    <!-- ã‚½ãƒ¼ã‚¹åˆ¥æ‰¿èªç‡ -->
    <div class="pdca-card" style="margin-bottom:16px;">
      <h4>ğŸ‘¤ ã‚½ãƒ¼ã‚¹åˆ¥æ‰¿èªç‡</h4>
      <div id="pdcaSourceList">
        <div style="color:var(--text-muted);font-size:13px;">ãƒ‡ãƒ¼ã‚¿ãªã—</div>
      </div>
    </div>

    <!-- ã‚¹ã‚­ãƒƒãƒ—ç†ç”±åˆ†å¸ƒ -->
    <div class="pdca-card" style="margin-bottom:16px;">
      <h4>ğŸ“‹ ã‚¹ã‚­ãƒƒãƒ—ç†ç”±ã®åˆ†å¸ƒ</h4>
      <div id="pdcaReasonBars">
        <div style="color:var(--text-muted);font-size:13px;">ãƒ‡ãƒ¼ã‚¿ãªã—</div>
      </div>
    </div>

    <!-- æœ€æ–°ã®è‡ªå‹•èª¿æ•´ -->
    <div class="pdca-card" style="margin-bottom:16px;">
      <h4>ğŸ”„ æœ€æ–°ã®è‡ªå‹•èª¿æ•´ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</h4>
      <div id="pdcaAdjustments">
        <div style="color:var(--text-muted);font-size:13px;">è‡ªå‹•èª¿æ•´å±¥æ­´ãªã—</div>
      </div>
    </div>
  </div>

  <!-- ===== TAB: SETTINGS ===== -->
  <div class="tab-panel" id="panel-settings">
    <!-- User Profile -->
    <div class="settings-section">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;">
        <h3>ã‚¢ã‚«ã‚¦ãƒ³ãƒˆæƒ…å ±</h3>
        <span class="role-badge client" id="settingsRoleBadge">client</span>
      </div>
      <div style="display:flex;align-items:center;gap:12px;">
        <img class="user-avatar" id="settingsAvatar" src="" alt="" style="width:40px;height:40px;" onerror="this.style.display='none'">
        <div>
          <div style="font-weight:600;" id="settingsName">-</div>
          <div style="font-size:12px;color:var(--text-muted);font-family:var(--font-mono);" id="settingsEmail">-</div>
        </div>
      </div>
    </div>

    <!-- API Keys -->
    <div class="settings-section">
      <h3>APIã‚­ãƒ¼è¨­å®š</h3>
      <p>å„ã‚µãƒ¼ãƒ“ã‚¹ã®APIã‚­ãƒ¼ã‚’ç™»éŒ²ã—ã¦ãã ã•ã„ã€‚ã‚­ãƒ¼ã¯Firestoreã«ã‚»ã‚­ãƒ¥ã‚¢ã«ä¿å­˜ã•ã‚Œã€ã”è‡ªèº«ã®ã¿ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã™ã€‚</p>

      <div class="settings-grid">
        <!-- Gemini API -->
        <div class="form-group">
          <label class="form-label">
            Gemini API Key
            <span class="api-status not-configured" id="statusGemini">æœªè¨­å®š</span>
          </label>
          <input type="password" class="form-input" id="apiGemini" placeholder="AIzaSyxxxxxxxxxxxxxxxxxxxxxxxxx" autocomplete="off">
          <div class="form-hint">aistudio.google.com/apikey ã‹ã‚‰å–å¾—</div>
        </div>

        <!-- Discord Webhook -->
        <div class="form-group">
          <label class="form-label">
            Discord Webhook URL
            <span class="api-status not-configured" id="statusDiscord">æœªè¨­å®š</span>
          </label>
          <input type="password" class="form-input" id="apiDiscord" placeholder="https://discord.com/api/webhooks/..." autocomplete="off">
          <div class="form-hint">Discord ãƒãƒ£ãƒ³ãƒãƒ«è¨­å®š â†’ é€£æºã‚µãƒ¼ãƒ“ã‚¹ â†’ ã‚¦ã‚§ãƒ–ãƒ•ãƒƒã‚¯</div>
        </div>

        <!-- X API (Bearer Token) -->
        <div class="form-group">
          <label class="form-label">
            X API Bearer Token
            <span class="api-status not-configured" id="statusXapi">æœªè¨­å®š</span>
          </label>
          <input type="password" class="form-input" id="apiXbearer" placeholder="AAAAAAAAAAAAAAAAAAAAAxxxxxxx" autocomplete="off">
          <div class="form-hint">developer.x.com ã‹ã‚‰å–å¾—</div>
        </div>

        <!-- X API Key -->
        <div class="form-group">
          <label class="form-label">
            X API Key (Consumer Key)
            <span class="api-status not-configured" id="statusXkey">æœªè¨­å®š</span>
          </label>
          <input type="password" class="form-input" id="apiXkey" placeholder="xxxxxxxxxxxxxxx" autocomplete="off">
        </div>

        <!-- X API Secret -->
        <div class="form-group">
          <label class="form-label">
            X API Secret (Consumer Secret)
            <span class="api-status not-configured" id="statusXsecret">æœªè¨­å®š</span>
          </label>
          <input type="password" class="form-input" id="apiXsecret" placeholder="xxxxxxxxxxxxxxx" autocomplete="off">
        </div>

        <!-- X Access Token -->
        <div class="form-group">
          <label class="form-label">
            X Access Token
            <span class="api-status not-configured" id="statusXaccess">æœªè¨­å®š</span>
          </label>
          <input type="password" class="form-input" id="apiXaccess" placeholder="xxxxxxx-xxxxxxxxxxxxxxx" autocomplete="off">
        </div>

        <!-- X Access Token Secret -->
        <div class="form-group">
          <label class="form-label">
            X Access Token Secret
            <span class="api-status not-configured" id="statusXaccessSecret">æœªè¨­å®š</span>
          </label>
          <input type="password" class="form-input" id="apiXaccessSecret" placeholder="xxxxxxxxxxxxxxx" autocomplete="off">
        </div>
      </div>

      <button class="save-btn" id="saveApiKeys">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h11l5 5v11a2 2 0 01-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
        ä¿å­˜
      </button>
      <div class="save-msg" id="saveMsg"></div>
    </div>

    <!-- Collection Settings -->
    <div class="settings-section">
      <h3>åé›†è¨­å®š</h3>
      <p>ãƒã‚ºãƒ„ã‚¤ãƒ¼ãƒˆè‡ªå‹•åé›†ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’èª¿æ•´ã—ã¾ã™ã€‚å¤‰æ›´ã¯æ¬¡å›ã®åé›†ã‹ã‚‰åæ˜ ã•ã‚Œã¾ã™ã€‚</p>

      <div class="settings-grid">
        <div class="form-group">
          <label class="form-label">1ã‚¯ã‚¨ãƒªã‚ãŸã‚Šæœ€å¤§å–å¾—ä»¶æ•° (max_tweets)</label>
          <input type="number" class="form-input" id="cfgMaxTweets" min="10" max="100" step="10" value="50">
          <div class="form-hint">10ã€œ100ã€‚å¤§ãã„ã»ã©å€™è£œãŒå¢—ãˆã‚‹ãŒAPIè²»ç”¨ã‚‚å¢—åŠ ã€‚30ä»¶å€™è£œã‚’å‡ºã™ãªã‚‰100æ¨å¥¨ã€‚</div>
        </div>

        <div class="form-group">
          <label class="form-label">æœ€ä½ã„ã„ã­æ•° (min_likes)</label>
          <input type="number" class="form-input" id="cfgMinLikes" min="50" max="5000" step="50" value="500">
          <div class="form-hint">Pythonå´ãƒ•ã‚£ãƒ«ã‚¿ã®é–¾å€¤ã€‚300ã«ã™ã‚Œã°å€™è£œæ•°UPã€1000ã«ã™ã‚Œã°å³é¸ã€‚</div>
        </div>

        <div class="form-group">
          <label class="form-label">æœ€å¤§çµŒéæ™‚é–“ (max_age_hours)</label>
          <input type="number" class="form-input" id="cfgMaxAgeHours" min="6" max="168" step="6" value="48">
          <div class="form-hint">ã“ã®æ™‚é–“ä»¥å†…ã®ãƒ„ã‚¤ãƒ¼ãƒˆã®ã¿åé›†ã€‚48h=2æ—¥ã€72h=3æ—¥ã€‚</div>
        </div>
      </div>

      <div id="cfgCostEstimate" style="font-size:12px;color:var(--text-secondary);margin:12px 0 8px;padding:12px;background:var(--bg-input);border-radius:8px;font-family:var(--font-mono);line-height:1.8;"></div>

      <button class="save-btn" id="saveCollectionSettings">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h11l5 5v11a2 2 0 01-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
        åé›†è¨­å®šã‚’ä¿å­˜
      </button>
      <div class="save-msg" id="saveCfgMsg"></div>
    </div>

    <!-- Operation Mode -->
    <div class="settings-section">
      <h3>âš™ï¸ é‹ç”¨ãƒ¢ãƒ¼ãƒ‰</h3>
      <p>æŠ•ç¨¿ã®æ‰¿èªæ–¹æ³•ã‚’é¸æŠã—ã¾ã™ã€‚ãƒ¢ãƒ¼ãƒ‰å¤‰æ›´ã¯å³åº§ã«åæ˜ ã•ã‚Œã¾ã™ã€‚</p>

      <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:16px;">
        <label style="display:flex;gap:14px;padding:20px;background:var(--bg-input);border:2px solid var(--border);border-radius:var(--radius-sm);cursor:pointer;transition:border-color var(--transition-fast);" id="modeCardManual">
          <input type="radio" name="operationMode" value="manual_approval" id="modeManual" checked style="accent-color:var(--accent-blue);margin-top:2px;">
          <div>
            <div style="font-weight:600;margin-bottom:4px;">ğŸ›¡ï¸ åŠè‡ªå‹•ãƒ¢ãƒ¼ãƒ‰ï¼ˆæ‰¿èªåˆ¶ï¼‰</div>
            <div style="font-size:12px;color:var(--text-secondary);line-height:1.6;">
              AIãŒå¼•ç”¨RTã‚³ãƒ¡ãƒ³ãƒˆã‚’ç”Ÿæˆ â†’ ã‚ãªãŸãŒãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã§æ‰¿èª/ã‚¹ã‚­ãƒƒãƒ— â†’ æ‰¿èªã—ãŸã‚‚ã®ã ã‘æŠ•ç¨¿ã€‚å®‰å…¨ã«é‹ç”¨ã§ãã‚‹ã€‚
            </div>
          </div>
        </label>
        <label style="display:flex;gap:14px;padding:20px;background:var(--bg-input);border:2px solid var(--border);border-radius:var(--radius-sm);cursor:pointer;transition:border-color var(--transition-fast);" id="modeCardAuto">
          <input type="radio" name="operationMode" value="full_auto" id="modeAuto" style="accent-color:var(--accent-blue);margin-top:2px;">
          <div>
            <div style="font-weight:600;margin-bottom:4px;">ğŸš€ å®Œå…¨è‡ªå‹•ãƒ¢ãƒ¼ãƒ‰</div>
            <div style="font-size:12px;color:var(--text-secondary);line-height:1.6;">
              AIãŒå¼•ç”¨RTã‚³ãƒ¡ãƒ³ãƒˆã‚’ç”Ÿæˆ â†’ è‡ªå‹•æ‰¿èª â†’ è‡ªå‹•æŠ•ç¨¿ã€‚æ‰¿èªä½œæ¥­ä¸è¦ã€‚åé›†ãƒ»ç”Ÿæˆãƒ»æŠ•ç¨¿ãŒã™ã¹ã¦ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«é€šã‚Šã«è‡ªå‹•å®Ÿè¡Œã•ã‚Œã‚‹ã€‚
            </div>
          </div>
        </label>
      </div>
      <div style="margin-top:12px;font-size:12px;color:var(--text-muted);" id="modeStatus">ç¾åœ¨ã®ãƒ¢ãƒ¼ãƒ‰: <b>åŠè‡ªå‹•ï¼ˆæ‰¿èªåˆ¶ï¼‰</b></div>
      <div class="save-msg" id="modeSaveMsg"></div>
    </div>
  </div>

  <!-- ===== TAB: GUIDE ===== -->
  <div class="tab-panel" id="panel-guide">
    <div class="settings-section">
      <h3>ğŸ“– ã“ã®ãƒ„ãƒ¼ãƒ«ã®ä½¿ã„æ–¹</h3>
      <p style="color:var(--text-secondary);margin-bottom:20px;">Xï¼ˆTwitterï¼‰å¼•ç”¨RTè‡ªå‹•æŠ•ç¨¿ãƒ„ãƒ¼ãƒ«ã®æ“ä½œã‚¬ã‚¤ãƒ‰ã§ã™ã€‚</p>

      <div style="display:flex;flex-direction:column;gap:24px;">

        <!-- Step 0: åˆæœŸè¨­å®š -->
        <div style="background:var(--bg-input);border:1px solid var(--border);border-radius:var(--radius-sm);padding:20px;">
          <div style="font-weight:700;font-size:15px;margin-bottom:8px;">ğŸ”§ ã‚¹ãƒ†ãƒƒãƒ— 0: åˆæœŸè¨­å®š</div>
          <div style="font-size:13px;color:var(--text-secondary);line-height:1.8;">
            1. <b>è¨­å®šã‚¿ãƒ–</b>ã§å„ç¨®APIã‚­ãƒ¼ã‚’ç™»éŒ²<br>
            &nbsp;&nbsp;&nbsp;â€¢ Gemini API Keyï¼ˆã‚³ãƒ¡ãƒ³ãƒˆç”ŸæˆAIï¼‰<br>
            &nbsp;&nbsp;&nbsp;â€¢ X APIå„ç¨®ã‚­ãƒ¼ï¼ˆBearer Token, API Key/Secret, Access Token/Secretï¼‰<br>
            &nbsp;&nbsp;&nbsp;â€¢ Discord Webhook URLï¼ˆé€šçŸ¥ç”¨ãƒ»ä»»æ„ï¼‰<br>
            2. <b>é‹ç”¨ãƒ¢ãƒ¼ãƒ‰</b>ã‚’é¸æŠï¼ˆåŠè‡ªå‹• or å®Œå…¨è‡ªå‹•ï¼‰
          </div>
        </div>

        <!-- Step 1: åé›† -->
        <div style="background:var(--bg-input);border:1px solid var(--border);border-radius:var(--radius-sm);padding:20px;">
          <div style="font-weight:700;font-size:15px;margin-bottom:8px;">ğŸ“¡ ã‚¹ãƒ†ãƒƒãƒ— 1: ãƒã‚ºãƒ„ã‚¤ãƒ¼ãƒˆåé›†</div>
          <div style="font-size:13px;color:var(--text-secondary);line-height:1.8;">
            æµ·å¤–AIç³»ã‚¤ãƒ³ãƒ•ãƒ«ã‚¨ãƒ³ã‚µãƒ¼ã®ãƒã‚ºãƒ„ã‚¤ãƒ¼ãƒˆï¼ˆè‹±èªã€500ã„ã„ã­ä»¥ä¸Šã€48æ™‚é–“ä»¥å†…ï¼‰ã‚’è‡ªå‹•åé›†ã€‚<br>
            â€¢ <b>æ“ä½œã‚¿ãƒ–</b>ã®ã€Œä»Šã™ãåé›†ã€ãƒœã‚¿ãƒ³ â†’ æ‰‹å‹•ã§ã‚‚å®Ÿè¡Œå¯<br>
            â€¢ å®Œå…¨è‡ªå‹•ãƒ¢ãƒ¼ãƒ‰ã§ã¯ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã§è‡ªå‹•å®Ÿè¡Œã•ã‚Œã‚‹<br>
            â€¢ åé›†çµæœã¯<b>ã‚­ãƒ¥ãƒ¼ä¸€è¦§</b>ã‚¿ãƒ–ã«è¡¨ç¤º
          </div>
        </div>

        <!-- Step 2: æ‰¿èª -->
        <div style="background:var(--bg-input);border:1px solid var(--border);border-radius:var(--radius-sm);padding:20px;">
          <div style="font-weight:700;font-size:15px;margin-bottom:8px;">âœ… ã‚¹ãƒ†ãƒƒãƒ— 2: æ‰¿èªï¼ˆåŠè‡ªå‹•ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆï¼‰</div>
          <div style="font-size:13px;color:var(--text-secondary);line-height:1.8;">
            åŠè‡ªå‹•ãƒ¢ãƒ¼ãƒ‰ã§ã¯ã€åé›†ã•ã‚ŒãŸãƒ„ã‚¤ãƒ¼ãƒˆã‚’ã‚ãªãŸãŒç¢ºèªã—ã¦æ‰¿èª/ã‚¹ã‚­ãƒƒãƒ—ã€‚<br>
            â€¢ <b>ã‚­ãƒ¥ãƒ¼ä¸€è¦§</b>ã‚¿ãƒ– â†’ å„ãƒ„ã‚¤ãƒ¼ãƒˆã®ã€Œæ‰¿èªã€orã€Œã‚¹ã‚­ãƒƒãƒ—ã€ãƒœã‚¿ãƒ³<br>
            â€¢ ã‚¹ã‚­ãƒƒãƒ—æ™‚ã¯ç†ç”±ã‚’é¸æŠå¯ï¼ˆçš„å¤–ã‚Œã€é‡è¤‡ã€ä½å“è³ª etcï¼‰<br>
            â€¢ å®Œå…¨è‡ªå‹•ãƒ¢ãƒ¼ãƒ‰ã§ã¯è‡ªå‹•æ‰¿èªã•ã‚Œã‚‹ãŸã‚ã€ã“ã®ã‚¹ãƒ†ãƒƒãƒ—ã¯ä¸è¦
          </div>
        </div>

        <!-- Step 3: AIç”Ÿæˆ -->
        <div style="background:var(--bg-input);border:1px solid var(--border);border-radius:var(--radius-sm);padding:20px;">
          <div style="font-weight:700;font-size:15px;margin-bottom:8px;">âœï¸ ã‚¹ãƒ†ãƒƒãƒ— 3: AIã‚³ãƒ¡ãƒ³ãƒˆç”Ÿæˆ</div>
          <div style="font-size:13px;color:var(--text-secondary);line-height:1.8;">
            æ‰¿èªæ¸ˆã¿ãƒ„ã‚¤ãƒ¼ãƒˆã«å¯¾ã—ã¦ã€AIãŒæ—¥æœ¬èªã®å¼•ç”¨RTã‚³ãƒ¡ãƒ³ãƒˆã‚’è‡ªå‹•ç”Ÿæˆã€‚<br>
            â€¢ 8ç¨®é¡ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆï¼ˆå¸‚å ´ã‚¤ãƒ³ãƒ‘ã‚¯ãƒˆå‹ã€é€Ÿå ±å‹ã€è­¦å‘Šå‹ etcï¼‰ã‚’AIãŒè‡ªå‹•é¸æŠ<br>
            â€¢ <b>é¸å®šè¨­å®š</b>ã‚¿ãƒ–ã§ãƒšãƒ«ã‚½ãƒŠãƒ»ãƒˆãƒ¼ãƒ³ãƒ»NGãƒ¯ãƒ¼ãƒ‰ç­‰ã‚’ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºå¯<br>
            â€¢ <b>æ“ä½œã‚¿ãƒ–</b>ã®ã€Œä»Šã™ãç”Ÿæˆã€ãƒœã‚¿ãƒ³ã§æ‰‹å‹•å®Ÿè¡Œã‚‚å¯
          </div>
        </div>

        <!-- Step 4: æŠ•ç¨¿ -->
        <div style="background:var(--bg-input);border:1px solid var(--border);border-radius:var(--radius-sm);padding:20px;">
          <div style="font-weight:700;font-size:15px;margin-bottom:8px;">ğŸ“¤ ã‚¹ãƒ†ãƒƒãƒ— 4: å¼•ç”¨RTæŠ•ç¨¿</div>
          <div style="font-size:13px;color:var(--text-secondary);line-height:1.8;">
            ç”Ÿæˆã•ã‚ŒãŸã‚³ãƒ¡ãƒ³ãƒˆä»˜ãã§å¼•ç”¨RTã‚’Xã«æŠ•ç¨¿ã€‚<br>
            â€¢ <b>æ“ä½œã‚¿ãƒ–</b>ã®ã€Œä»Šã™ãæŠ•ç¨¿ã€ãƒœã‚¿ãƒ³ã§æ‰‹å‹•å®Ÿè¡Œ<br>
            â€¢ å®Œå…¨è‡ªå‹•ãƒ¢ãƒ¼ãƒ‰ã§ã¯ç”Ÿæˆâ†’æŠ•ç¨¿ãŒé€£ç¶šã§è‡ªå‹•å®Ÿè¡Œã•ã‚Œã‚‹<br>
            â€¢ æŠ•ç¨¿æ¸ˆã¿ã®ãƒ„ã‚¤ãƒ¼ãƒˆã¯<b>æŠ•ç¨¿å±¥æ­´</b>ã‚¿ãƒ–ã§ç¢ºèªå¯
          </div>
        </div>

        <!-- é¸å®šè¨­å®šã®èª¬æ˜ -->
        <div style="background:var(--bg-input);border:1px solid var(--border);border-radius:var(--radius-sm);padding:20px;">
          <div style="font-weight:700;font-size:15px;margin-bottom:8px;">ğŸ¯ ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºï¼ˆé¸å®šè¨­å®šã‚¿ãƒ–ï¼‰</div>
          <div style="font-size:13px;color:var(--text-secondary);line-height:1.8;">
            â€¢ <b>é€±é–“ãƒ•ã‚©ãƒ¼ã‚«ã‚¹</b>: ä»Šé€±ç‰¹ã«æ³¨ç›®ã—ãŸã„ãƒ†ãƒ¼ãƒã‚’æŒ‡å®š<br>
            â€¢ <b>æ³¨ç›®ãƒˆãƒ”ãƒƒã‚¯ / å›é¿ãƒˆãƒ”ãƒƒã‚¯</b>: åé›†ã™ã‚‹ã‚¸ãƒ£ãƒ³ãƒ«ã®å„ªå…ˆåº¦ã‚’èª¿æ•´<br>
            â€¢ <b>ãƒ–ãƒ¼ã‚¹ãƒˆ / ãƒ–ãƒ­ãƒƒã‚¯ ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ</b>: ç‰¹å®šã®æµ·å¤–ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’å„ªå…ˆoré™¤å¤–<br>
            â€¢ <b>å¼•ç”¨RTãƒ—ãƒ­ãƒ³ãƒ—ãƒˆè¨­å®š</b>: ãƒšãƒ«ã‚½ãƒŠåã€å£èª¿ã€NGãƒ¯ãƒ¼ãƒ‰ã€ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆé¸æŠç­‰<br>
            &nbsp;&nbsp;&nbsp;â†’ AIãŒç”Ÿæˆã™ã‚‹ã‚³ãƒ¡ãƒ³ãƒˆã®é›°å›²æ°—ã‚’è‡ªåˆ†å¥½ã¿ã«èª¿æ•´å¯
          </div>
        </div>

        <!-- URLæ‰‹å‹•è¿½åŠ  -->
        <div style="background:var(--bg-input);border:1px solid var(--border);border-radius:var(--radius-sm);padding:20px;">
          <div style="font-weight:700;font-size:15px;margin-bottom:8px;">ğŸ”— ãƒ„ã‚¤ãƒ¼ãƒˆURLæ‰‹å‹•è¿½åŠ </div>
          <div style="font-size:13px;color:var(--text-secondary);line-height:1.8;">
            è‡ªå‹•åé›†ä»¥å¤–ã«ã€å¼•ç”¨RTã—ãŸã„ãƒ„ã‚¤ãƒ¼ãƒˆã®URLã‚’<b>æ“ä½œã‚¿ãƒ–</b>ã‹ã‚‰æ‰‹å‹•ã§è¿½åŠ å¯èƒ½ã€‚<br>
            è¿½åŠ å¾Œã¯ã€ŒAIã‚³ãƒ¡ãƒ³ãƒˆç”Ÿæˆã€â†’ã€Œå¼•ç”¨RTæŠ•ç¨¿ã€ã®é †ã§å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚
          </div>
        </div>

        <!-- ãƒ¢ãƒ¼ãƒ‰èª¬æ˜ -->
        <div style="background:var(--accent-blue-dim);border:1px solid rgba(59,130,246,0.3);border-radius:var(--radius-sm);padding:20px;">
          <div style="font-weight:700;font-size:15px;margin-bottom:8px;">âš¡ é‹ç”¨ãƒ¢ãƒ¼ãƒ‰ã®é•ã„</div>
          <div style="font-size:13px;color:var(--text-secondary);line-height:1.8;">
            <b>ğŸ›¡ï¸ åŠè‡ªå‹•ï¼ˆæ‰¿èªåˆ¶ï¼‰</b>: åé›†â†’<span style="color:var(--accent-amber);">ã‚ãªãŸãŒæ‰¿èª</span>â†’ç”Ÿæˆâ†’æŠ•ç¨¿ã€‚å®‰å…¨ã ãŒæ‰‹é–“ãŒã‹ã‹ã‚‹ã€‚<br>
            <b>ğŸš€ å®Œå…¨è‡ªå‹•</b>: åé›†â†’è‡ªå‹•æ‰¿èªâ†’ç”Ÿæˆâ†’è‡ªå‹•æŠ•ç¨¿ã€‚ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«é€šã‚Šã«å…¨è‡ªå‹•ã§é‹ç”¨ã€‚æ‰‹é–“ã‚¼ãƒ­ã€‚<br>
            <br>
            â†’ <b>è¨­å®šã‚¿ãƒ–</b>ã®ã€Œé‹ç”¨ãƒ¢ãƒ¼ãƒ‰ã€ã§åˆ‡ã‚Šæ›¿ãˆå¯èƒ½ã€‚
          </div>
        </div>

      </div>
    </div>
  </div>

</div>

<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>

<!-- ===== FIREBASE AUTH + FIRESTORE ===== -->
<script>
(function() {
  // ============================
  // Firebase Configuration
  // ============================
  const firebaseConfig = {
    apiKey: "AIzaSyD5qtQwX6w70KmADqJqLngh4uN8G-aZnv8",
    authDomain: "isai-11f7b.firebaseapp.com",
    projectId: "isai-11f7b",
    storageBucket: "isai-11f7b.firebasestorage.app",
    messagingSenderId: "457322161967",
    appId: "1:457322161967:web:132d79d10ac3387b83e3da"
  };

  // ============================
  // Admin UID (ã‚ãªãŸ) â€” Firestoreã«ä¾å­˜ã—ãªã„ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
  // ============================
  // Adminåˆ¤å®šç”¨ â€” X (Twitter) UID ã¾ãŸã¯ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹
  const ADMIN_UIDS = [];
  const ADMIN_EMAILS = ['dbeitian@gmail.com'];

  // ============================
  // Initialize Firebase
  // ============================
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  // Expose for settings tab
  window.__fb = { auth, db };

  // DOM Elements
  const overlay = document.getElementById('loginOverlay');
  const appEl = document.querySelector('.app');
  const xBtn = document.getElementById('xLoginBtn');
  const loginError = document.getElementById('loginError');
  const loginLoading = document.getElementById('loginLoading');

  let currentUser = null;
  let currentUserRole = null;
  let twitterUsername = '';  // @ãƒ¦ãƒ¼ã‚¶ãƒ¼åï¼ˆsignInWithPopupã‹ã‚‰å–å¾—ï¼‰

  // ============================
  // Auth State Listener
  // ============================
  auth.onAuthStateChanged(async (user) => {
    if (user) {
      try {
        // Check/create user doc in Firestore
        const userRef = db.collection('users').doc(user.uid);
        const userDoc = await userRef.get();

        if (!userDoc.exists) {
          // First login â€” check if admin
          const isAdmin = ADMIN_UIDS.includes(user.uid) || ADMIN_EMAILS.includes(user.email);
          await userRef.set({
            email: user.email || '',
            displayName: user.displayName || '',
            photoURL: user.photoURL || '',
            twitterUsername: twitterUsername || '',
            provider: user.providerData[0]?.providerId || 'unknown',
            role: isAdmin ? 'admin' : 'client',
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            lastLoginAt: firebase.firestore.FieldValue.serverTimestamp(),
          });
          currentUserRole = isAdmin ? 'admin' : 'client';
        } else {
          const data = userDoc.data();
          currentUserRole = data.role || 'client';
          // Firestoreã«ä¿å­˜æ¸ˆã¿ã®twitterUsernameã‚’å¾©å…ƒ
          if (data.twitterUsername) twitterUsername = data.twitterUsername;
          // Update last login
          const updateData = {
            lastLoginAt: firebase.firestore.FieldValue.serverTimestamp(),
            displayName: user.displayName || data.displayName,
            photoURL: user.photoURL || data.photoURL,
          };
          // signInWithPopupã§æ–°ãŸã«usernameãŒå–ã‚ŒãŸå ´åˆã¯ä¸Šæ›¸ãä¿å­˜
          if (twitterUsername) updateData.twitterUsername = twitterUsername;
          userRef.update(updateData);
        }

        currentUser = user;

        // Show dashboard
        overlay.style.display = 'none';
        appEl.style.display = 'block';
        addUserInfo(user);
        updateSettingsProfile(user);

        // Load API key status
        loadApiKeyStatus(user.uid);

        // Load dashboard data
        if (typeof initDashboard === 'function') {
          initDashboard();
        }
      } catch (err) {
        console.error('Firestore error:', err);
        // Firestore ãŒæœªè¨­å®šã§ã‚‚ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ â€” admin emailãªã‚‰ãƒ­ã‚°ã‚¤ãƒ³è¨±å¯
        if (ADMIN_UIDS.includes(user.uid) || ADMIN_EMAILS.includes(user.email)) {
          currentUser = user;
          currentUserRole = 'admin';
          overlay.style.display = 'none';
          appEl.style.display = 'block';
          addUserInfo(user);
          if (typeof initDashboard === 'function') initDashboard();
        } else {
          showLoginError('ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ã®ç¢ºèªã«å¤±æ•—ã—ã¾ã—ãŸã€‚ç®¡ç†è€…ã«ãŠå•ã„åˆã‚ã›ãã ã•ã„ã€‚');
          auth.signOut();
        }
      }
    } else {
      // Not authenticated
      currentUser = null;
      currentUserRole = null;
      overlay.style.display = 'flex';
      appEl.style.display = 'none';
      showLoginButtons();
    }
  });

  // ============================
  // X (Twitter) Login
  // ============================
  xBtn.addEventListener('click', () => loginWith('twitter'));

  async function loginWith(providerName) {
    loginError.style.display = 'none';
    xBtn.style.display = 'none';
    loginLoading.style.display = 'block';

    try {
      const provider = new firebase.auth.TwitterAuthProvider();
      const result = await auth.signInWithPopup(provider);
      // Twitter @username ã‚’ã‚­ãƒ£ãƒ—ãƒãƒ£ï¼ˆsignInWithPopupã§ã®ã¿å–å¾—å¯èƒ½ï¼‰
      if (result.additionalUserInfo && result.additionalUserInfo.username) {
        twitterUsername = result.additionalUserInfo.username;
        // Firestoreã«ã‚‚ä¿å­˜
        try {
          await db.collection('users').doc(result.user.uid).set({
            twitterUsername: twitterUsername,
          }, { merge: true });
        } catch (e) { console.warn('Twitter username save failed:', e); }
      }
    } catch (err) {
      if (err.code === 'auth/popup-blocked') {
        try {
          const provider = new firebase.auth.TwitterAuthProvider();
          await auth.signInWithRedirect(provider);
          return;
        } catch (redirectErr) {
          showLoginError('ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + redirectErr.message);
        }
      } else if (err.code === 'auth/operation-not-allowed') {
        showLoginError('Xï¼ˆTwitterï¼‰ãƒ­ã‚°ã‚¤ãƒ³ã¯ç¾åœ¨ç„¡åŠ¹ã§ã™ã€‚ç®¡ç†è€…ãŒ Firebase Console ã§æœ‰åŠ¹åŒ–ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚');
      } else if (err.code === 'auth/cancelled-popup-request') {
        // è¤‡æ•°ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãŒé–‹ã‹ã‚ŒãŸå ´åˆã€ç„¡è¦–
      } else if (err.code === 'auth/network-request-failed') {
        showLoginError('ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
      } else if (err.code !== 'auth/popup-closed-by-user') {
        showLoginError('ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + err.message);
      }
      xBtn.style.display = 'inline-flex';
      loginLoading.style.display = 'none';
    }
  }

  // ============================
  // Helpers
  // ============================
  function showLoginError(msg) {
    loginError.textContent = msg;
    loginError.style.display = 'block';
    showLoginButtons();
    loginLoading.style.display = 'none';
  }

  function showLoginButtons() {
    xBtn.style.display = 'inline-flex';
  }

  function addUserInfo(user) {
    const headerRight = document.querySelector('.header-right');
    if (!headerRight || document.getElementById('userInfo')) return;

    const div = document.createElement('div');
    div.id = 'userInfo';
    div.className = 'user-info';

    const photoUrl = user.photoURL || '';
    const displayName = twitterUsername ? ('@' + twitterUsername) : (user.displayName || user.email || '');

    div.innerHTML =
      (photoUrl ? '<img class="user-avatar" src="' + photoUrl + '" alt="" onerror="this.style.display=\'none\'">' : '') +
      '<span class="user-name">' + displayName + '</span>' +
      '<button class="logout-btn" id="logoutBtn">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>';

    headerRight.appendChild(div);
    document.getElementById('logoutBtn').addEventListener('click', () => {
      const userInfoEl = document.getElementById('userInfo');
      if (userInfoEl) userInfoEl.remove();
      auth.signOut();
    });
  }

  function updateSettingsProfile(user) {
    const avatar = document.getElementById('settingsAvatar');
    const name = document.getElementById('settingsName');
    const email = document.getElementById('settingsEmail');
    const badge = document.getElementById('settingsRoleBadge');

    if (avatar) avatar.src = user.photoURL || '';
    if (name) name.textContent = user.displayName || user.email || '-';
    if (email) email.textContent = twitterUsername ? ('@' + twitterUsername) : (user.email || user.uid);
    if (badge) {
      badge.textContent = currentUserRole || 'client';
      badge.className = 'role-badge ' + (currentUserRole === 'admin' ? 'admin' : 'client');
    }
  }

  // ============================
  // API Key Management
  // ============================
  const API_KEY_FIELDS = [
    { id: 'apiGemini', key: 'gemini_api_key', statusId: 'statusGemini' },
    { id: 'apiDiscord', key: 'discord_webhook_url', statusId: 'statusDiscord' },
    { id: 'apiXbearer', key: 'x_bearer_token', statusId: 'statusXapi' },
    { id: 'apiXkey', key: 'x_api_key', statusId: 'statusXkey' },
    { id: 'apiXsecret', key: 'x_api_secret', statusId: 'statusXsecret' },
    { id: 'apiXaccess', key: 'x_access_token', statusId: 'statusXaccess' },
    { id: 'apiXaccessSecret', key: 'x_access_token_secret', statusId: 'statusXaccessSecret' },
  ];

  async function loadApiKeyStatus(uid) {
    try {
      const doc = await db.collection('api_keys').doc(uid).get();
      if (doc.exists) {
        const data = doc.data();
        API_KEY_FIELDS.forEach(f => {
          const statusEl = document.getElementById(f.statusId);
          if (statusEl) {
            if (data[f.key]) {
              statusEl.textContent = 'è¨­å®šæ¸ˆã¿';
              statusEl.className = 'api-status configured';
            } else {
              statusEl.textContent = 'æœªè¨­å®š';
              statusEl.className = 'api-status not-configured';
            }
          }
        });
      }
    } catch (err) {
      console.warn('API key status load failed:', err);
    }
  }

  // Save API Keys
  const saveBtn = document.getElementById('saveApiKeys');
  const saveMsg = document.getElementById('saveMsg');

  if (saveBtn) {
    saveBtn.addEventListener('click', async () => {
      if (!currentUser) return;
      saveBtn.disabled = true;
      saveMsg.className = 'save-msg';
      saveMsg.style.display = 'none';

      try {
        const updates = {};
        let hasUpdate = false;

        API_KEY_FIELDS.forEach(f => {
          const input = document.getElementById(f.id);
          if (input && input.value.trim()) {
            updates[f.key] = input.value.trim();
            hasUpdate = true;
          }
        });

        if (!hasUpdate) {
          saveMsg.textContent = 'å¤‰æ›´ã™ã‚‹ã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„';
          saveMsg.className = 'save-msg error';
          saveBtn.disabled = false;
          return;
        }

        updates.updatedAt = firebase.firestore.FieldValue.serverTimestamp();
        updates.uid = currentUser.uid;

        await db.collection('api_keys').doc(currentUser.uid).set(updates, { merge: true });

        // Clear inputs & refresh status
        API_KEY_FIELDS.forEach(f => {
          const input = document.getElementById(f.id);
          if (input) input.value = '';
        });

        await loadApiKeyStatus(currentUser.uid);

        saveMsg.textContent = 'APIã‚­ãƒ¼ã‚’ä¿å­˜ã—ã¾ã—ãŸ';
        saveMsg.className = 'save-msg success';
        if (window.showToast) showToast('APIã‚­ãƒ¼ã‚’ä¿å­˜ã—ã¾ã—ãŸ', 'success');
      } catch (err) {
        console.error('Save API keys error:', err);
        saveMsg.textContent = 'ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + err.message;
        saveMsg.className = 'save-msg error';
        if (window.showToast) showToast('APIã‚­ãƒ¼ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
      }

      saveBtn.disabled = false;
    });
  }

  // ============================
  // Collection Settings
  // ============================
  const cfgMaxTweets = document.getElementById('cfgMaxTweets');
  const cfgMinLikes = document.getElementById('cfgMinLikes');
  const cfgMaxAgeHours = document.getElementById('cfgMaxAgeHours');
  const cfgCostEstimate = document.getElementById('cfgCostEstimate');
  const saveCfgBtn = document.getElementById('saveCollectionSettings');
  const saveCfgMsg = document.getElementById('saveCfgMsg');

  function updateCostEstimate() {
    const mt = parseInt(cfgMaxTweets.value) || 50;
    const ml = parseInt(cfgMinLikes.value) || 500;
    const queries = 3; // 20 accounts / 8 per chunk
    const totalReads = queries * mt;
    const costPerRun = (totalReads * 0.005).toFixed(2);
    const costPerMonth = (costPerRun * 30).toFixed(0);
    // Rough survival estimate based on min_likes threshold
    var survivalPct;
    if (ml <= 100) survivalPct = 25;
    else if (ml <= 300) survivalPct = 12;
    else if (ml <= 500) survivalPct = 6;
    else if (ml <= 1000) survivalPct = 3;
    else survivalPct = 1;
    const estCandidates = Math.round(totalReads * survivalPct / 100);
    if (cfgCostEstimate) {
      cfgCostEstimate.innerHTML =
        'APIå–å¾—: ' + queries + 'ã‚¯ã‚¨ãƒª x ' + mt + 'ä»¶ = <b>' + totalReads + 'ä»¶/å›</b><br>' +
        'ã‚³ã‚¹ãƒˆ: $' + costPerRun + '/å› â‰ˆ <b>$' + costPerMonth + '/æœˆ</b> (1æ—¥1å›)<br>' +
        'ãƒ•ã‚£ãƒ«ã‚¿å¾Œå€™è£œ: æ¨å®š <b>~' + estCandidates + 'ä»¶</b> (min_likes=' + ml + ')';
    }
  }

  if (cfgMaxTweets) cfgMaxTweets.addEventListener('input', updateCostEstimate);
  if (cfgMinLikes) cfgMinLikes.addEventListener('input', updateCostEstimate);
  updateCostEstimate();

  async function loadCollectionSettings(uid) {
    try {
      var doc = await db.collection('selection_preferences').doc(uid).get();
      if (doc.exists) {
        var data = doc.data();
        if (data.max_tweets_override && cfgMaxTweets) cfgMaxTweets.value = data.max_tweets_override;
        if (data.min_likes_override && cfgMinLikes) cfgMinLikes.value = data.min_likes_override;
        if (data.max_age_hours_override && cfgMaxAgeHours) cfgMaxAgeHours.value = data.max_age_hours_override;
        updateCostEstimate();
      }
    } catch (err) {
      console.warn('Collection settings load failed:', err);
    }
  }

  if (saveCfgBtn) {
    saveCfgBtn.addEventListener('click', async function() {
      if (!currentUser) return;
      saveCfgBtn.disabled = true;
      if (saveCfgMsg) { saveCfgMsg.className = 'save-msg'; saveCfgMsg.style.display = 'none'; }

      try {
        var updates = {
          max_tweets_override: String(parseInt(cfgMaxTweets.value) || 50),
          min_likes_override: String(parseInt(cfgMinLikes.value) || 500),
          max_age_hours_override: String(parseInt(cfgMaxAgeHours.value) || 48),
          updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
          uid: currentUser.uid,
        };

        await db.collection('selection_preferences').doc(currentUser.uid).set(updates, { merge: true });

        if (saveCfgMsg) {
          saveCfgMsg.textContent = 'åé›†è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸï¼ˆæ¬¡å›åé›†ã‹ã‚‰åæ˜ ï¼‰';
          saveCfgMsg.className = 'save-msg success';
        }
        if (window.showToast) showToast('åé›†è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ', 'success');
      } catch (err) {
        console.error('Save collection settings error:', err);
        if (saveCfgMsg) {
          saveCfgMsg.textContent = 'ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + err.message;
          saveCfgMsg.className = 'save-msg error';
        }
        if (window.showToast) showToast('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
      }

      saveCfgBtn.disabled = false;
    });
  }

  // Load collection settings after auth
  auth.onAuthStateChanged(function(u) {
    if (u) {
      loadCollectionSettings(u.uid);
      loadOperationMode(u.uid);
    }
  });

  // ============================
  // Operation Mode Switcher
  // ============================
  const modeManualRadio = document.getElementById('modeManual');
  const modeAutoRadio = document.getElementById('modeAuto');
  const modeCardManual = document.getElementById('modeCardManual');
  const modeCardAuto = document.getElementById('modeCardAuto');
  const modeStatus = document.getElementById('modeStatus');
  const modeSaveMsg = document.getElementById('modeSaveMsg');

  function updateModeCardStyle() {
    if (!modeCardManual || !modeCardAuto) return;
    if (modeManualRadio && modeManualRadio.checked) {
      modeCardManual.style.borderColor = 'var(--accent-blue)';
      modeCardManual.style.background = 'var(--accent-blue-dim)';
      modeCardAuto.style.borderColor = 'var(--border)';
      modeCardAuto.style.background = 'var(--bg-input)';
      if (modeStatus) modeStatus.innerHTML = 'ç¾åœ¨ã®ãƒ¢ãƒ¼ãƒ‰: <b style="color:var(--accent-blue);">ğŸ›¡ï¸ åŠè‡ªå‹•ï¼ˆæ‰¿èªåˆ¶ï¼‰</b>';
    } else {
      modeCardAuto.style.borderColor = 'var(--accent-green)';
      modeCardAuto.style.background = 'var(--accent-green-dim)';
      modeCardManual.style.borderColor = 'var(--border)';
      modeCardManual.style.background = 'var(--bg-input)';
      if (modeStatus) modeStatus.innerHTML = 'ç¾åœ¨ã®ãƒ¢ãƒ¼ãƒ‰: <b style="color:var(--accent-green);">ğŸš€ å®Œå…¨è‡ªå‹•</b>';
    }
  }

  async function saveOperationMode(mode) {
    if (!currentUser) return;
    try {
      await db.collection('selection_preferences').doc(currentUser.uid).set({
        operation_mode: mode,
        mode_updated_at: firebase.firestore.FieldValue.serverTimestamp(),
      }, { merge: true });

      if (modeSaveMsg) {
        modeSaveMsg.textContent = 'ãƒ¢ãƒ¼ãƒ‰ã‚’ã€Œ' + (mode === 'full_auto' ? 'å®Œå…¨è‡ªå‹•' : 'åŠè‡ªå‹•ï¼ˆæ‰¿èªåˆ¶ï¼‰') + 'ã€ã«å¤‰æ›´ã—ã¾ã—ãŸ';
        modeSaveMsg.className = 'save-msg success';
        setTimeout(() => { modeSaveMsg.className = 'save-msg'; }, 3000);
      }
    } catch (err) {
      console.error('Save mode error:', err);
      if (modeSaveMsg) {
        modeSaveMsg.textContent = 'ãƒ¢ãƒ¼ãƒ‰ä¿å­˜ã«å¤±æ•—: ' + err.message;
        modeSaveMsg.className = 'save-msg error';
      }
    }
  }

  async function loadOperationMode(uid) {
    try {
      var doc = await db.collection('selection_preferences').doc(uid).get();
      if (doc.exists) {
        var mode = doc.data().operation_mode || 'manual_approval';
        if (mode === 'full_auto' && modeAutoRadio) {
          modeAutoRadio.checked = true;
        } else if (modeManualRadio) {
          modeManualRadio.checked = true;
        }
      }
      updateModeCardStyle();
    } catch (err) {
      console.warn('Load mode failed:', err);
      updateModeCardStyle();
    }
  }

  if (modeManualRadio) {
    modeManualRadio.addEventListener('change', function() {
      updateModeCardStyle();
      saveOperationMode('manual_approval');
    });
  }
  if (modeAutoRadio) {
    modeAutoRadio.addEventListener('change', function() {
      updateModeCardStyle();
      saveOperationMode('full_auto');
    });
  }

  // Initial card style
  updateModeCardStyle();
})();
</script>

<script>
/* ===========================================
   DASHBOARD APP
   =========================================== */

const DATA_URL_FALLBACK = './dashboard-data.json';
let currentFilter = 'all';
let dashboardData = null;
let metricsChartInstance = null;
let dashboardInitialized = false;

// --- Init (called by auth after login) ---
function initDashboard() {
  if (dashboardInitialized) return;
  dashboardInitialized = true;
  initTabs();
  initFilters();
  loadData();
}

// --- Tab switching ---
function initTabs() {
  document.querySelectorAll('.tab').forEach(tab => {
    tab.addEventListener('click', () => {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
      tab.classList.add('active');
      document.getElementById('panel-' + tab.dataset.tab).classList.add('active');
    });
  });
}

// --- Filter buttons ---
function initFilters() {
  document.querySelectorAll('.filter-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      currentFilter = btn.dataset.filter;
      renderQueue();
    });
  });
}

// --- Load data ---
async function loadData() {
  const container = document.getElementById('queueTbody');
  container.innerHTML = '<tr><td colspan="6"><div class="loading"><div class="spinner"></div><div class="loading-text">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</div></div></td></tr>';

  try {
    // Firestore dashboard_data/{uid} ã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼åˆ¥ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€
    let loaded = false;
    if (window.__fb && window.__fb.auth.currentUser) {
      try {
        const uid = window.__fb.auth.currentUser.uid;
        const doc = await window.__fb.db.collection('dashboard_data').doc(uid).get();
        if (doc.exists) {
          dashboardData = doc.data();
          loaded = true;
        }
      } catch (fsErr) {
        console.warn('Firestore dashboard load failed, trying fallback:', fsErr);
      }
    }

    // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: é™çš„JSONãƒ•ã‚¡ã‚¤ãƒ«
    if (!loaded) {
      const res = await fetch(DATA_URL_FALLBACK);
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      dashboardData = await res.json();
    }

    render();
  } catch (err) {
    container.innerHTML = `<tr><td colspan="6">
      <div class="error-state">
        <svg class="empty-state-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z"/></svg>
        <h3>ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</h3>
        <p>dashboard-data.json ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§ãƒ‡ãƒ¼ã‚¿ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„:</p>
        <code>python -m src.main export-dashboard</code>
      </div>
    </td></tr>`;
  }
}

// --- Render all ---
function render() {
  if (!dashboardData) return;
  renderKPI();
  renderQueue();
  renderPosted();
  renderMetrics();
  renderPreferences();
  renderPDCA();
  renderUpdatedTime();
}

// --- KPI ---
function renderKPI() {
  const s = dashboardData.stats;
  document.getElementById('kpiPending').textContent = s.pending ?? 0;
  document.getElementById('kpiApproved').textContent = s.approved ?? 0;
  document.getElementById('kpiPostedToday').textContent = s.posted_today ?? 0;
  document.getElementById('kpiPostedTotal').textContent = s.posted_total ?? 0;
  document.getElementById('kpiSkipped').textContent = s.skipped ?? 0;
}

// --- Queue table ---
function renderQueue() {
  const tbody = document.getElementById('queueTbody');
  if (!dashboardData || !dashboardData.queue) {
    tbody.innerHTML = '<tr><td colspan="7"><div class="empty-state"><svg class="empty-state-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M21.75 6.75v10.5a2.25 2.25 0 01-2.25 2.25h-15a2.25 2.25 0 01-2.25-2.25V6.75m19.5 0A2.25 2.25 0 0019.5 4.5h-15a2.25 2.25 0 00-2.25 2.25m19.5 0v.243a2.25 2.25 0 01-1.07 1.916l-7.5 4.615a2.25 2.25 0 01-2.36 0L3.32 8.91a2.25 2.25 0 01-1.07-1.916V6.75"/></svg><h3>ã‚­ãƒ¥ãƒ¼ãŒç©ºã§ã™</h3><p>collectã‚³ãƒãƒ³ãƒ‰ã§ãƒã‚ºãƒ„ã‚¤ãƒ¼ãƒˆã‚’åé›†ã—ã¦ãã ã•ã„</p></div></td></tr>';
    return;
  }

  let items = dashboardData.queue;
  if (currentFilter !== 'all') {
    items = items.filter(i => i.status === currentFilter);
  }

  if (items.length === 0) {
    tbody.innerHTML = `<tr><td colspan="7"><div class="empty-state"><svg class="empty-state-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z"/></svg><h3>è©²å½“ã™ã‚‹ã‚¢ã‚¤ãƒ†ãƒ ãŒã‚ã‚Šã¾ã›ã‚“</h3></div></td></tr>`;
    return;
  }

  // Sort: pending first, then approved, then others
  const order = { pending: 0, approved: 1, skipped: 2 };
  items = [...items].sort((a, b) => (order[a.status] ?? 9) - (order[b.status] ?? 9));

  tbody.innerHTML = items.map(item => {
    const statusClass = `status-${item.status}`;
    const statusLabel = { pending: 'æ‰¿èªå¾…ã¡', approved: 'æ‰¿èªæ¸ˆã¿', skipped: 'ã‚¹ã‚­ãƒƒãƒ—', generated: 'ç”Ÿæˆæ¸ˆã¿' }[item.status] || item.status;

    const originalText = item.original_text || item.text || '-';
    const generatedText = item.generated_text || '';
    const tweetId = item.tweet_id || '';
    const tweetUrl = tweetId ? `https://x.com/i/status/${tweetId}` : '#';

    const likes = item.likes ?? item.favorite_count ?? '-';
    const rts = item.retweets ?? item.retweet_count ?? '-';
    const addedAt = item.added_at ? formatTime(item.added_at) : '-';

    // Match score
    const matchScore = item.preference_match_score ?? 0;
    const scoreClass = matchScore >= 2.0 ? 'high' : matchScore >= 1.0 ? 'medium' : 'low';
    const scoreDisplay = matchScore > 0 ? matchScore.toFixed(1) : 'â€”';

    // Action buttons
    let actionHtml = '';
    const deleteBtn = `<button class="action-btn delete" onclick="event.stopPropagation();queueDelete('${tweetId}')" title="å‰Šé™¤">ğŸ—‘</button>`;
    if (item.status === 'pending') {
      actionHtml = `<div class="queue-actions" onclick="event.stopPropagation()">
        <button class="action-btn approve" onclick="queueAction('approve','${tweetId}')">âœ“ æ‰¿èª</button>
        <div style="position:relative;display:inline-block;">
          <button class="action-btn skip" onclick="toggleSkipMenu(this)">âœ• ã‚¹ã‚­ãƒƒãƒ— â–¾</button>
          <div class="skip-dropdown">
            <button class="skip-option" onclick="queueAction('skip','${tweetId}','topic_mismatch')">ãƒˆãƒ”ãƒƒã‚¯ä¸ä¸€è‡´</button>
            <button class="skip-option" onclick="queueAction('skip','${tweetId}','source_untrusted')">ã‚½ãƒ¼ã‚¹ä¸é©åˆ‡</button>
            <button class="skip-option" onclick="queueAction('skip','${tweetId}','too_old')">å¤ã™ãã‚‹</button>
            <button class="skip-option" onclick="queueAction('skip','${tweetId}','low_quality')">å“è³ªä¸è¶³</button>
            <button class="skip-option" onclick="queueAction('skip','${tweetId}','off_brand')">ãƒ–ãƒ©ãƒ³ãƒ‰ä¸é©åˆ</button>
            <button class="skip-option" onclick="queueAction('skip','${tweetId}','other')">ãã®ä»–</button>
          </div>
        </div>
        ${deleteBtn}
      </div>`;
    } else if (item.status === 'skipped' && item.skip_reason) {
      const reasonLabels = { topic_mismatch:'ãƒˆãƒ”ãƒƒã‚¯ä¸ä¸€è‡´', source_untrusted:'ã‚½ãƒ¼ã‚¹ä¸é©åˆ‡', too_old:'å¤ã„', low_quality:'å“è³ªä¸è¶³', off_brand:'ãƒ–ãƒ©ãƒ³ãƒ‰ä¸é©åˆ', other:'ãã®ä»–' };
      actionHtml = `<div class="queue-actions" onclick="event.stopPropagation()"><span style="font-size:11px;color:var(--text-muted);">${reasonLabels[item.skip_reason] || item.skip_reason}</span> ${deleteBtn}</div>`;
    } else {
      actionHtml = `<div class="queue-actions" onclick="event.stopPropagation()">${tweetId ? `<a class="external-link" href="${tweetUrl}" target="_blank" rel="noopener">â†—</a>` : ''} ${deleteBtn}</div>`;
    }

    const rowIndex = dashboardData.queue.indexOf(item);
    return `<tr onclick="openQueueModal(${rowIndex})" data-queue-idx="${rowIndex}">
      <td><span class="status ${statusClass}">${statusLabel}</span></td>
      <td><div class="tweet-text" title="${escapeHtml(originalText)}">${escapeHtml(truncate(originalText, 60))}</div></td>
      <td><div class="tweet-text ${generatedText ? 'generated' : ''}" title="${escapeHtml(generatedText)}">${generatedText ? escapeHtml(truncate(generatedText, 50)) : '<span style="color:var(--text-muted)">æœªç”Ÿæˆ</span>'}</div></td>
      <td><div class="tweet-metrics"><span><svg width="13" height="13" viewBox="0 0 24 24" fill="currentColor" style="vertical-align:-2px;opacity:0.7"><path d="M11.645 20.91l-.007-.003-.022-.012a15.247 15.247 0 01-.383-.218 25.18 25.18 0 01-4.244-3.17C4.688 15.36 2.25 12.174 2.25 8.25 2.25 5.322 4.714 3 7.688 3A5.5 5.5 0 0112 5.052 5.5 5.5 0 0116.313 3c2.973 0 5.437 2.322 5.437 5.25 0 3.925-2.438 7.111-4.739 9.256a25.175 25.175 0 01-4.244 3.17 15.247 15.247 0 01-.383.219l-.022.012-.007.004-.003.001a.752.752 0 01-.704 0l-.003-.001z"/></svg> ${formatNum(likes)}</span><span><svg width="13" height="13" viewBox="0 0 24 24" fill="currentColor" style="vertical-align:-2px;opacity:0.7"><path d="M19.902 4.098a3.75 3.75 0 00-5.304 0l-4.5 4.5a3.75 3.75 0 001.035 6.037.75.75 0 01-.646 1.353 5.25 5.25 0 01-1.449-8.45l4.5-4.5a5.25 5.25 0 117.424 7.424l-1.757 1.757a.75.75 0 11-1.06-1.06l1.757-1.757a3.75 3.75 0 000-5.304zm-7.389 4.267a.75.75 0 011-.353 5.25 5.25 0 011.449 8.45l-4.5 4.5a5.25 5.25 0 11-7.424-7.424l1.757-1.757a.75.75 0 111.06 1.06l-1.757 1.757a3.75 3.75 0 105.304 5.304l4.5-4.5a3.75 3.75 0 00-1.035-6.037.75.75 0 01-.354-1z"/></svg> ${formatNum(rts)}</span></div></td>
      <td><span class="match-score ${scoreClass}" title="ãƒ—ãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹ãƒãƒƒãƒã‚¹ã‚³ã‚¢">âš¡ ${scoreDisplay}</span></td>
      <td><span class="tweet-meta">${addedAt}</span></td>
      <td>${actionHtml}</td>
    </tr>`;
  }).join('');
}

// --- Queue Detail Modal ---
let currentModalItem = null;

function openQueueModal(idx) {
  if (!dashboardData || !dashboardData.queue || !dashboardData.queue[idx]) return;
  const item = dashboardData.queue[idx];
  currentModalItem = item;

  const modal = document.getElementById('queueModal');
  const tweetId = item.tweet_id || '';
  const tweetUrl = item.url || (tweetId ? `https://x.com/i/status/${tweetId}` : '#');
  const authorHandle = item.author_username || '';
  const authorName = item.author_name || authorHandle || 'ä¸æ˜';

  // Status
  const statusLabels = { pending: 'æ‰¿èªå¾…ã¡', approved: 'æ‰¿èªæ¸ˆã¿', skipped: 'ã‚¹ã‚­ãƒƒãƒ—', generated: 'ç”Ÿæˆæ¸ˆã¿' };
  const statusLabel = statusLabels[item.status] || item.status;
  document.getElementById('modalStatus').innerHTML = `<span class="status status-${item.status}">${statusLabel}</span>`;

  // Author
  document.getElementById('modalAuthor').innerHTML = authorHandle
    ? `<span>ğŸ‘¤</span> <a href="https://x.com/${authorHandle}" target="_blank" rel="noopener">@${escapeHtml(authorHandle)}</a> <span style="color:var(--text-muted);">${escapeHtml(authorName)}</span>`
    : `<span style="color:var(--text-muted);">æŠ•ç¨¿è€…ä¸æ˜</span>`;

  // Metrics
  const likes = item.likes ?? item.favorite_count ?? 0;
  const rts = item.retweets ?? item.retweet_count ?? 0;
  const replies = item.replies ?? 0;
  const quotes = item.quotes ?? 0;
  const bookmarks = item.bookmarks ?? 0;

  let metricsHtml = `
    <div class="modal-metric"><span class="metric-icon">â¤ï¸</span><span class="metric-val">${formatNum(likes)}</span><span class="metric-label">ã„ã„ã­</span></div>
    <div class="modal-metric"><span class="metric-icon">ğŸ”</span><span class="metric-val">${formatNum(rts)}</span><span class="metric-label">ãƒªãƒ„ã‚¤ãƒ¼ãƒˆ</span></div>
    <div class="modal-metric"><span class="metric-icon">ğŸ’¬</span><span class="metric-val">${formatNum(replies)}</span><span class="metric-label">ãƒªãƒ—ãƒ©ã‚¤</span></div>`;
  if (quotes > 0) metricsHtml += `<div class="modal-metric"><span class="metric-icon">ğŸ”—</span><span class="metric-val">${formatNum(quotes)}</span><span class="metric-label">å¼•ç”¨</span></div>`;
  if (bookmarks > 0) metricsHtml += `<div class="modal-metric"><span class="metric-icon">ğŸ”–</span><span class="metric-val">${formatNum(bookmarks)}</span><span class="metric-label">ãƒ–ã‚¯ãƒ</span></div>`;
  document.getElementById('modalMetrics').innerHTML = metricsHtml;

  // Original text
  const originalText = item.original_text || item.text || '';
  document.getElementById('modalOriginalText').textContent = originalText || 'ï¼ˆãƒ†ã‚­ã‚¹ãƒˆãªã—ï¼‰';

  // Japanese summary â€” simple inline translation hint
  const jpSummary = document.getElementById('modalJpSummary');
  if (originalText && originalText.length > 0 && /[a-zA-Z]/.test(originalText)) {
    // ç°¡æ˜“æ—¥æœ¬èªè¦ç´„ï¼ˆã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰ï¼‰: è‹±èªãƒ†ã‚­ã‚¹ãƒˆãŒã‚ã‚‹å ´åˆã«è¡¨ç¤º
    jpSummary.style.display = 'block';
    jpSummary.innerHTML = 'ğŸ‡¯ğŸ‡µ <b>æ—¥æœ¬èªè¦ç´„</b>: <span id="jpSummaryText" style="opacity:0.8;">è¦ç´„ã‚’ç”Ÿæˆä¸­...</span>';
    // Gemini APIã‚­ãƒ¼ãŒã‚ã‚Œã°ç¿»è¨³å®Ÿè¡Œã€ãªã‘ã‚Œã°çœç•¥
    generateJpSummary(originalText);
  } else {
    jpSummary.style.display = 'none';
  }

  // Generated text
  const generatedText = item.generated_text || '';
  const genSection = document.getElementById('modalGeneratedSection');
  if (generatedText) {
    genSection.style.display = 'block';
    document.getElementById('modalGeneratedText').textContent = generatedText;
  } else {
    genSection.style.display = 'none';
  }

  // Additional info
  document.getElementById('modalAddedAt').textContent = item.added_at ? 'ğŸ“… è¿½åŠ : ' + formatTime(item.added_at) : '';
  document.getElementById('modalSource').textContent = item.source ? 'ğŸ“¡ ã‚½ãƒ¼ã‚¹: ' + item.source : '';
  document.getElementById('modalTemplate').textContent = item.template_id ? 'ğŸ“ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ: ' + item.template_id : '';
  const matchScore = item.preference_match_score ?? item.score ?? 0;
  document.getElementById('modalScore').textContent = matchScore > 0 ? 'âš¡ ãƒãƒƒãƒã‚¹ã‚³ã‚¢: ' + Number(matchScore).toFixed(1) : '';

  // Footer actions
  const footer = document.getElementById('modalFooter');
  if (item.status === 'pending') {
    footer.innerHTML = `
      <button class="action-btn approve" onclick="modalAction('approve','${tweetId}')">âœ“ æ‰¿èªã™ã‚‹</button>
      <div style="position:relative;display:inline-block;">
        <button class="action-btn skip" onclick="toggleSkipMenu(this)">âœ• ã‚¹ã‚­ãƒƒãƒ— â–¾</button>
        <div class="skip-dropdown">
          <button class="skip-option" onclick="modalAction('skip','${tweetId}','topic_mismatch')">ãƒˆãƒ”ãƒƒã‚¯ä¸ä¸€è‡´</button>
          <button class="skip-option" onclick="modalAction('skip','${tweetId}','source_untrusted')">ã‚½ãƒ¼ã‚¹ä¸é©åˆ‡</button>
          <button class="skip-option" onclick="modalAction('skip','${tweetId}','too_old')">å¤ã™ãã‚‹</button>
          <button class="skip-option" onclick="modalAction('skip','${tweetId}','low_quality')">å“è³ªä¸è¶³</button>
          <button class="skip-option" onclick="modalAction('skip','${tweetId}','off_brand')">ãƒ–ãƒ©ãƒ³ãƒ‰ä¸é©åˆ</button>
          <button class="skip-option" onclick="modalAction('skip','${tweetId}','other')">ãã®ä»–</button>
        </div>
      </div>
      <a class="modal-tweet-link" href="${tweetUrl}" target="_blank" rel="noopener">å…ƒãƒ„ã‚¤ãƒ¼ãƒˆã‚’é–‹ã â†—</a>`;
  } else {
    footer.innerHTML = `<a class="modal-tweet-link" href="${tweetUrl}" target="_blank" rel="noopener" style="margin-left:0;">å…ƒãƒ„ã‚¤ãƒ¼ãƒˆã‚’é–‹ã â†—</a>`;
  }

  modal.classList.add('show');
  document.body.style.overflow = 'hidden';
}

function closeQueueModal() {
  document.getElementById('queueModal').classList.remove('show');
  document.body.style.overflow = '';
  currentModalItem = null;
}

// Close modal on overlay click or Escape
document.getElementById('queueModal').addEventListener('click', function(e) {
  if (e.target === this) closeQueueModal();
});
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') closeQueueModal();
});

async function modalAction(action, tweetId, reason) {
  await queueAction(action, tweetId, reason);
  closeQueueModal();
}

// --- Japanese summary (simple Gemini call if API key available) ---
async function generateJpSummary(text) {
  const el = document.getElementById('jpSummaryText');
  if (!el) return;

  // Firestoreã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼ã® Gemini API Key ã‚’å–å¾—ã—ã¦ç¿»è¨³
  try {
    if (!window.__fb || !window.__fb.auth.currentUser) throw new Error('no auth');
    const uid = window.__fb.auth.currentUser.uid;
    const doc = await window.__fb.db.collection('api_keys').doc(uid).get();
    if (!doc.exists || !doc.data().gemini_api_key) throw new Error('no key');
    const apiKey = doc.data().gemini_api_key;

    const resp = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        contents: [{ parts: [{ text: `ä»¥ä¸‹ã®è‹±èªãƒ„ã‚¤ãƒ¼ãƒˆã‚’æ—¥æœ¬èªã§2-3æ–‡ã§ç°¡æ½”ã«è¦ç´„ã—ã¦ãã ã•ã„ã€‚å°‚é–€ç”¨èªã¯ãã®ã¾ã¾ä½¿ã£ã¦OKã€‚\n\n${text}` }] }],
        generationConfig: { maxOutputTokens: 200, temperature: 0.3 }
      })
    });

    if (!resp.ok) throw new Error('API error');
    const data = await resp.json();
    const summary = data.candidates?.[0]?.content?.parts?.[0]?.text || '';
    el.textContent = summary || 'ï¼ˆè¦ç´„ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸï¼‰';
  } catch (err) {
    // APIã‚­ãƒ¼ãŒç„¡ã„å ´åˆã‚„ã‚¨ãƒ©ãƒ¼æ™‚ â†’ ç°¡æ˜“ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
    el.textContent = 'ï¼ˆGemini APIã‚­ãƒ¼ã‚’è¨­å®šã‚¿ãƒ–ã§ç™»éŒ²ã™ã‚‹ã¨ã€ã“ã“ã«æ—¥æœ¬èªè¦ç´„ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ï¼‰';
    el.style.opacity = '0.5';
  }
}

// --- Posted history ---
function renderPosted() {
  const container = document.getElementById('postedList');
  const posted = dashboardData.recent_posted;

  if (!posted || posted.length === 0) {
    container.innerHTML = '<div class="empty-state"><svg class="empty-state-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M6 12L3.269 3.126A59.768 59.768 0 0121.485 12 59.77 59.77 0 013.27 20.876L5.999 12zm0 0h7.5"/></svg><h3>æŠ•ç¨¿å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</h3><p>å¼•ç”¨RTæŠ•ç¨¿ãŒå®Œäº†ã™ã‚‹ã¨ã€ã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™</p></div>';
    return;
  }

  container.innerHTML = posted.map(item => {
    const postedAt = item.posted_at ? formatTime(item.posted_at) : '-';
    const text = item.generated_text || item.text || '-';
    const tweetId = item.tweet_id || '';
    const postedTweetId = item.posted_tweet_id || '';
    const originalUrl = tweetId ? `https://x.com/i/status/${tweetId}` : '';
    const postedUrl = postedTweetId ? `https://x.com/i/status/${postedTweetId}` : '';

    return `<div class="posted-card">
      <div class="posted-header">
        <span class="status status-posted">æŠ•ç¨¿æ¸ˆã¿</span>
        <span class="posted-time">${postedAt}</span>
      </div>
      <div class="posted-body">${escapeHtml(text)}</div>
      <div class="posted-source">
        ${originalUrl ? `<a class="external-link" href="${originalUrl}" target="_blank" rel="noopener">å…ƒãƒ„ã‚¤ãƒ¼ãƒˆ â†—</a>` : ''}
        ${postedUrl ? `<a class="external-link" href="${postedUrl}" target="_blank" rel="noopener">æŠ•ç¨¿ãƒ„ã‚¤ãƒ¼ãƒˆ â†—</a>` : ''}
      </div>
    </div>`;
  }).join('');
}

// --- Metrics ---
function renderMetrics() {
  const metrics = dashboardData.metrics;

  // Metric summary cards
  const container = document.getElementById('metricCards');
  if (!metrics || metrics.length === 0) {
    container.innerHTML = '<div class="empty-state" style="grid-column:1/-1;"><svg class="empty-state-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M3 13.125C3 12.504 3.504 12 4.125 12h2.25c.621 0 1.125.504 1.125 1.125v6.75C7.5 20.496 6.996 21 6.375 21h-2.25A1.125 1.125 0 013 19.875v-6.75zM9.75 8.625c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125v11.25c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V8.625zM16.5 4.125c0-.621.504-1.125 1.125-1.125h2.25C20.496 3 21 3.504 21 4.125v15.75c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V4.125z"/></svg><h3>ãƒ¡ãƒˆãƒªã‚¯ã‚¹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</h3><p>metricsã‚³ãƒãƒ³ãƒ‰ã§åé›†ã§ãã¾ã™</p></div>';
    renderEmptyChart();
    return;
  }

  // Aggregate latest metrics
  const latest = metrics[0] || {};
  const summary = latest.summary || latest;

  const cards = [
    { label: 'ã„ã„ã­åˆè¨ˆ', value: summary.total_likes ?? summary.likes ?? '-', color: 'var(--accent-red)' },
    { label: 'RTåˆè¨ˆ', value: summary.total_retweets ?? summary.retweets ?? '-', color: 'var(--accent-green)' },
    { label: 'ã‚¤ãƒ³ãƒ—ãƒ¬ãƒƒã‚·ãƒ§ãƒ³', value: summary.total_impressions ?? summary.impressions ?? '-', color: 'var(--accent-blue)' },
    { label: 'å¹³å‡ã‚¨ãƒ³ã‚²ãƒ¼ã‚¸ãƒ¡ãƒ³ãƒˆç‡', value: summary.avg_engagement_rate != null ? (summary.avg_engagement_rate * 100).toFixed(2) + '%' : '-', color: 'var(--accent-purple)' },
  ];

  container.innerHTML = cards.map(c => `
    <div class="metric-item">
      <div class="metric-item-label">${c.label}</div>
      <div class="metric-item-value" style="color:${c.color}">${typeof c.value === 'number' ? formatNum(c.value) : c.value}</div>
    </div>
  `).join('');

  // Chart
  renderChart(metrics);
}

function renderChart(metrics) {
  const ctx = document.getElementById('metricsChart');
  if (!ctx) return;

  if (metricsChartInstance) {
    metricsChartInstance.destroy();
  }

  const labels = metrics.map(m => {
    const d = m.date || m.collected_at || '';
    return d.substring(5, 10); // MM-DD
  }).reverse();

  const postCounts = metrics.map(m => {
    const s = m.summary || m;
    return s.tweet_count ?? s.post_count ?? 0;
  }).reverse();

  const likeCounts = metrics.map(m => {
    const s = m.summary || m;
    return s.total_likes ?? s.likes ?? 0;
  }).reverse();

  metricsChartInstance = new Chart(ctx, {
    type: 'bar',
    data: {
      labels,
      datasets: [
        {
          label: 'æŠ•ç¨¿æ•°',
          data: postCounts,
          backgroundColor: 'rgba(29,161,242,0.6)',
          borderColor: 'rgba(29,161,242,1)',
          borderWidth: 1,
          borderRadius: 4,
          yAxisID: 'y',
        },
        {
          label: 'ã„ã„ã­æ•°',
          data: likeCounts,
          type: 'line',
          borderColor: 'rgba(239,68,68,0.8)',
          backgroundColor: 'rgba(239,68,68,0.1)',
          borderWidth: 2,
          pointRadius: 3,
          fill: true,
          tension: 0.3,
          yAxisID: 'y1',
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: { mode: 'index', intersect: false },
      plugins: {
        legend: {
          labels: { color: '#8888a0', font: { size: 11 } }
        }
      },
      scales: {
        x: {
          ticks: { color: '#5a5a70', font: { size: 11 } },
          grid: { color: 'rgba(42,42,58,0.5)' }
        },
        y: {
          position: 'left',
          ticks: { color: '#5a5a70', font: { size: 11 }, stepSize: 1 },
          grid: { color: 'rgba(42,42,58,0.5)' },
          title: { display: true, text: 'æŠ•ç¨¿æ•°', color: '#8888a0', font: { size: 11 } }
        },
        y1: {
          position: 'right',
          ticks: { color: '#5a5a70', font: { size: 11 } },
          grid: { drawOnChartArea: false },
          title: { display: true, text: 'ã„ã„ã­', color: '#8888a0', font: { size: 11 } }
        }
      }
    }
  });
}

function renderEmptyChart() {
  const ctx = document.getElementById('metricsChart');
  if (!ctx) return;
  if (metricsChartInstance) metricsChartInstance.destroy();

  metricsChartInstance = new Chart(ctx, {
    type: 'bar',
    data: { labels: ['---'], datasets: [{ label: 'æŠ•ç¨¿æ•°', data: [0], backgroundColor: 'rgba(29,161,242,0.3)' }] },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { display: false } },
      scales: {
        x: { ticks: { color: '#5a5a70' }, grid: { color: 'rgba(42,42,58,0.5)' } },
        y: { ticks: { color: '#5a5a70' }, grid: { color: 'rgba(42,42,58,0.5)' } }
      }
    }
  });
}

// --- Queue actions ---
function toggleSkipMenu(btn) {
  // Close all other dropdowns
  document.querySelectorAll('.skip-dropdown.show').forEach(d => d.classList.remove('show'));
  const dropdown = btn.nextElementSibling;
  dropdown.classList.toggle('show');
}

// Close skip menus when clicking outside
document.addEventListener('click', (e) => {
  if (!e.target.closest('.action-btn.skip') && !e.target.closest('.skip-dropdown')) {
    document.querySelectorAll('.skip-dropdown.show').forEach(d => d.classList.remove('show'));
  }
});

async function queueAction(action, tweetId, reason) {
  // Close any open dropdown
  document.querySelectorAll('.skip-dropdown.show').forEach(d => d.classList.remove('show'));

  if (!window.__fb || !window.__fb.auth.currentUser) return;

  const uid = window.__fb.auth.currentUser.uid;
  const db = window.__fb.db;

  try {
    // Save decision to Firestore (per-user subcollection)
    await db.collection('users').doc(uid).collection('queue_decisions').doc(tweetId).set({
      tweet_id: tweetId,
      action: action,
      skip_reason: reason || '',
      decided_by: uid,
      decided_at: firebase.firestore.FieldValue.serverTimestamp(),
    });

    // Update local data optimistically
    if (dashboardData && dashboardData.queue) {
      const item = dashboardData.queue.find(i => i.tweet_id === tweetId);
      if (item) {
        item.status = action === 'approve' ? 'approved' : 'skipped';
        if (reason) item.skip_reason = reason;
      }
    }

    renderQueue();
    renderKPI();

    const actionLabels = { approve: 'æ‰¿èªã—ã¾ã—ãŸ', skip: 'ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã—ãŸ' };
    if (window.showToast) showToast(actionLabels[action] || action, 'success');

    console.log(`Queue action: ${action} ${tweetId} ${reason || ''}`);
  } catch (err) {
    console.error('Queue action error:', err);
    if (window.showToast) showToast('æ“ä½œã«å¤±æ•—ã—ã¾ã—ãŸ: ' + err.message, 'error');
  }
}

// --- Preferences rendering ---
function renderPreferences() {
  const prefs = dashboardData.preferences;
  if (!prefs) return;

  // Weekly focus
  const directive = prefs.weekly_focus?.directive || '';
  const focusKeywords = (prefs.weekly_focus?.focus_keywords || []).join(', ');
  const focusAccounts = (prefs.weekly_focus?.focus_accounts || []).join(', ');
  setVal('prefFocusDirective', directive);
  setVal('prefFocusKeywords', focusKeywords);
  setVal('prefFocusAccounts', focusAccounts);

  // Topics
  const preferred = prefs.topic_preferences?.preferred || [];
  const avoid = prefs.topic_preferences?.avoid || [];
  setVal('prefPreferredTopics', preferred.join(', '));
  setVal('prefAvoidTopics', avoid.join(', '));
  renderTags('tagPreferred', preferred, 'preferred');
  renderTags('tagAvoid', avoid, 'avoid');

  // Accounts
  const boosted = prefs.account_overrides?.boosted || [];
  const blocked = prefs.account_overrides?.blocked || [];
  setVal('prefBoostedAccounts', boosted.join(', '));
  setVal('prefBlockedAccounts', blocked.join(', '));
  renderTags('tagBoosted', boosted.map(a => '@' + a), 'boosted');

  // Keyword weights
  const kwWeights = prefs.keyword_weights || {};
  const kwContainer = document.getElementById('keywordWeightDisplay');
  if (kwContainer && Object.keys(kwWeights).length > 0) {
    const tags = Object.entries(kwWeights)
      .sort((a, b) => b[1] - a[1])
      .map(([kw, w]) => `<span class="tag keyword">${escapeHtml(kw)} <span style="opacity:0.6">(${w})</span></span>`)
      .join('');
    kwContainer.innerHTML = tags;
  }

  // å¼•ç”¨RTãƒ—ãƒ­ãƒ³ãƒ—ãƒˆè¨­å®šã®å¾©å…ƒï¼ˆFirestoreã‹ã‚‰ï¼‰
  loadPromptSettings();
}

async function loadPromptSettings() {
  if (!window.__fb || !window.__fb.auth.currentUser) return;
  try {
    var uid = window.__fb.auth.currentUser.uid;
    var doc = await window.__fb.db.collection('selection_preferences').doc(uid).get();
    if (!doc.exists) return;
    var d = doc.data();
    if (d.prompt_persona_name) setVal('promptPersonaName', d.prompt_persona_name);
    if (d.prompt_first_person) setVal('promptFirstPerson', d.prompt_first_person);
    if (d.prompt_position) setVal('promptPosition', d.prompt_position);
    if (d.prompt_differentiator) setVal('promptDifferentiator', d.prompt_differentiator);
    if (d.prompt_tone) setVal('promptTone', d.prompt_tone);
    if (d.prompt_style_patterns) setVal('promptStylePatterns', d.prompt_style_patterns);
    if (d.prompt_ng_words) setVal('promptNgWords', d.prompt_ng_words);
    if (d.prompt_custom_directive) setVal('promptCustomDirective', d.prompt_custom_directive);
    if (d.prompt_enabled_templates) {
      var enabled = d.prompt_enabled_templates.split(',');
      var tmplMap = {
        'translate_comment': 'tmplTranslateComment',
        'summary_points': 'tmplSummaryPoints',
        'question_prompt': 'tmplQuestionPrompt',
        'practice_report': 'tmplPracticeReport',
        'breaking_news': 'tmplBreakingNews',
        'exclusive_report': 'tmplExclusiveReport',
        'dark_alert': 'tmplDarkAlert',
        'legend_moment': 'tmplLegendMoment'
      };
      Object.keys(tmplMap).forEach(function(tid) {
        var cb = document.getElementById(tmplMap[tid]);
        if (cb) cb.checked = enabled.indexOf(tid) !== -1;
      });
    }
  } catch (err) {
    console.warn('Prompt settings load failed:', err);
  }
}

function setVal(id, val) {
  const el = document.getElementById(id);
  if (el) el.value = val;
}

function renderTags(containerId, items, className) {
  const el = document.getElementById(containerId);
  if (!el || items.length === 0) return;
  el.innerHTML = items.map(t => `<span class="tag ${className}">${escapeHtml(t)}</span>`).join('');
}

// --- Save Preferences ---
(function initPrefSave() {
  const btn = document.getElementById('savePrefBtn');
  const msg = document.getElementById('prefSaveMsg');
  if (!btn) return;

  btn.addEventListener('click', async () => {
    if (!window.__fb || !window.__fb.auth.currentUser) return;
    btn.disabled = true;
    msg.className = 'save-msg';
    msg.style.display = 'none';

    const uid = window.__fb.auth.currentUser.uid;
    const db = window.__fb.db;

    try {
      // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆON/OFFï¼ˆ8ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼‰
      var enabledTemplates = [];
      if (document.getElementById('tmplTranslateComment')?.checked) enabledTemplates.push('translate_comment');
      if (document.getElementById('tmplSummaryPoints')?.checked) enabledTemplates.push('summary_points');
      if (document.getElementById('tmplQuestionPrompt')?.checked) enabledTemplates.push('question_prompt');
      if (document.getElementById('tmplPracticeReport')?.checked) enabledTemplates.push('practice_report');
      if (document.getElementById('tmplBreakingNews')?.checked) enabledTemplates.push('breaking_news');
      if (document.getElementById('tmplExclusiveReport')?.checked) enabledTemplates.push('exclusive_report');
      if (document.getElementById('tmplDarkAlert')?.checked) enabledTemplates.push('dark_alert');
      if (document.getElementById('tmplLegendMoment')?.checked) enabledTemplates.push('legend_moment');
      if (enabledTemplates.length === 0) enabledTemplates.push('translate_comment'); // æœ€ä½1ã¤

      const prefData = {
        weekly_focus: document.getElementById('prefFocusDirective')?.value || '',
        focus_keywords: document.getElementById('prefFocusKeywords')?.value || '',
        focus_accounts: document.getElementById('prefFocusAccounts')?.value || '',
        preferred_topics: document.getElementById('prefPreferredTopics')?.value || '',
        avoid_topics: document.getElementById('prefAvoidTopics')?.value || '',
        boosted_accounts: document.getElementById('prefBoostedAccounts')?.value || '',
        blocked_accounts: document.getElementById('prefBlockedAccounts')?.value || '',
        extra_keywords: document.getElementById('prefExtraKeywords')?.value || '',
        // å¼•ç”¨RTãƒ—ãƒ­ãƒ³ãƒ—ãƒˆè¨­å®š
        prompt_persona_name: document.getElementById('promptPersonaName')?.value || '',
        prompt_first_person: document.getElementById('promptFirstPerson')?.value || '',
        prompt_position: document.getElementById('promptPosition')?.value || '',
        prompt_differentiator: document.getElementById('promptDifferentiator')?.value || '',
        prompt_tone: document.getElementById('promptTone')?.value || '',
        prompt_style_patterns: document.getElementById('promptStylePatterns')?.value || '',
        prompt_ng_words: document.getElementById('promptNgWords')?.value || '',
        prompt_custom_directive: document.getElementById('promptCustomDirective')?.value || '',
        prompt_enabled_templates: enabledTemplates.join(','),
        updated_at: firebase.firestore.FieldValue.serverTimestamp(),
        updated_by: uid,
      };

      await db.collection('selection_preferences').doc(uid).set(prefData, { merge: true });

      msg.textContent = 'é¸å®šè¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ';
      msg.className = 'save-msg success';
    } catch (err) {
      console.error('Save preferences error:', err);
      msg.textContent = 'ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + err.message;
      msg.className = 'save-msg error';
    }

    btn.disabled = false;
  });
})();

// --- PDCA Analysis rendering ---
function renderPDCA() {
  const insights = dashboardData.pdca_insights;
  if (!insights || insights.total === 0) {
    document.getElementById('pdcaApprovalRate').textContent = 'â€”';
    return;
  }

  // Approval rate
  const rate = insights.approval_rate ?? 0;
  const ratePercent = (rate * 100).toFixed(1) + '%';
  const rateEl = document.getElementById('pdcaApprovalRate');
  rateEl.textContent = ratePercent;
  rateEl.className = 'approval-rate-big ' + (rate >= 0.7 ? 'good' : rate >= 0.4 ? 'ok' : 'bad');

  document.getElementById('pdcaTotalDecisions').textContent = insights.total ?? 0;
  document.getElementById('pdcaApprovedCount').textContent = insights.approved ?? 0;
  document.getElementById('pdcaSkippedCount').textContent = insights.skipped ?? 0;

  // Source-level stats
  const sourceList = document.getElementById('pdcaSourceList');
  const bySource = insights.by_source || {};
  const sourceEntries = Object.entries(bySource);
  if (sourceEntries.length > 0) {
    const sorted = sourceEntries
      .map(([username, s]) => {
        const total = (s.approved || 0) + (s.skipped || 0);
        const r = total > 0 ? (s.approved || 0) / total : 0;
        return { username, rate: r, total, approved: s.approved || 0 };
      })
      .sort((a, b) => b.total - a.total)
      .slice(0, 10);

    sourceList.innerHTML = '<ul class="pdca-list">' + sorted.map(s => {
      const rClass = s.rate >= 0.7 ? 'high' : s.rate <= 0.3 ? 'low' : '';
      return `<li>
        <span class="account">@${escapeHtml(s.username)}</span>
        <span>
          <span class="rate ${rClass}">${(s.rate * 100).toFixed(0)}%</span>
          <span style="font-size:11px;color:var(--text-muted);margin-left:6px;">(${s.total}ä»¶)</span>
        </span>
      </li>`;
    }).join('') + '</ul>';
  }

  // Skip reasons
  const reasonBars = document.getElementById('pdcaReasonBars');
  const byReason = insights.by_reason || {};
  const reasonEntries = Object.entries(byReason);
  if (reasonEntries.length > 0) {
    const maxCount = Math.max(...reasonEntries.map(([, c]) => c), 1);
    const reasonLabels = {
      topic_mismatch: 'ãƒˆãƒ”ãƒƒã‚¯ä¸ä¸€è‡´',
      source_untrusted: 'ã‚½ãƒ¼ã‚¹ä¸é©åˆ‡',
      too_old: 'å¤ã™ãã‚‹',
      low_quality: 'å“è³ªä¸è¶³',
      off_brand: 'ãƒ–ãƒ©ãƒ³ãƒ‰ä¸é©åˆ',
      other: 'ãã®ä»–',
    };

    reasonBars.innerHTML = reasonEntries
      .sort((a, b) => b[1] - a[1])
      .map(([reason, count]) => {
        const pct = (count / maxCount * 100).toFixed(0);
        const label = reasonLabels[reason] || reason;
        return `<div class="reason-bar">
          <span class="reason-bar-label">${label}</span>
          <div style="flex:1;background:var(--bg-input);border-radius:4px;overflow:hidden;">
            <div class="reason-bar-fill" style="width:${pct}%;"></div>
          </div>
          <span class="reason-bar-count">${count}</span>
        </div>`;
      }).join('');
  }

  // Adjustments (from pdca_insights.adjustments if available)
  const adjustEl = document.getElementById('pdcaAdjustments');
  const adjustments = insights.adjustments || [];
  if (adjustments.length > 0) {
    adjustEl.innerHTML = adjustments.map(a => {
      const cls = a.includes('å„ªå…ˆè¿½åŠ ') || a.includes('weight:') && a.includes('â†’') ? 'promote' : 'demote';
      return `<div class="adjustment-item ${cls}">${escapeHtml(a)}</div>`;
    }).join('');
  }
}

// --- Updated time ---
function renderUpdatedTime() {
  const el = document.getElementById('lastUpdated');
  const badge = document.getElementById('statusBadge');
  if (!dashboardData.updated_at) {
    el.textContent = '--';
    return;
  }

  const updated = new Date(dashboardData.updated_at);
  const now = new Date();
  const diffMin = Math.floor((now - updated) / 60000);

  el.textContent = formatTime(dashboardData.updated_at);

  if (diffMin > 120) {
    badge.className = 'badge badge-stale';
    badge.textContent = 'STALE';
  } else {
    badge.className = 'badge badge-live';
    badge.textContent = 'LIVE';
  }
}

// --- Helpers ---
function formatTime(isoStr) {
  try {
    const d = new Date(isoStr);
    return d.toLocaleString('ja-JP', {
      month: '2-digit', day: '2-digit',
      hour: '2-digit', minute: '2-digit'
    });
  } catch { return isoStr; }
}

function formatNum(n) {
  if (n == null || n === '-') return '-';
  const num = Number(n);
  if (isNaN(num)) return n;
  if (num >= 10000) return (num / 10000).toFixed(1) + 'ä¸‡';
  if (num >= 1000) return (num / 1000).toFixed(1) + 'k';
  return num.toLocaleString();
}

function truncate(str, len) {
  if (!str) return '';
  return str.length > len ? str.slice(0, len) + '...' : str;
}

function escapeHtml(str) {
  if (!str) return '';
  const d = document.createElement('div');
  d.textContent = str;
  return d.innerHTML;
}

// --- Operations Panel ---
async function requestOperation(command) {
  if (!window.__fb || !window.__fb.auth.currentUser) {
    alert('ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™');
    return;
  }

  const btnIdMap = {
    'collect': 'btnCollect',
    'curate': 'btnCurate',
    'curate-post': 'btnPost',
    'export-dashboard': 'btnDashboard'
  };
  const qbIdMap = {
    'collect': 'qbCollect',
    'curate': 'qbCurate',
    'curate-post': 'qbPost',
    'export-dashboard': 'qbDashboard'
  };

  const btn = document.getElementById(btnIdMap[command]);
  const qb = document.getElementById(qbIdMap[command]);

  if (btn) {
    btn.disabled = true;
    btn.textContent = 'é€ä¿¡ä¸­...';
  }
  if (qb) {
    qb.disabled = true;
    qb.style.opacity = '0.5';
  }

  try {
    const db = window.__fb.db;
    const user = window.__fb.auth.currentUser;
    await db.collection('users').doc(user.uid).collection('operation_requests').add({
      command: command,
      status: 'pending',
      requested_by: user.displayName || user.uid,
      requested_by_uid: user.uid,
      requested_at: firebase.firestore.FieldValue.serverTimestamp(),
    });

    const cmdLabels = { 'collect': 'åé›†', 'curate': 'ç”Ÿæˆ', 'curate-post': 'æŠ•ç¨¿', 'export-dashboard': 'æ›´æ–°' };
    const label = cmdLabels[command] || command;

    const msgEl = document.getElementById('opMsg');
    if (msgEl) {
      msgEl.innerHTML = '<span style="color:var(--accent-green);">âœ… ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã—ã¾ã—ãŸã€‚15åˆ†ä»¥å†…ã«è‡ªå‹•å®Ÿè¡Œã•ã‚Œã¾ã™ã€‚</span>';
    }

    if (window.showToast) showToast(label + 'ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã—ã¾ã—ãŸ', 'success');

    // Quick action msg
    const qMsg = document.getElementById('quickActionMsg');
    if (qMsg) {
      qMsg.innerHTML = '<span style="color:var(--accent-green);">âœ… ' + label + ' é€ä¿¡æ¸ˆ</span>';
      setTimeout(function() { qMsg.innerHTML = ''; }, 4000);
    }

    loadOpHistory();
  } catch (err) {
    console.error('Operation request error:', err);
    const msgEl = document.getElementById('opMsg');
    if (msgEl) {
      msgEl.innerHTML = '<span style="color:var(--accent-red);">âŒ ã‚¨ãƒ©ãƒ¼: ' + escapeHtml(err.message) + '</span>';
    }
    if (window.showToast) showToast('ãƒªã‚¯ã‚¨ã‚¹ãƒˆé€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
  } finally {
    if (btn) {
      btn.disabled = false;
      btn.textContent = {
        'collect': 'ä»Šã™ãåé›†',
        'curate': 'ä»Šã™ãç”Ÿæˆ',
        'curate-post': 'ä»Šã™ãæŠ•ç¨¿',
        'export-dashboard': 'ä»Šã™ãæ›´æ–°'
      }[command];
    }
    if (qb) {
      qb.disabled = false;
      qb.style.opacity = '1';
    }
  }
}

async function addManualTweet() {
  if (!window.__fb || !window.__fb.auth.currentUser) {
    alert('ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™');
    return;
  }

  const urlInput = document.getElementById('manualTweetUrl');
  const url = urlInput.value.trim();
  const msgEl = document.getElementById('addTweetMsg');

  if (!url || !url.includes('/status/')) {
    if (msgEl) msgEl.innerHTML = '<span style="color:var(--accent-red);">âŒ æ­£ã—ã„ãƒ„ã‚¤ãƒ¼ãƒˆURLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</span>';
    return;
  }

  const btn = document.getElementById('btnAddTweet');
  if (btn) { btn.disabled = true; btn.textContent = 'è¿½åŠ ä¸­...'; }

  try {
    const db = window.__fb.db;
    const user = window.__fb.auth.currentUser;
    await db.collection('users').doc(user.uid).collection('operation_requests').add({
      command: 'add-tweet',
      tweet_url: url,
      status: 'pending',
      requested_by: user.displayName || user.uid,
      requested_by_uid: user.uid,
      requested_at: firebase.firestore.FieldValue.serverTimestamp(),
    });

    if (msgEl) msgEl.innerHTML = '<span style="color:var(--accent-green);">âœ… ãƒ„ã‚¤ãƒ¼ãƒˆã‚’è¿½åŠ ãƒªã‚¯ã‚¨ã‚¹ãƒˆã—ã¾ã—ãŸ</span>';
    urlInput.value = '';
    loadOpHistory();
  } catch (err) {
    if (msgEl) msgEl.innerHTML = '<span style="color:var(--accent-red);">âŒ ã‚¨ãƒ©ãƒ¼: ' + escapeHtml(err.message) + '</span>';
  } finally {
    if (btn) { btn.disabled = false; btn.textContent = 'è¿½åŠ '; }
  }
}

async function loadOpHistory() {
  const container = document.getElementById('opHistory');
  if (!container || !window.__fb || !window.__fb.auth.currentUser) return;

  try {
    const db = window.__fb.db;
    const uid = window.__fb.auth.currentUser.uid;
    const snapshot = await db.collection('users').doc(uid).collection('operation_requests')
      .orderBy('requested_at', 'desc')
      .limit(10)
      .get();

    if (snapshot.empty) {
      container.textContent = 'æ“ä½œå±¥æ­´ã¯ã‚ã‚Šã¾ã›ã‚“';
      return;
    }

    const commandLabels = {
      'collect': 'ğŸ“¡ åé›†',
      'curate': 'âœï¸ ç”Ÿæˆ',
      'curate-post': 'ğŸ“¤ æŠ•ç¨¿',
      'export-dashboard': 'ğŸ“Š æ›´æ–°',
      'add-tweet': 'ğŸ”— URLè¿½åŠ '
    };

    const statusLabels = {
      'pending': '<span style="color:var(--accent-amber);">â³ å¾…æ©Ÿä¸­</span>',
      'running': '<span style="color:var(--accent-blue);">ğŸ”„ å®Ÿè¡Œä¸­</span>',
      'completed': '<span style="color:var(--accent-green);">âœ… å®Œäº†</span>',
      'failed': '<span style="color:var(--accent-red);">âŒ å¤±æ•—</span>',
      'cancelled': '<span style="color:var(--text-muted);">ğŸš« ã‚­ãƒ£ãƒ³ã‚»ãƒ«</span>'
    };

    let hasPending = false;
    let html = '<div style="display:flex;flex-direction:column;gap:8px;">';
    snapshot.forEach(doc => {
      const d = doc.data();
      const docId = doc.id;
      const time = d.requested_at ? new Date(d.requested_at.seconds * 1000).toLocaleString('ja-JP', {
        month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit'
      }) : '--';
      const label = commandLabels[d.command] || d.command;
      const status = statusLabels[d.status] || d.status;
      const extra = d.tweet_url ? ' â€” ' + escapeHtml(d.tweet_url) : '';
      const cancelBtn = d.status === 'pending'
        ? `<button onclick="cancelOperation('${docId}')" style="margin-left:auto;padding:3px 10px;font-size:11px;color:var(--accent-red);background:var(--accent-red-dim);border:1px solid rgba(239,68,68,0.3);border-radius:6px;cursor:pointer;font-family:var(--font-sans);white-space:nowrap;">âœ• ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>`
        : '';
      if (d.status === 'pending') hasPending = true;
      html += `<div style="display:flex;align-items:center;gap:12px;padding:8px 12px;background:var(--bg-card);border:1px solid var(--border);border-radius:8px;">
        <span style="font-family:var(--font-mono);font-size:11px;color:var(--text-muted);min-width:85px;">${time}</span>
        <span style="font-weight:500;min-width:80px;">${label}</span>
        ${status}
        <span style="font-size:11px;color:var(--text-muted);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;flex:1;">${extra}</span>
        ${cancelBtn}
      </div>`;
    });
    html += '</div>';
    if (hasPending) {
      html += `<button onclick="cancelAllPending()" style="margin-top:12px;padding:6px 16px;font-size:12px;color:var(--accent-red);background:var(--accent-red-dim);border:1px solid rgba(239,68,68,0.3);border-radius:8px;cursor:pointer;font-family:var(--font-sans);">ğŸ—‘ å¾…æ©Ÿä¸­ã‚’ã™ã¹ã¦ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>`;
    }
    container.innerHTML = html;
  } catch (err) {
    container.textContent = 'å±¥æ­´ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ';
    console.error(err);
  }
}

// Cancel a single pending operation
async function cancelOperation(docId) {
  if (!window.__fb || !window.__fb.auth.currentUser) return;
  const db = window.__fb.db;
  const uid = window.__fb.auth.currentUser.uid;
  try {
    await db.collection('users').doc(uid).collection('operation_requests').doc(docId).update({
      status: 'cancelled',
      cancelled_at: firebase.firestore.FieldValue.serverTimestamp(),
    });
    if (window.showToast) showToast('ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸ', 'success');
    loadOpHistory();
  } catch (err) {
    console.error('Cancel error:', err);
    if (window.showToast) showToast('ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
  }
}

// Cancel all pending operations
async function cancelAllPending() {
  if (!window.__fb || !window.__fb.auth.currentUser) return;
  if (!confirm('å¾…æ©Ÿä¸­ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ã™ã¹ã¦ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã™ã‹ï¼Ÿ')) return;
  const db = window.__fb.db;
  const uid = window.__fb.auth.currentUser.uid;
  try {
    const snapshot = await db.collection('users').doc(uid).collection('operation_requests')
      .where('status', '==', 'pending')
      .get();
    const batch = db.batch();
    snapshot.forEach(doc => {
      batch.update(doc.ref, {
        status: 'cancelled',
        cancelled_at: firebase.firestore.FieldValue.serverTimestamp(),
      });
    });
    await batch.commit();
    if (window.showToast) showToast(snapshot.size + 'ä»¶ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸ', 'success');
    loadOpHistory();
  } catch (err) {
    console.error('Cancel all error:', err);
    if (window.showToast) showToast('ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
  }
}

// Load op history when operations tab is shown
document.addEventListener('click', (e) => {
  if (e.target.dataset && e.target.dataset.tab === 'operations') {
    loadOpHistory();
  }
});

// ============================
// Toast Notification System
// ============================
(function() {
  // Create toast container
  const container = document.createElement('div');
  container.className = 'toast-container';
  container.id = 'toastContainer';
  document.body.appendChild(container);

  window.showToast = function(message, type) {
    type = type || 'success';
    const toast = document.createElement('div');
    toast.className = 'toast toast-' + type;
    const icons = { success: 'âœ…', error: 'âŒ', info: 'â„¹ï¸' };
    toast.innerHTML = '<span>' + (icons[type] || '') + '</span><span>' + message + '</span>';
    container.appendChild(toast);
    setTimeout(function() {
      if (toast.parentNode) toast.parentNode.removeChild(toast);
    }, 3200);
  };
})();

// ============================
// Quick Actions Bar visibility
// ============================
auth.onAuthStateChanged(function(u) {
  var bar = document.getElementById('quickActionsBar');
  if (bar) bar.style.display = u ? 'flex' : 'none';
});

// ============================
// Queue Delete Function
// ============================
async function queueDelete(tweetId) {
  if (!window.__fb || !window.__fb.auth.currentUser) return;
  if (!confirm('ã“ã®ã‚¢ã‚¤ãƒ†ãƒ ã‚’ã‚­ãƒ¥ãƒ¼ã‹ã‚‰å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;

  const uid = window.__fb.auth.currentUser.uid;
  const db = window.__fb.db;

  try {
    // Mark as deleted in Firestore
    await db.collection('users').doc(uid).collection('queue_decisions').doc(tweetId).set({
      tweet_id: tweetId,
      action: 'delete',
      decided_by: uid,
      decided_at: firebase.firestore.FieldValue.serverTimestamp(),
    });

    // Remove from local data
    if (dashboardData && dashboardData.queue) {
      dashboardData.queue = dashboardData.queue.filter(function(i) { return i.tweet_id !== tweetId; });
    }

    renderQueue();
    renderKPI();
    showToast('ã‚­ãƒ¥ãƒ¼ã‹ã‚‰å‰Šé™¤ã—ã¾ã—ãŸ', 'success');
  } catch (err) {
    console.error('Queue delete error:', err);
    showToast('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + err.message, 'error');
  }
}
</script>
</body>
</html>
